<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Ping Rewards ·Äû·Ää·Ä∫ Watch video , Complete social tasks , Earn points , Get rewards , Cash out platform ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äñ·Äº·ÄÖ·Ä∫·Äû·Ää·Ä∫·Åã">
    <meta name="keywords"
        content="Ping Rewards, Money Making, Earn Money, Watch Videos, Social Tasks, Points, Rewards, Cash Out, Online Earning, Video Rewards, Task Completion, Referral Program">
    <meta property="og:description"
        content="Ping Rewards ·Äû·Ää·Ä∫ video ·ÄÄ·Äº·Ää·Ä∑·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äî·Äæ·ÄÑ·Ä∑·Ä∫ social tasks ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Ä°·Ä¨·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄΩ·Äî·Ä∫·Äú·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äê·ÄΩ·ÄÑ·Ä∫·Äï·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÜ·Ä∂·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äõ·Äî·Ä∫·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ platform ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äñ·Äº·ÄÖ·Ä∫·Äû·Ää·Ä∫·Åã">
    <!-- NAMO TASSA BHAGAVATO ARAHATO SAMMA SAMBUDDHASSa -->
    <title>Ping Rewards</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%236366f1' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-4h2.5c1.38 0 2.5-1.12 2.5-2.5S12.88 7 11.5 7H9v-2h2.5C14.43 5 16 6.57 16 8.5S14.43 12 11.5 12H9v4h4v-2z'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',  /* Indigo */
                        'secondary': '#f9a8d4', /* Pink */
                        'background': '#0f172a', /* Slate 900 */
                        'card-bg': '#1e293b', /* Slate 800 */
                        'text-color': '#e2e8f0', /* Slate 200 */
                        'muted-text': '#94a3b8', /* Slate 400 */
                        'accent-green': '#10b981', /* Emerald */
                        'accent-orange': '#f59e0b', /* Amber */
                        'accent-purple': '#a855f7', /* Purple */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        },
                        coinFly: {
                            '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
                            '100%': { transform: 'translateY(-100px) scale(0.5)', opacity: '0' },
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                        coin: 'coinFly 1s ease-in-out forwards',
                    }
                }
            }
        }
        
    </script>
    <style>
        
        /* General Styles for the entire app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            margin: 0;
            overflow-x: hidden;
        }
        .sidebar.open {
            transform: translateX(0);
        }

        .backdrop.open {
            display: block;
        }

        .no-scroll {
            overflow: hidden;
        }

        .coin-icon {
            animation: coinFly 1s ease-in-out forwards;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        /* Animation */
         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .animate-scroll {
            animation: scroll 12s linear infinite; 
        }

        .animate-scroll:hover {
            animation-play-state: paused;
        }
        /* NEW: Circular Progress Bar Styles */
        .circular-progress-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #1e293b; /* card-bg */
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border: 2px solid #6366f1; /* primary */
        }
        .circular-progress {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: conic-gradient(#f59e0b 0deg, #1e293b 0deg); /* Amber color */
        }
        .progress-value {
            position: absolute;
            font-size: 1rem;
            font-weight: 700;
            color: #f59e0b; /* Amber */
        }
        /* Make app-content scrollable on small screens */
        #app-content {
            overflow-y: auto;
            height: 100vh;
        }
    </style>
</head>

<body class="bg-background text-text-color">

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-background bg-opacity-70 flex justify-center items-center z-[1002] transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-text-color border-t-primary"></div>
    </div>

    <!-- START: Login Page View (This is shown only when user needs to log in) -->
    <div id="login-page" class="view flex justify-center items-center min-h-screen p-4" style="display: none;">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8">
                <!-- New Logo SVG: Letter 'P' -->
                <svg class="w-20 h-20 mx-auto fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-4h2.5c1.38 0 2.5-1.12 2.5-2.5S12.88 7 11.5 7H9v-2h2.5C14.43 5 16 6.57 16 8.5S14.43 12 11.5 12H9v4h4v-2z" />
                </svg>
                <div class="text-2xl font-bold mt-2">Ping Rewards</div>
                <div class="text-muted-text mt-1">Get rewarded for watching videos.</div>
            </div>
            <div class="bg-card-bg p-8 rounded-xl shadow-lg border border-slate-700">
                <h2 class="text-xl font-semibold mb-6">Welcome to Ping Rewards</h2>
                <p id="login-message" class="text-red-500 text-sm mb-4" style="display: none;"></p>
                <button id="google-sign-in-btn"
                    class="w-full py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300 flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="#ffffff"
                            d="M22.4 12.2c0-.7-.1-1.3-.2-1.9H12v3.8h5.3c-.2 1.2-.8 2.2-1.6 3l3.2 2.5c2.1-1.9 3.4-4.7 3.4-8.4z" />
                        <path fill="#ffffff"
                            d="M12 22c3.2 0 5.9-1.1 7.8-3l-3.2-2.5c-1 1.2-2.3 1.9-4.6 1.9-3.5 0-6.5-2.4-7.6-5.6l-3.3 2.5c1.4 2.8 4.4 4.8 7.9 4.8z" />
                        <path fill="#ffffff"
                            d="M4.4 12.2c0-1.6.4-3.1 1.2-4.4L2.3 5.4C.9 7.7 0 10 0 12.2c0 2.2.9 4.5 2.3 6.8l3.3-2.4c-.8-1.3-1.2-2.8-1-1.4z" />
                        <path fill="#ffffff"
                            d="M12 4.1c1.8 0 3.3.6 4.6 1.8L19.4 3C17.5 1.1 14.8 0 12 0c-3.5 0-6.5 2-7.9 4.8l3.3 2.4C8.7 5.7 10.2 5 12 5z" />
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
    <!-- END: Login Page View -->

    <!-- Main Application Container (Visible initially for guest mode) -->
    <div id="app-container" class="view flex flex-col md:flex-row w-full min-h-screen" style="display: flex;">
        <!-- Sidebar -->
        <div id="sidebar"
            class="sidebar fixed md:relative z-[100] md:z-0 top-0 left-0 w-64 h-full bg-card-bg shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0">
            <div class="p-6 pb-4 border-b border-slate-700 flex items-center">
                <!-- New Logo SVG: Letter 'P' -->
                <svg class="w-10 h-10 fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-4h2.5c1.38 0 2.5-1.12 2.5-2.5S12.88 7 11.5 7H9v-2h2.5C14.43 5 16 6.57 16 8.5S14.43 12 11.5 12H9v4h4v-2z" />
                </svg>
                <span class="text-xl font-bold ml-2">Ping Rewards</span>
            </div>
            <ul class="flex flex-col p-4 space-y-2">
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="user-dashboard-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M3 13h11v-2H3v2zm0 4h11v-2H3v2zm0-8h11V7H3v2zm13 .01V7h5v2.01h-5zM16 17h5v-2h-5v2zm0-4h5v-2h-5v2z" />
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="watch-videos-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                        </svg>
                        Watch Videos
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="social-tasks-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-11 4c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2zm-2 5c-.55 0-1-.45-1-1v-1h2v1c0 .55-.45 1-1 1zm4 0c-.55 0-1-.45-1-1v-1h2v1c0 .55-.45 1-1 1zm4 0c-.55 0-1-.45-1-1v-1h2v1c0 .55-.45 1-1 1zm-8-3c0 .55-.45 1-1 1s-1-.45-1-1v-1h2v1zM20 8v2h-2V8h2zM12 8h4v2h-4V8zm4 7c0 .55-.45 1-1 1s-1-.45-1-1v-1h2v1z" />
                        </svg>
                        Social Tasks
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="points-history-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                        </svg>
                        Points History
                    </a>
                </li>
                <!-- START NEW: Invite & Earn Link -->
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="invite-and-earn-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M16 12.01c-.01-2.22-1.8-4.01-4-4.01H7c-2.21 0-4 1.79-4 4.01v4.99c0 2.22 1.8 4.01 4 4.01h5c2.21 0 4-1.79 4-4.01v-1.99c0-.55-.45-1-1-1s-1 .45-1 1v1.99c0 1.11-.89 2.01-2 2.01H7c-1.11 0-2-.89-2-2.01v-4.99c0-1.11.89-2.01 2-2.01h5c.55 0 1-.45 1-1s-.45-1-1-1H7c-3.31 0-6 2.69-6 6v4.99c0 3.31 2.69 6 6 6h5c3.31 0 6-2.69 6-6v-1.99c0-.55-.45-1-1-1s-1 .45-1 1v1.99c0 1.11-.89 2.01-2 2.01zM19 8h-4c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 4h-4v-2h4v2z"/>
                        </svg>
                        Invite & Earn
                    </a>
                </li>
                <!-- END NEW: Invite & Earn Link -->
                <li>
                    <a href="#"
                        class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="about-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-2h2v2zm0-4h-2V7h2v5z" />
                        </svg>
                        About
                    </a>
                </li>
                <li
                    style="padding:1rem 0;font-size:1.15rem;cursor:pointer;border-bottom:1px solid #ffe0e9;color:#ff69b4;transition:background 0.2s, color 0.2s;">
                </li>
                <li>
                    <a href="https://t.me/Mr_PingGP" target="_blank"
                        style="display:flex;align-items:center;text-decoration:none;color:#ff69b4;">
                        <span style="display:inline-block;width:24px;height:24px;margin-right:20px;">
                            <svg style="width:100%;height:100%;fill:currentColor;" xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-2h2v2zm0-4h-2V7h2v5z" />
                            </svg>
                        </span>
                        Help
                    </a>
                </li>

                <!-- FIX 1: Hide Admin links by default using inline style to prevent flicker -->
                <hr class="my-4 border-slate-700 admin-link" style="display: none;">

                <li class="admin-link" style="display: none;">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="admin-dashboard-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M3 13h11v-2H3v2zm0 4h11v-2H3v2zm0-8h11V7H3v2zm13 .01V7h5v2.01h-5zM16 17h5v-2h-5v2zm0-4h5v-2h-5v2z" />
                        </svg>
                        Admin Dashboard
                    </a>
                </li>
                <li class="admin-link" style="display: none;">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="manage-videos-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                        </svg>
                        Manage Videos
                    </a>
                </li>
                <li class="admin-link" style="display: none;">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="manage-social-tasks-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 10V8h4v4h3l-5 5-5-5h3z" />
                        </svg>
                        Manage Social Tasks
                    </a>
                </li>
                <li class="admin-link" style="display: none;">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200"
                        data-target="manage-users-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                        Manage Users
                    </a>
                </li>
            </ul>
            <div id="sidebar-profile" class="p-6 border-t border-slate-700 mt-auto">
                <!-- Profile info  -->
            </div>
        </div>

        <div id="backdrop" class="backdrop fixed inset-0 bg-black bg-opacity-50 z-[99] hidden md:hidden"></div>

        <!-- Main Content Area -->
        <div id="app-content" class="flex-grow p-4 md:p-6 transition-all duration-300 ease-in-out">
            <header class="flex justify-between items-center mb-6">
                <h1 id="page-title" class="text-2xl md:text-3xl font-bold flex items-center">
                    <button id="menu-toggle"
                        class="md:hidden p-2 -ml-2 rounded-md hover:bg-card-bg transition-colors duration-200">
                        <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                        </svg>
                    </button>
                    Dashboard
                </h1>
                <div id="header-meta" class="hidden md:flex items-center space-x-4">
                    <!-- Header meta info -->
                </div>
            </header>

            <!-- User Dashboard View -->
            <div id="user-dashboard-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div
                        class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 col-span-1 lg:col-span-3 flex flex-col md:flex-row justify-between items-center">
                         <!-- Container -->
                                    <div class="w-full max-w-7xl overflow-hidden bg-yellow-400 border-y-0 border-yellow-600 py-0 shadow-2xl rounded-4">
                                        <div class="flex animate-scroll min-w-max">
                                            <span class="text-sm sm:text-sm font-extrabold text-gray-900 uppercase tracking-wide whitespace-nowrap px-0">
                                                üéâ ·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Äû·Ää·Ä∫ About ·ÄÄ·Ä≠·ÄØ ·Äî·Ä≠·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·Äô·Ä∫·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·Äñ·Äê·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´ üéâ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            </span>
                                            <span class="text-sm sm:text-sm font-extrabold text-gray-900 uppercase tracking-wide whitespace-nowrap px-0">
                                                üéâ Important: Please click 'About' and read the rules first. üéâ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            </span>
                                            
                                        </div>
                                    </div>
                            <!-- Container -->
                        <div>
                            
                                   
                            <h2 id="welcome-message" class="text-xl font-semibold mb-2"></h2>
                            <p class="text-muted-text">Ready to earn more points? Let's start watching some videos.</p>
                        </div>
                        <a href="#"
                            class="nav-link user-link mt-4 md:mt-0 px-6 py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300 whitespace-nowrap"
                            data-target="watch-videos-view">
                            Watch Now
                        </a>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Total Points</h2>
                        <div class="text-4xl font-bold text-primary" id="total-points-value">0</div>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Estimated Earnings</h2>
                        <div class="text-4xl font-bold text-accent-green" id="estimated-earnings-value">$0.00</div>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Videos Watched</h2>
                        <div class="text-4xl font-bold text-accent-purple" id="videos-watched-value">0</div>
                    </div>
                </div>
                <!-- Leaderboard Section -->
                <div class="mt-6">
                    <h2 class="text-xl font-semibold mb-4">üèÜ Top Earners</h2>
                    <div id="leaderboard-container" class="space-y-3">
                        <!-- Leaderboard items will be dynamically rendered here by JS -->
                        <div class="text-center text-muted-text p-4">Loading leaderboard...</div>
                    </div>
                </div>

                <div class="quick-actions mb-6">
                    <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
                    <div class="flex flex-wrap gap-4">
                        <a href="#"
                            class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200"
                            data-target="watch-videos-view">
                            Watch Videos
                        </a>
                        <a href="#"
                            class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200"
                            data-target="points-history-view">
                            View History
                        </a>
                        <a href="#"
                            class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200"
                            data-target="social-tasks-view">
                            Complete Tasks
                        </a>
                    </div>
                </div>

                <div
                    class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">Cash Out Points</h2>
                        <p class="text-muted-text">5000 Points = $1.00</p>
                        <p class="text-muted-text">Keep watching to increase your earnings.</p>
                    </div>
                    <button
                        class="cashout-btn mt-4 md:mt-0 px-6 py-3 bg-primary text-white font-semibold rounded-lg transition-colors duration-300 whitespace-nowrap"
                        id="cashout-button">
                        Cash Out
                    </button>
                </div>
            </div>

            <!-- Watch Videos View -->
            <div id="watch-videos-view" class="content-view" style="display: none;">

                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <input type="text" id="search-bar"
                        class="flex-grow px-4 py-2 rounded-full bg-card-bg border border-slate-700 focus:outline-none focus:ring-2 focus:ring-primary placeholder-muted-text"
                        placeholder="Search videos...">
                    <div class="flex flex-wrap justify-center sm:justify-end gap-2">
                        <button
                            class="filter-btn active px-4 py-2 rounded-full border border-primary bg-primary text-white text-sm hover:bg-primary/80 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="all">All</button>
                        <button
                            class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="Nature">Nature</button>
                        <button
                            class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="Education">Education</button>
                        <button
                            class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="Travel">Travel</button>
                        <button
                            class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="Food">Food</button>
                        <button
                            class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-all duration-300 hover:scale-105 active:scale-95"
                            data-category="Gaming">Gaming</button>
                    </div>
                </div>
                <!-- Ad Placement at the Top of Video Grid -->
                <div>
                    <script>
                        const delayInMilliseconds = 1000;
                
                        function loadAdScript() {
                            const script = document.createElement('script');
                            script.type = 'text/javascript'; 
                            script.src = '//institutionnounreverend.com/25/d1/54/25d154cfe2cdfcc85914d10a0b4a6eae.js';
                            const targetDiv = document.querySelector('.flex.justify-center.mb-4');
                            if (targetDiv) {
                                targetDiv.appendChild(script);
                            } else {
                                document.body.appendChild(script);
                            }
                        }
                        setTimeout(loadAdScript, delayInMilliseconds);
                    </script>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8"
                    id="video-grid">
                    <!-- Video cards  -->
                </div>
                
            </div>

            <!-- Video Player View (Updated) -->
            <div id="video-player-view" class="content-view" style="display: none;">
                <button id="video-player-back-btn"
                    class="mb-4 flex items-center gap-2 px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                    <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                    Back to Videos
                </button>
                
                <!-- Ad Placement under the 'Back to Videos' button -->
                <div class="my-4">
                      <script type="text/javascript">
                    	atOptions = {
                    		'key' : 'c6affa5f0ae4df4d56203646aa9bf458',
                    		'format' : 'iframe',
                    		'height' : 50,
                    		'width' : 320,
                    		'params' : {}
                    	};
                    </script>
                    <script type="text/javascript" src="//institutionnounreverend.com/c6affa5f0ae4df4d56203646aa9bf458/invoke.js"></script>
                </div>
                
                <!-- NEW: Floating Circular Points Tracker UI -->
                <div id="circular-points-tracker" class="circular-progress-container hidden">
                    <div id="progress-circle" class="circular-progress">
                        <span id="progress-time-remaining" class="progress-value">60s</span>
                    </div>
                </div>
                <!-- END NEW: Floating Circular Points Tracker UI -->

                <div class="bg-card-bg p-0 rounded-xl shadow-md border border-slate-700">
                    <div class="aspect-video w-full rounded-xl overflow-hidden mb-4">
                        <!-- 'allow="autoplay"' attribute is added here, and autoplay will be added to URL in JS -->
                        <iframe id="video-iframe" src="" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen class="w-full h-full"></iframe>
                    </div>
                    
                    <h2 class="text-2xl font-semibold mb-1" id="video-player-title"></h2>
                    <p class="text-muted-text mb-4" id="video-player-description"></p>
                    
                    <div class="flex justify-between items-center p-4">
                        <button id="get-summary-btn"
                            class="action-btn px-4 py-2 bg-secondary hover:bg-pink-500 text-white font-semibold rounded-lg transition-colors duration-200 text-sm">
                            Get Summary ‚ú®
                        </button>
                        <div id="summary-output" class="text-sm text-muted-text"></div>
                    </div>

                    <!-- Ad 2 Placement (Below Get Summary Button) -->
                    <div class="mt-4">
                        <script async="async" data-cfasync="false" src="//institutionnounreverend.com/5fae19ca63dcfa0b73c6e2395f27545a/invoke.js"></script>
                        <div id="container-5fae19ca63dcfa0b73c6e2395f27545a"></div>
                    </div>
                </div>
            </div>

            <!-- Social Tasks View -->
            <div id="social-tasks-view" class="content-view" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">Complete Social Tasks</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="social-tasks-grid">
                    <!-- Social task cards  -->
                    <div class="col-span-full text-center text-muted-text p-6">Loading tasks...</div>
                </div>
            </div>

            <!-- Points History View -->
            <div id="points-history-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Points History</h2>
                    <p class="text-muted-text mb-6">A record of all the points you have earned.</p>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Date</th>
                                    <th class="p-4">Description</th>
                                    <th class="p-4 rounded-tr-lg">Points</th>
                                </tr>
                            </thead>
                            <tbody id="points-history-table" class="divide-y divide-slate-700">
                                <!-- Table rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invite & Earn View  -->
            
 <div id="invite-and-earn-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-primary">·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Äô·Äæ·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏·Äõ·Äö·Ä∞·Äï·Ä´ (Invite & Earn)</h2>
                    <p class="text-muted-text mb-6">·Äû·ÄÑ·Ä∫·Åè ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·ÄÄ·ÄØ·Äí·Ä∫ (Referral Code) ·ÄÄ·Ä≠·ÄØ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Åç ·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äï·Ä´·Åã ·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äê·ÄÖ·Ä∫·Ä¶·Ä∏ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Ä°·Äô·Äæ·Äê·Ä∫ **50** ·Äõ·Äõ·Äæ·Ä≠·Äô·Ää·Ä∫·Åã</p>
                    <!-- UPDATED  50 -->

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">·Äû·ÄÑ·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·ÄÄ·ÄØ·Äí·Ä∫ (Your Referral Code)</label>
                            <div class="flex">
                                <input type="text" id="referral-code-input" value="Loading..." readonly
                                    class="flex-grow px-4 py-3 rounded-l-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary text-text-color font-mono tracking-wider">
                                <button id="copy-referral-btn"
                                    class="px-4 py-3 bg-accent-green hover:bg-emerald-600 rounded-r-lg text-white font-semibold transition-colors duration-200 flex items-center gap-2">
                                    <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                    Copy
                                </button>
                            </div>
                            <p id="copy-status" class="text-sm mt-2 text-primary" style="display:none;">·ÄÄ·ÄØ·Äí·Ä∫·ÄÄ·Ä∞·Ä∏·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">·Äû·ÄÑ·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äú·ÄÑ·Ä∑·Ä∫ (Your Referral Link)</label>
                            <div class="flex">
                                <input type="text" id="referral-link-input" value="Loading..." readonly
                                    class="flex-grow px-4 py-3 rounded-l-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary text-text-color text-sm">
                                <button id="copy-link-btn"
                                    class="px-4 py-3 bg-accent-green hover:bg-emerald-600 rounded-r-lg text-white font-semibold transition-colors duration-200 flex items-center gap-2">
                                    <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                    Copy
                                </button>
                            </div>
                        </div>

                        <div class="pt-4">
                            <h3 class="text-lg font-semibold mb-2">·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ (Invite History)</h3>
                            <div class="bg-slate-700/50 p-4 rounded-lg overflow-x-auto">
                                <table class="w-full text-left table-auto">
                                    <thead class="text-slate-400 uppercase text-xs">
                                        <tr>
                                            <th class="p-2">·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞</th>
                                            <th class="p-2">·Äõ·Äõ·Äæ·Ä≠·ÄÅ·Ä≤·Ä∑·Äû·Ää·Ä∑·Ä∫ ·Ä°·Äô·Äæ·Äê·Ä∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invited-users-table">
                                        <tr><td colspan="2" class="p-2 text-center text-muted-text">·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Invite & Earn View-->

            <!-- About View  -->
            <div id="about-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Ping Rewards ·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏</h2>
                    <p class="text-muted-text mb-6">Ping Rewards ·ÄÄ·Ä≠·ÄØ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äï·ÄØ·Ä∂·Åä ·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·Äô·Ä∫·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÅ·Äº·Ä¨·Ä∏
                        ·Äû·Ä≠·Äû·ÄÑ·Ä∑·Ä∫·Äû·Ää·Ä∑·Ä∫ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏·Åã</p>
                    <div class="prose max-w-none text-text-color space-y-4">
                        <h3 class="text-lg font-bold text-white">·ÅÅ·Åã Web App ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äî·Ää·Ä∫·Ä∏</h3>
                        <p>Ping Rewards ·Äû·Ää·Ä∫ ·Äó·ÄÆ·Äí·ÄÆ·Äö·Ä≠·ÄØ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Åä Social Media Tasks ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫
                            ·Ä°·Äô·Äæ·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏ ·ÄÖ·ÄØ·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äû·Ä±·Ä¨ Web App ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äñ·Äº·ÄÖ·Ä∫·Äû·Ää·Ä∫·Åã</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>**Login:** Google Account ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Ä°·Äú·ÄΩ·Äö·Ä∫·Äê·ÄÄ·Ä∞ ·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã</li>
                            <li>**Watch Videos:** "Watch Videos" tab ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äó·ÄÆ·Äí·ÄÆ·Äö·Ä≠·ÄØ·Äô·Äª·Ä¨·Ä∏ ·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫
                                ·Ä°·Äô·Äæ·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äõ·Äö·Ä∞·Äï·Ä´·Åã</li>
                            <li>**Social Tasks:** "Social Tasks" tab ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äñ·Ä±·Ä¨·Ä∫·Äï·Äº·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ Social Media Task ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ
                                ·Äê·ÄÖ·Ä∫·ÄÄ·Äº·Ä≠·Äô·Ä∫·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Ä°·Äô·Äæ·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äõ·Äö·Ä∞·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã</li>
                            <li>**Cash Out:** ·Ä°·Äô·Äæ·Äê·Ä∫·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ 5000 ·Äï·Äº·Ää·Ä∑·Ä∫·Äï·Ä´·ÄÄ</li>
                            <li>**WavePay, KBZ Pay , Binance ·Äô·Äª·Ä¨·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫ Cash Out ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã</li>
                        </ul>
                        <h3 class="text-lg font-bold text-white">·ÅÇ·Åã ·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·Äô·Ä∫·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏</h3>
                       <ul class="list-disc list-inside space-y-1">
                            <li>·Äê·ÄÖ·Ä∫·Ä¶·Ä∏·Äú·Äª·Äæ·ÄÑ·Ä∫ Account ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äû·Ä¨ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äõ·Äô·Ää·Ä∫·Åã Account ·Ä°·Äê·ÄØ·Äô·Äª·Ä¨·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Ä°·Äú·ÄΩ·Ä≤·Äû·ÄØ·Ä∂·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·ÄÄ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·Äê·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫·Åã</li>
                            <li>Payment method ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÄ·Ä≠·ÄØ Account ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äê·Ää·Ä∫·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫·Äû·Ä¨ ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·Äï·Ä´·Äû·Ää·Ä∫·Åã</li>
                            <li>Fake View, Bot ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äô·Äï·Äº·ÄØ·Äï·Ä´·Åã ·Äê·ÄΩ·Ä±·Ä∑·Äõ·Äæ·Ä≠·Äï·Ä´·ÄÄ ·Ä°·Äõ·Ä±·Ä∏·Äö·Ä∞·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫·Åã</li>
                            <li>Cash Out ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫ ·Äû·ÄÑ·Ä∫·Åè Payment Information ·ÄÄ·Ä≠·ÄØ ·Äô·Äæ·Äî·Ä∫·ÄÄ·Äî·Ä∫·ÄÖ·ÄΩ·Ä¨ ·Äñ·Äº·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äõ·Äô·Ää·Ä∫·Åã</li>
                            <li>·Äô·ÄÆ·Äí·ÄÆ·Äö·Ä¨ Task ·Äô·Äª·Ä¨·Ä∏·Äê·ÄΩ·ÄÑ·Ä∫ Comment ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äû·Ää·Ä∑·Ä∫·Ä°·ÄÅ·Ä´ ·Äû·ÄÑ·Ä∫·Åè Users name ·Ä°·ÄÖ ·ÄÖ·Ä¨·Äú·ÄØ·Ä∂·Ä∏·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÖ·Äê·ÄÑ·Ä∫·ÄÄ·Ä¨ ·Äõ·Ä±·Ä∏·Äû·Ä¨·Ä∏·Äõ·Äô·Ää·Ä∫·Åã</li>
                            <li>Subscribe ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ Follow Tasks ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äê·ÄÄ·Äö·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äô·Ää·Ä∫·Åã ·Äô·Äü·ÄØ·Äê·Ä∫·Äï·Ä´·ÄÄ ·Ä°·Äõ·Ä±·Ä∏·Äö·Ä∞·ÄÅ·Ä∂·Äõ·Äô·Ää·Ä∫·Åã</li>
                            <li>·ÄÖ·Ää·Ä∫·Ä∏·ÄÄ·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äô·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äî·Ä¨·Äï·Ä´·ÄÄ·Åä ·Ä°·Äô·Äæ·Äê·Ä∫·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·Äê·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·Äô·Ää·Ä∫·Åã</li>
                       </ul>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" id="admin-dashboard-grid">
                    <div
                        class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path
                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Users</h3>
                            <div class="text-3xl font-bold" id="admin-total-users-value">0</div>
                        </div>
                    </div>
                    <div
                        class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-purple/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-purple" xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24">
                                <path
                                    d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Videos</h3>
                            <div class="text-3xl font-bold" id="admin-total-videos-value">0</div>
                        </div>
                    </div>
                    <div
                        class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-green/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-green" xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24">
                                <path
                                    d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Points Earned</h3>
                            <div class="text-3xl font-bold" id="admin-total-points-earned-value">0</div>
                        </div>
                    </div>
                    <div class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center cursor-pointer"
                        id="admin-payouts-card">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-orange/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-orange" xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24">
                                <path
                                    d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z" />
                            </svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Payouts</h3>
                            <div class="text-3xl font-bold" id="admin-total-payouts-value">$0</div>
                        </div>
                    </div>
                </div>

                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Weekly Watch History (Hours)</h2>
                    <div class="relative h-64 flex items-end pb-8 border-l-2 border-b-2 border-slate-600">
                        <span class="absolute left-0 top-0 text-sm text-muted-text -ml-6 -mt-2">8</span>
                        <span class="absolute left-0 bottom-0 text-sm text-muted-text -ml-6 -mb-4">0</span>
                        <div class="bar-chart flex items-end h-full w-full" id="weekly-watch-chart">
                            <!-- Bars -->
                            <div class="w-1/7 h-1/2 mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 50%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Mon</span>
                            </div>
                            <div class="w-1/7 h-[38%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 38%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Tue</span>
                            </div>
                            <div class="w-1/7 h-[60%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 60%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Wed</span>
                            </div>
                            <div class="w-1/7 h-[54%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 54%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Thu</span>
                            </div>
                            <div class="w-1/7 h-[70%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 70%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Fri</span>
                            </div>
                            <div class="w-1/7 h-[98%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 98%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Sat</span>
                            </div>
                            <div class="w-1/7 h-[85%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group"
                                style="height: 85%;">
                                <span
                                    class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Sun</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Videos View -->
            <div id="manage-videos-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Manage Videos</h2>
                        <button id="add-video-btn"
                            class="px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                            Add New Video
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Title</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table" class="divide-y divide-slate-700">
                                <!-- Table rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Social Tasks View -->
            <div id="manage-social-tasks-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Manage Social Tasks</h2>
                        <button id="add-social-task-btn"
                            class="px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                            Add New Task
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Task Title</th>
                                    <th class="p-4">Platform</th>
                                    <th class="p-4">Link</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="social-tasks-table" class="divide-y divide-slate-700">
                                <!-- Table rows  -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Users View -->
            <div id="manage-users-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-2">Manage Users</h2>
                    <p class="text-muted-text mb-6">View user data, manage status, and edit information.</p>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">User ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Email</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-slate-700">
                                <!-- User rows  -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Floating Scroll-to-Top Rocket Button (Hidden by default) -->
            <button id="scroll-to-top-btn"
                class="hidden fixed bottom-6 right-6 z-50 p-4 bg-accent-orange hover:bg-amber-600 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-110 active:scale-95">
                <!-- Rocket/Up Arrow SVG -->
                <svg class="w-6 h-6 text-white transform rotate-315" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l-5 5h3v7h4V7h3l-5-5zM4 20h16v2H4z"/>
                </svg>
            </button>
            <!-- END NEW: Floating Scroll-to-Top Rocket Button -->
        </div>

        <!-- Modal for Cash Out Confirmation Message -->
        <div id="cashout-message-modal"
            class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 class="text-xl font-semibold mb-4">Cash Out Request</h3>
                <p id="cashout-message-text" class="text-muted-text mb-6">You need 5000 points to cash out.</p>
                <div class="flex justify-end gap-2">
                    <button type="button"
                        class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200"
                        id="cashout-message-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Modal for Delete Confirmation -->
        <div id="delete-confirm-modal"
            class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="delete-modal-title" class="text-xl font-semibold mb-4">Are you sure you want to delete this?
                </h3>
                <p class="text-muted-text mb-6">This action cannot be undone.</p>
                <div class="flex justify-end gap-2">
                    <button type="button"
                        class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                    <button type="button"
                        class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white font-semibold transition-colors duration-200"
                        id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>

        <!-- Modal for Viewing User History / Payout History -->
        <div id="history-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-3xl shadow-2xl border border-slate-700">
                <h3 id="history-modal-title" class="text-xl font-semibold mb-4"></h3>
                <div id="history-modal-content" class="overflow-y-auto max-h-[70vh] rounded-lg">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                            <tr id="history-table-header">
                                <!-- Table headers  -->
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-700">
                            <!-- History rows  -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button"
                        class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200"
                        id="history-modal-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Modal for Adding/Editing Videos  -->
        <div id="add-video-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="modal-title" class="text-xl font-semibold mb-4">Add New Video</h3>
                <form id="add-video-form" class="modal-form space-y-4">
                    <div>
                        <label for="video-title" class="block text-sm font-medium mb-1">Video Title</label>
                        <input type="text" id="video-title" name="videoTitle" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="video-description" class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="video-description" name="videoDescription" rows="3" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    <div>
                        <label for="video-category" class="block text-sm font-medium mb-1">Category</label>
                        <select id="video-category" name="videoCategory" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="YouTube">YouTube</option>
                            <option value="TikTok">TikTok</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Nature">Nature</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Food">Food</option>
                            <option value="Gaming">Gaming</option>
                        </select>
                    </div>
                    <div>
                        <label for="video-url" class="block text-sm font-medium mb-1">Video URL (YouTube Embed
                            Link)</label>
                        <input type="text" id="video-url" name="videoUrl" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="video-points" class="block text-sm font-medium mb-1">Points (Legacy Field - Not used for earning rate)</label>
                        <input type="number" id="video-points" name="videoPoints"
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary"
                            placeholder="Optional. Earning is 1pt/60s.">
                    </div>
                    <div>
                        <label for="watch-duration" class="block text-sm font-medium mb-1">Watch Duration (Seconds - MAX Earning Time)</label>
                        <input type="number" id="watch-duration" name="watchDuration" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary"
                            placeholder="Required. Sets the maximum time (in seconds) to earn points.">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button"
                            class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                        <button type="submit"
                            class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for Adding/Editing Social Tasks -->
        <div id="add-social-task-modal"
            class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="social-task-modal-title" class="text-xl font-semibold mb-4">Add New Social Task</h3>
                <form id="add-social-task-form" class="modal-form space-y-4">
                    <div>
                        <label for="social-task-title" class="block text-sm font-medium mb-1">Task Title</label>
                        <input type="text" id="social-task-title" name="taskTitle" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="social-task-platform" class="block text-sm font-medium mb-1">Platform</label>
                        <select id="social-task-platform" name="taskPlatform" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="YouTube">YouTube</option>
                            <option value="Facebook">Facebook</option>
                            <option value="TikTok">TikTok</option>
                            <option value="Telegram">Telegram</option>
                            <option value="Twitter">Twitter</option>
                            <option value="Web">Web</option>
                        </select>
                    </div>
                    <div>
                        <label for="social-task-link" class="block text-sm font-medium mb-1">Link URL</label>
                        <input type="url" id="social-task-link" name="taskLink" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="social-task-points" class="block text-sm font-medium mb-1">Points</label>
                        <input type="number" id="social-task-points" name="taskPoints" required
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button"
                            class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                        <button type="submit"
                            class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Cash Out Modal  -->
        <div id="cashout-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 class="text-xl font-semibold mb-4">Cash Out Request</h3>
                <form id="cashout-form" class="modal-form space-y-4">
                    <p class="text-muted-text">Please enter your payment details to receive your earnings.</p>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium mb-1">Payment Method</label>
                        <select id="payment-method" name="paymentMethod"
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="KBZ Pay">KBZ Pay</option>
                            <option value="Wave Pay">Wave Pay</option>
                            <option value="Binance Pay">Binance Pay</option>
                        </select>
                    </div>
                    <div>
                        <label for="payout-amount" class="block text-sm font-medium mb-1">Amount ($)</label>
                        <input type="number" id="payout-amount" name="payoutAmount" value="0.00" readonly
                            class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 text-muted-text cursor-not-allowed">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button"
                            class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                        <button type="submit"
                            class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200"
                            id="cashout-submit-btn">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : {
                    apiKey: "AIzaSyBKHF_6NIFD0-zrceg3BFJBdhJcFoXiKmA",
                    authDomain: "ping-rewards.firebaseapp.com",
                    projectId: "ping-rewards",
                    storageBucket: "ping-rewards.firebasestorage.app",
                    messagingSenderId: "1001465713586",
                    appId: "1:1001465713586:web:07b8e1a2fb685614ac8aab",
                    measurementId: "G-RJD7MPSSWF"
                };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Firebase Firestore Logging ·ÄÄ·Ä≠·ÄØ Debugging ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äû·Ää·Ä∫
            setLogLevel('debug');

            let userId = null;
            let isAuthReady = false;

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            const loginMessage = document.getElementById('login-message');
            const loadingOverlay = document.getElementById('loading-overlay');

            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.content-view');
            const pageTitle = document.getElementById('page-title');
            const headerMeta = document.getElementById('header-meta');
            const sidebarProfile = document.getElementById('sidebar-profile');

            const videoGrid = document.getElementById('video-grid');
            const searchBar = document.getElementById('search-bar');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const videoPlayerView = document.getElementById('video-player-view');
            const videoIframe = document.getElementById('video-iframe');
            const videoPlayerBackBtn = document.getElementById('video-player-back-btn');
            const videoPlayerTitle = document.getElementById('video-player-title');
            const videoPlayerDescription = document.getElementById('video-player-description');

            // NEW: Circular Points Tracker UI elements
            const circularPointsTracker = document.getElementById('circular-points-tracker');
            const progressCircle = document.getElementById('progress-circle');
            const progressTimeRemaining = document.getElementById('progress-time-remaining');
            
            // NEW: Scroll to Top Button
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            const appContent = document.getElementById('app-content');

            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle');
            const backdrop = document.getElementById('backdrop');

            const addVideoBtn = document.getElementById('add-video-btn');
            const addVideoModal = document.getElementById('add-video-modal');
            const addVideoForm = document.getElementById('add-video-form');
            const addModalTitle = document.getElementById('modal-title');
            const videoTableBody = document.querySelector('#videos-table');
            const getSummaryBtn = document.getElementById('get-summary-btn');
            const summaryOutput = document.getElementById('summary-output');

            // Social task related elements
            const socialTasksGrid = document.getElementById('social-tasks-grid');
            const addSocialTaskBtn = document.getElementById('add-social-task-btn');
            const addSocialTaskModal = document.getElementById('add-social-task-modal');
            const addSocialTaskForm = document.getElementById('add-social-task-form');
            const socialTaskTableBody = document.querySelector('#social-tasks-table');
            const socialTaskModalTitle = document.getElementById('social-task-modal-title');

            // Cash out and history related elements
            const cashoutBtn = document.getElementById('cashout-button');
            const cashoutModal = document.getElementById('cashout-modal');
            const cashoutForm = document.getElementById('cashout-form');
            const totalPointsValue = document.getElementById('total-points-value');
            const estimatedEarningsValue = document.getElementById('estimated-earnings-value');
            const videosWatchedValue = document.getElementById('videos-watched-value');
            const pointsHistoryTableBody = document.querySelector('#points-history-table');
            const cashoutMessageModal = document.getElementById('cashout-message-modal');
            const cashoutMessageText = document.getElementById('cashout-message-text');
            const cashoutMessageCloseBtn = document.getElementById('cashout-message-close-btn');

            // Admin related elements
            const adminTotalUsersValue = document.getElementById('admin-total-users-value');
            const adminTotalVideosValue = document.getElementById('admin-total-videos-value');
            const adminTotalPointsEarnedValue = document.getElementById('admin-total-points-earned-value');
            const adminTotalPayoutsValue = document.getElementById('admin-total-payouts-value');
            const adminPayoutsCard = document.getElementById('admin-payouts-card');

            const welcomeMessage = document.getElementById('welcome-message');

            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalTitle = document.getElementById('delete-modal-title');
            const deleteConfirmBtn = document.getElementById('confirm-delete-btn');

            const usersTableBody = document.getElementById('users-table-body');
            const historyModal = document.getElementById('history-modal');
            const historyModalTitle = document.getElementById('history-modal-title');
            const historyTableBody = document.getElementById('history-table-body');
            const historyModalCloseBtn = document.getElementById('history-modal-close-btn');
            const historyTableHeader = document.getElementById('history-table-header');
            
            // New Invite System Elements
            const referralCodeInput = document.getElementById('referral-code-input');
            const referralLinkInput = document.getElementById('referral-link-input');
            const copyReferralBtn = document.getElementById('copy-referral-btn');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const copyStatus = document.getElementById('copy-status');
            const invitedUsersTable = document.getElementById('invited-users-table');
            const referralBonus = 50; // Referral bonus set to 50 PTS

            let videos = [];
            let socialTasks = []; //  array to hold social tasks
            let currentUser = null;
            let userData = null;
            let videoCardToAnimate = null;
            let isInitialUILoad = true;

            const adminEmail = 'mr.ping2025@gmail.com';

            // NEW: Video Watcher State Variables
            let watchInterval = null;
            let currentVideoId = null;
            let sessionWatchTime = 0;
            let sessionPoints = 0;
            const POINTS_PER_SECOND = 1 / 60; // 1 point per 60 seconds (1 minute)
            
            // --- NEW FUNCTION: applyVideoCooldown ---
            // This function applies the 24-hour cooldown and updates watchedVideos array
            async function applyVideoCooldown(videoId) {
                if (!userData || !userId || !videoId) return;

                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    
                    // 24 hours from now
                    const availableAfter = Date.now() + (24 * 60 * 60 * 1000); 
                    const cooldownEntry = { id: videoId, watchedAt: Date.now(), availableAfter: availableAfter };

                    let newCooldowns = userData.videoCooldowns || [];
                    // Remove old entry if exists (important for case where expired cooldown is reapplied)
                    newCooldowns = newCooldowns.filter(c => c.id !== videoId);
                    newCooldowns.push(cooldownEntry);

                    await updateDoc(userDocRef, {
                        // Update Cooldowns array
                        videoCooldowns: newCooldowns,
                        // Also mark as watched (for visual checkmark/sorting)
                        watchedVideos: arrayUnion(videoId)
                    });
                    console.log(`[COOLDOWN] Video ${videoId} set on 24hr cooldown.`);
                } catch (e) {
                    console.error("Error applying video cooldown:", e);
                }
            }
            // --- END NEW FUNCTION: applyVideoCooldown ---

            // NEW: Core function to handle exiting the video player view, 
            // including stopping the timer and applying cooldown if necessary.
            const handlePlayerExit = async (isAutoExit = false) => {
                const currentVideo = videos.find(v => v.id === currentVideoId);
                const videoMaxDuration = currentVideo?.watchDuration || 0;
                
                // 1. Cleanup timers and UI
                if (watchInterval) clearInterval(watchInterval);
                watchInterval = null;

                if (videoIframe) videoIframe.src = ''; // Stop video playback
                if (circularPointsTracker) circularPointsTracker.classList.add('hidden');

                // 2. Apply Cooldown if minimum watch time (60s = 1 point) was met
                // Cooldown is now triggered immediately if points were earned (>= 60s watched).
                if (currentVideoId && sessionWatchTime >= 60) {
                    console.log(`[EXIT] Applying 24-hour cooldown after ${sessionWatchTime}s watched.`);
                    // Directly apply cooldown if any points (>= 60s) were earned.
                    await applyVideoCooldown(currentVideoId);
                } else if (currentVideoId && sessionWatchTime > 0) {
                    console.log(`[EXIT] User watched ${sessionWatchTime}s (< 60s). Not enough watch time for cooldown or points.`);
                }

                // 3. Navigate away and reset session variables
                showView('watch-videos-view');
                
                currentVideoId = null;
                sessionWatchTime = 0;
                sessionPoints = 0;
                
                // Re-render the grid to show new cooldown status
                const activeFilterBtn = document.querySelector('#watch-videos-view .filter-btn.active');
                const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                renderVideoGrid(category, '', userId === null);
            };

            // Utility function to extract YouTube video ID and append autoplay=1
            function getYouTubeId(url) {
                let videoId = null;
                let embedUrl = null;

                try {
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname;
                    const pathname = urlObj.pathname;
                    if (hostname.includes('youtube.com')) {
                        if (pathname.includes('/embed/')) {
                            videoId = pathname.split('/embed/')[1].split('?')[0];
                        } else {
                            videoId = urlObj.searchParams.get('v');
                        }
                    } else if (hostname.includes('youtu.be')) {
                        videoId = pathname.substring(1);
                    }
                } catch (e) {
                    console.error("Could not parse URL, trying regex:", url, e);
                    const regex = /(?:youtube\.com\/(?:[^/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?/ ]{11})/;
                    const match = url.match(regex);
                    if (match && match[1]) {
                        videoId = match[1];
                    }
                }

                if (videoId) {
                    // Added &autoplay=1 to the embed URL
                    embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&mute=0&enablejsapi=1`;
                }

                return { videoId, embedUrl };
            }

            // Function to get a YouTube thumbnail
            function getYouTubeThumbnail(videoId) {
                if (videoId) {
                    return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }
                return 'https://placehold.co/400x225/1f3148/ffffff?text=Video';
            }

            // Function to award points to the referrer and update their invited list
            async function awardReferrerBonus(referrerId, newUserUid, newUserName) {
                try {
                    const referrerDocRef = doc(db, `/artifacts/${appId}/users/${referrerId}`);
                    const referrerDocSnap = await getDoc(referrerDocRef);

                    if (referrerDocSnap.exists()) {
                        const referrerData = referrerDocSnap.data();
                        const invitedUsers = referrerData.invitedUsers || [];
                        if (invitedUsers.some(u => u.id === newUserUid)) {
                             console.log(`Referrer ${referrerId} already credited for user ${newUserUid}. Skipping bonus.`);
                             return;
                        }
                        
                        const newPoints = (referrerData.points || 0) + referralBonus;
                        const newHistory = [...(referrerData.pointsHistory || []), {
                            date: new Date().toLocaleDateString('en-US'),
                            description: `Referral bonus from ${newUserName}`,
                            points: referralBonus // Uses the new variable (50)
                        }];
                        
                        const newInvitedUser = {
                            id: newUserUid,
                            name: newUserName,
                            date: new Date().toLocaleDateString('en-US'),
                            points: referralBonus // Store bonus amount for history
                        };

                        await updateDoc(referrerDocRef, {
                            points: newPoints,
                            pointsHistory: newHistory,
                            // Use arrayUnion to safely add the new user object if it doesn't exist
                            invitedUsers: arrayUnion(newInvitedUser)
                        });
                        console.log(`Referral bonus of ${referralBonus} points awarded to referrer ${referrerId}. User: ${newUserName}`);
                    } else {
                        console.warn(`Referrer ID ${referrerId} not found. Skipping bonus.`);
                    }
                } catch (e) {
                    console.error("Error awarding referrer bonus:", e);
                }
            }


            async function seedInitialData(user) {
                try {
                    if (!user) {
                        console.log("No authenticated user to seed data for. Skipping user seed.");
                        return;
                    }
                    const userId = user.uid;
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    // --- START REFERRAL URL CHECK AND VARIABLE SETUP ---
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrerIdFromUrl = urlParams.get('ref');
                    // Ensure referrerId is not the current user and is present
                    const validReferrerId = (referrerIdFromUrl && referrerIdFromUrl !== userId) ? referrerIdFromUrl : null;
                    // --- END REFERRAL URL CHECK AND VARIABLE SETUP ---

                    if (!userDocSnap.exists()) {
                        let userRole = 'user';
                        let userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ping User');
                        if (user.email === adminEmail) {
                            userRole = 'admin';
                            userName = 'Mr. Ping';
                        }
                        
                        // Set the new user's initial data
                        await setDoc(userDocRef, {
                            name: userName,
                            email: user.email || '',
                            role: userRole,
                            points: 0,
                            pointsHistory: [],
                            payoutHistory: [],
                            watchedVideos: [], // Simple list of IDs for general tracking
                            videoCooldowns: [], // Array of {id: 'vidX', availableAfter: timestamp} objects
                            completedSocialTasks: [],
                            // IMPORTANT: Save referrerId in the new user's document
                            referrerId: validReferrerId, 
                            invitedUsers: [] 
                        });
                        console.log("Seeding initial user data.");
                        
                        // --- AWARD REFERRER BONUS IF VALID REFERRAL LINK WAS USED ---
                        if (validReferrerId) {
                            console.log(`[Referral] New user signed up with referrer ID: ${validReferrerId}. Attempting to award bonus...`);
                            await awardReferrerBonus(validReferrerId, userId, userName);
                        }
                        // --- END AWARD REFERRER BONUS ---

                    }

                    if (user.email === adminEmail) {
                        // Seeding initial videos
                        const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                        const videosSnapshot = await getDocs(videosCollectionRef);
                        if (videosSnapshot.empty) {
                            // watchDuration is now the maximum time (in seconds) to earn points
                            const initialVideos = [
                                { id: 'vid1', title: "The Beauty of Nature", category: "Nature", points: 60, watchDuration: 300, description: "A breathtaking journey through mountains and forests.", videoUrl: "https://www.youtube.com/embed/g2J03u13kXg" },
                                { id: 'vid2', title: "Learn React in 30 Seconds", category: "Education", points: 30, watchDuration: 180, description: "A quick overview of React hooks.", videoUrl: "https://www.youtube.com/embed/Ke90Tje7VS0" },
                                { id: 'vid3', title: "City Life at Night", category: "Travel", points: 90, watchDuration: 540, description: "Explore the vibrant life of a metropolis after dark.", "videoUrl": "https://www.youtube.com/embed/5a-H_gqM_9E" },
                                { id: 'vid4', title: "Cooking a Perfect Steak", category: "Food", points: 60, watchDuration: 240, description: "A step by step guide to cooking steak.", "videoUrl": "https://www.youtube.com/embed/H0d82C7YjA8" },
                                { id: 'vid5', title: "Gaming Highlights of the Week", category: "Gaming", points: 120, watchDuration: 720, description: "The best moments in esports.", "videoUrl": "https://www.youtube.com/embed/d-Yq36_9tQ0" }
                            ];
                            for (const video of initialVideos) {
                                await setDoc(doc(videosCollectionRef, video.id), {
                                    title: video.title,
                                    category: video.category,
                                    points: video.points, // Legacy points, ignored for earning logic
                                    watchDuration: video.watchDuration, // Max earning duration
                                    description: video.description,
                                    videoUrl: video.videoUrl
                                });
                            }
                            console.log("Seeding initial video data.");
                        }

                        // Seeding initial social tasks
                        const socialTasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/socialTasks`);
                        const socialTasksSnapshot = await getDocs(socialTasksCollectionRef);
                        if (socialTasksSnapshot.empty) {
                            const initialSocialTasks = [
                                { id: 'task1', title: 'Follow us on Facebook', platform: 'Facebook', link: 'https://facebook.com/pingrewards', points: 100 },
                                { id: 'task2', title: 'Follow us on Telegram', platform: 'Telegram', link: 'https://t.me/pingrewards', points: 150 },
                                { id: 'task3', title: 'Follow us on TikTok', platform: 'TikTok', link: 'https://tiktok.com/@pingrewards', points: 120 },
                                { id: 'task4', title: 'Subscribe to our YouTube', platform: 'YouTube', link: 'https://www.youtube.com/@pingrewards', points: 200 },
                            ];
                            for (const task of initialSocialTasks) {
                                await setDoc(doc(socialTasksCollectionRef, task.id), task);
                            }
                            console.log("Seeding initial social task data.");
                        }
                    }
                } catch (error) {
                    console.error("Error seeding data: ", error);
                }
            }
            
            // FIX 1: Update setupPublicDataListeners to re-render Admin views on snapshot update
            function setupPublicDataListeners(isGuest) {
                // Listener for Videos
                const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                onSnapshot(videosCollectionRef, (querySnapshot) => {
                    videos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Videos updated via snapshot:", videos.length);
                    
                    // Only re-render video grids if the view is currently active
                    if (document.getElementById('watch-videos-view').style.display === 'block') {
                        const activeFilterBtn = document.querySelector('#watch-videos-view .filter-btn.active');
                        const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                        renderVideoGrid(category, searchBar.value, isGuest);
                    }
                    
                    // NEW FIX 2: Re-render Admin Manage Videos view if active
                    if (document.getElementById('manage-videos-view')?.style.display === 'block' && !isGuest) {
                        renderManageVideosTable(); 
                    }
                    
                }, (error) => {
                    console.error("Error listening to videos:", error);
                });

                // Listener for Social Tasks
                const socialTasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/socialTasks`);
                onSnapshot(socialTasksCollectionRef, (querySnapshot) => {
                    socialTasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Social tasks updated via snapshot:", socialTasks.length);

                    // Re-render tasks if the user view is currently active
                    if (document.getElementById('social-tasks-view').style.display === 'block') {
                        renderSocialTasksGrid(isGuest);
                    }
                    
                    // NEW FIX 2: Re-render Admin Manage Social Tasks view if active
                    if (document.getElementById('manage-social-tasks-view')?.style.display === 'block' && !isGuest) {
                        renderManageSocialTasksTable(); 
                    }
                    
                }, (error) => {
                    console.error("Error listening to social tasks:", error);
                });
            }
            
            // Remove old fetchVideos and fetchSocialTasks functions...

            async function fetchAndRenderLeaderboard() {
                const leaderboardContainer = document.getElementById('leaderboard-container');
                if (!leaderboardContainer) return;

                leaderboardContainer.innerHTML = `<div class="text-center text-muted-text p-4">Loading leaderboard...</div>`;

                try {
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    const querySnapshot = await getDocs(usersCollectionRef);
                    const users = querySnapshot.docs.map(doc => doc.data());

                    // Sort users by points in descending order
                    users.sort((a, b) => (b.points || 0) - (a.points || 0));

                    const topUsers = users.slice(0, 5);

                    if (topUsers.length === 0) {
                        leaderboardContainer.innerHTML = `<p class="text-center text-muted-text p-4">No users on the leaderboard yet. Be the first!</p>`;
                        return;
                    }

                    let leaderboardHtml = '';
                    topUsers.forEach((user, index) => {
                        const rank = index + 1;
                        let medal = '';
                        if (rank === 1) medal = 'ü•á';
                        else if (rank === 2) medal = 'ü•à';
                        else if (rank === 3) medal = 'ü•â';

                        const profileText = user.name ? user.name.split(' ').map(n => n[0]).join('') : '?';

                        leaderboardHtml += `
                <div class="flex items-center bg-slate-700/50 p-3 rounded-lg">
                    <div class="w-8 text-center text-lg font-bold">${medal || rank}</div>
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center mr-4 ml-2 font-semibold text-primary">
                        ${profileText}
                    </div>
                    <div class="flex-grow">
                        <div class="font-semibold text-white">${user.name || 'Anonymous User'}</div>
                        <div class="text-sm text-muted-text">${(user.points || 0).toLocaleString()} PTS</div>
                    </div>
                </div>
            `;
                    });
                    leaderboardContainer.innerHTML = leaderboardHtml;

                } catch (error) {
                    console.error("Error fetching leaderboard data:", error);
                    leaderboardContainer.innerHTML = `<p class="text-center text-red-500 p-4">Could not load leaderboard.</p>`;
                }
            }


            async function fetchUserData(uid) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}`);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        currentUser = {
                            name: userData.name,
                            email: userData.email,
                            role: userData.role
                        };
                        updateUI(currentUser.role);
                        console.log("User data updated:", userData);
                    } else {
                        console.log("User data not found for a logged-in user. This should not happen if `seedInitialData` ran correctly.");
                        hideLoading();
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    hideLoading();
                });
            }

            async function fetchAllUsers() {
                showLoading();
                if (!usersTableBody) return;
                usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-muted-text">Fetching users...</td></tr>`;
                try {
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    const querySnapshot = await getDocs(usersCollectionRef);
                    const users = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsersTable(users);
                } catch (e) {
                    console.error("Error fetching users:", e);
                    usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error fetching users.</td></tr>`;
                } finally {
                    hideLoading();
                }
            }

            async function toggleUserRole(targetUserId, currentRole) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                const newRole = currentRole === 'admin' ? 'user' : 'admin';
                try {
                    await updateDoc(userDocRef, { role: newRole });
                    console.log(`User role updated to ${newRole}`);
                } catch (e) {
                    console.error("Error updating user role:", e);
                }
            }

            // Updates user points in Firestore and adds a new history entry
            // NOTE: isFullWatch and videoDuration parameters are kept for compatibility with existing calls, 
            // but the internal cooldown logic is removed here and moved to applyVideoCooldown.
            async function updatePointsInFirestore(pointsToAdd, description, id, type = 'video', isFullWatch = false, videoDuration = 0) {
                if (!userData || !userId) return;
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const newPoints = userData.points + pointsToAdd;
                    const newHistory = pointsToAdd > 0 ? [...(userData.pointsHistory || []), {
                        date: new Date().toLocaleDateString('en-US'),
                        description: description,
                        points: pointsToAdd
                    }] : userData.pointsHistory || [];

                    const updateData = {
                        points: newPoints,
                        pointsHistory: newHistory,
                    };

                    if (type === 'video' && id && pointsToAdd > 0) {
                         // Only mark as watched if points were actually earned (for sorting/checkmark)
                         // Cooldown logic is now handled exclusively by applyVideoCooldown
                         updateData.watchedVideos = arrayUnion(id);
                    } else if (type === 'social') {
                        updateData.completedSocialTasks = arrayUnion(id);
                    }

                    await updateDoc(userDocRef, updateData);
                    console.log("Points and history updated in Firestore.");
                } catch (e) {
                    console.error("Error updating points:", e);
                }
            }

            async function saveVideo(videoData, videoId = null) {
                showLoading();
                try {
                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    if (videoId) {
                        const videoDocRef = doc(db, videosCollectionRef.path, videoId);
                        await setDoc(videoDocRef, videoData, { merge: true });
                        console.log("Video updated:", videoId);
                    } else {
                        await addDoc(videosCollectionRef, videoData);
                        console.log("Video added successfully.");
                    }
                } catch (e) {
                    console.error("Error saving video:", e);
                } finally {
                    hideLoading();
                }
                // FIX 2: Removed manual render call, rely entirely on onSnapshot
            }

            // Function to save or update a social task
            async function saveSocialTask(taskData, taskId = null) {
                showLoading();
                try {
                    const tasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/socialTasks`);
                    if (taskId) {
                        const taskDocRef = doc(db, tasksCollectionRef.path, taskId);
                        await setDoc(taskDocRef, taskData, { merge: true });
                        console.log("Social task updated:", taskId);
                    } else {
                        await addDoc(tasksCollectionRef, taskData);
                        console.log("Social task added successfully.");
                    }
                } catch (e) {
                    console.error("Error saving social task:", e);
                } finally {
                    hideLoading();
                }
                // FIX 2: Removed manual render call, rely entirely on onSnapshot
            }

            async function deleteVideo(videoId) {
                showLoading();
                try {
                    const videoDocRef = doc(db, `/artifacts/${appId}/public/data/videos`, videoId);
                    await deleteDoc(videoDocRef);
                    console.log("Video deleted:", videoId);
                } catch (e) {
                    console.error("Error deleting video:", e);
                } finally {
                    hideLoading();
                }
                // Rely on onSnapshot to re-render tables/grids
                // renderManageVideosTable(); // This is now handled by onSnapshot
            }

            // Function to delete a social task
            async function deleteSocialTask(taskId) {
                showLoading();
                try {
                    const taskDocRef = doc(db, `/artifacts/${appId}/public/data/socialTasks`, taskId);
                    await deleteDoc(taskDocRef);
                    console.log("Social task deleted:", taskId);
                } catch (e) {
                    console.error("Error deleting social task:", e);
                } finally {
                    hideLoading();
                }
                // Rely on onSnapshot to re-render tables/grids
                // renderManageSocialTasksTable(); // This is now handled by onSnapshot
            }

            function showLoading() {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                    setTimeout(() => loadingOverlay.style.opacity = '1', 10);
                }
            }

            function hideLoading() {
                if (loadingOverlay) {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => loadingOverlay.style.display = 'none', 300);
                }
            }

            async function fetchAdminDashboardData() {
                showLoading();
                try {
                    // Fetch total users, points, and payouts using onSnapshot for real-time updates
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    onSnapshot(usersCollectionRef, (usersSnapshot) => {
                        const totalUsers = usersSnapshot.docs.length;
                        let totalPointsEarned = 0;
                        let totalPayouts = 0;
                        usersSnapshot.forEach(doc => {
                            const userData = doc.data();
                            const userPoints = userData.points || 0;
                            totalPointsEarned += userPoints;

                            const payoutHistory = userData.payoutHistory || [];
                            payoutHistory.forEach(payout => {
                                totalPayouts += payout.amount || 0;
                            });
                        });

                        if (adminTotalUsersValue) adminTotalUsersValue.textContent = totalUsers;
                        if (adminTotalPointsEarnedValue) adminTotalPointsEarnedValue.textContent = totalPointsEarned;
                        if (adminTotalPayoutsValue) adminTotalPayoutsValue.textContent = `$${totalPayouts.toFixed(2)}`;
                    }, (error) => {
                        console.error("Error fetching admin users data:", error);
                    });
                    
                    // Total Videos is covered by the public data listener (setupPublicDataListeners)
                    if (adminTotalVideosValue) adminTotalVideosValue.textContent = videos.length; 

                } catch (e) {
                    console.error("Admin dashboard data fetch error:", e);
                } finally {
                    hideLoading();
                }
            }

            function updateUI(role) {
                if (!isAuthReady) return;

                const isGuest = role === 'guest';
                const actualRole = isGuest ? 'user' : role; // Guests use the user interface structure

                // This block runs only on the very first load for a user session
                if (isInitialUILoad) {
                    views.forEach(view => { if (view) view.style.display = 'none'; });
                    if (loginPage) loginPage.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'flex';
                    
                    // Set initial visibility based on role
                    document.querySelectorAll('.admin-link').forEach(link => { 
                        if (link) link.style.display = (actualRole === 'admin' ? 'flex' : 'none'); 
                    });
                    document.querySelectorAll('.user-link').forEach(link => { 
                        if (link) link.style.display = (actualRole === 'admin' ? 'none' : 'flex'); 
                    });
                    
                    if (actualRole === 'user') {
                        showView('user-dashboard-view');
                        // Render initial grids using already-fetched (via onSnapshot) data
                        renderVideoGrid('all', '', isGuest);
                        renderSocialTasksGrid(isGuest);
                        
                    } else if (role === 'admin') {
                        showView('admin-dashboard-view');
                        fetchAdminDashboardData(); // Admin data fetch includes snapshots
                        renderManageVideosTable();
                        renderManageSocialTasksTable();
                    }
                    isInitialUILoad = false; // Important: set flag to false
                }

                // This block runs on every data update (initial and subsequent)
                if (actualRole === 'user') {
                    if (headerMeta) headerMeta.innerHTML = getUserHeaderHTML(isGuest); // Pass guest status
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML(isGuest); // Pass guest status
                    
                    if (welcomeMessage) welcomeMessage.textContent = isGuest ? `Welcome to Ping Rewards! Login to start earning points.` : `Welcome back, ${currentUser.name}!`;

                    updatePointsDisplay(); // Will use userData (0 points for guest)
                    fetchAndRenderLeaderboard(); // Leaderboard is public data

                    // Re-render active view content if necessary
                    const activeView = document.querySelector('.content-view[style*="block"]');
                    const activeViewId = activeView ? activeView.id : '';

                    if (activeViewId === 'points-history-view') {
                        if (isGuest) {
                             document.getElementById('points-history-view').innerHTML = getGuestViewHtml('Points History', 'view your points and history', 'view your points history.');
                        } else {
                            renderPointsHistoryTable();
                        }
                    }
                    // Video and Social tasks rendering is now mostly handled by the public data listeners (onSnapshot)
                    if (activeViewId === 'invite-and-earn-view') {
                         renderInviteAndEarnView(isGuest); 
                    }

                } else if (actualRole === 'admin') {
                    if (headerMeta) headerMeta.innerHTML = getAdminHeaderHTML();
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML();
                    // Admin dashboard data is real-time via its own snapshot.
                }
                attachLogoutListeners(isGuest); // Pass isGuest to properly re-attach listeners or skip.
            }
            
            // Helper function to generate login prompt message for guest restricted pages
            function getGuestViewHtml(title, action, message) {
                return `
                     <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 text-center">
                         <h2 class="text-xl font-semibold mb-4 text-red-400">${title} - Login Required</h2>
                         <p class="text-muted-text">Please sign in to ${action}!</p>
                         <button onclick="
                            document.getElementById('login-page').style.display = 'flex'; 
                            document.getElementById('app-container').style.display = 'none'; 
                            document.getElementById('login-message').textContent='Sign in to ${message}'; 
                            document.getElementById('login-message').style.display='block';
                         "
                             class="mt-4 px-6 py-2 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300">
                             Go to Login
                         </button>
                     </div>
                 `;
            }


            function getUserProfileHTML(isGuest = false) {
                const nameText = isGuest ? 'Guest User' : (currentUser?.name || 'Unknown');
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                const roleText = isGuest ? 'VIEW ONLY' : (currentUser?.role === 'admin' ? 'ADMINISTRATOR' : currentUser?.email || 'N/A');
                return `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full ${isGuest ? 'bg-slate-700 text-muted-text' : 'bg-primary/20 flex items-center justify-center mr-4 font-semibold text-primary'}">
                             ${profileText}
                        </div>
                        <div class="flex-grow">
                            <div class="text-white font-semibold">${nameText}</div>
                            <div class="text-sm text-muted-text">${roleText}</div>
                        </div>
                    </div>
                `;
            }

            function getUserHeaderHTML(isGuest = false) {
                const nameText = isGuest ? 'Guest' : (currentUser?.name || 'Unknown');
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                const roleText = isGuest ? 'View Only' : (currentUser?.role === 'admin' ? 'Admin' : 'User');
                
                const pointsDisplay = isGuest ?
                    `<span class="font-bold text-lg text-red-400">0 PTS</span><span class="text-sm text-muted-text">Login to Earn</span>` :
                    `<span id="user-points-display" class="font-bold text-lg">${(userData?.points || 0).toLocaleString()} PTS</span><span class="text-sm text-muted-text">$${((userData?.points || 0) / 5000).toFixed(2)}</span>`;
                
                // If Guest, show a Login button that swaps the view
                const authButton = isGuest ? 
                    `<button onclick="document.getElementById('login-page').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; document.getElementById('login-message').style.display='none';" class="px-3 py-1 bg-accent-green hover:bg-emerald-600 rounded-lg text-white text-sm font-semibold transition-colors duration-200">Login</button>` :
                    `<button class="logout-btn p-2 rounded-full hover:bg-slate-700 transition-colors duration-200">
                        <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    </button>`;

                return `
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-end">
                            ${pointsDisplay}
                        </div>
                        <div class="flex items-center space-x-2">
                             <div class="text-right">
                                 <span class="block font-semibold">${nameText}</span>
                                 <span class="block text-xs text-muted-text">${roleText}</span>
                             </div>
                            <img src="https://placehold.co/32x32/${isGuest ? '94a3b8' : '6366f1'}/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full border border-primary">
                        </div>
                        ${authButton}
                    </div>
                `;
            }

            function getAdminHeaderHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                return `
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                             <div class="text-right">
                                 <span class="block font-semibold">${nameText}</span>
                                 <span class="block text-xs text-muted-text">Admin</span>
                             </div>
                            <img src="https://placehold.co/32x32/6366f1/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full border border-primary">
                        </div>
                        <button class="logout-btn p-2 rounded-full hover:bg-slate-700 transition-colors duration-200">
                            <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                 `;
            }

            function attachLogoutListeners(isGuest = false) {
                if(isGuest) return; // Skip attaching listeners if in guest mode, as the login button is inline JS

                const logoutButtons = document.querySelectorAll('.logout-btn');
                if (logoutButtons) {
                    logoutButtons.forEach(btn => {
                        const oldBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(oldBtn, btn);
                    });
                    const newLogoutButtons = document.querySelectorAll('.logout-btn');
                    newLogoutButtons.forEach(btn => {
                        btn.addEventListener('click', async () => {
                            try {
                                await signOut(auth);
                                // The onAuthStateChanged handler will catch the logout and set up guest view
                                console.log("User signed out.");
                            } catch (error) {
                                console.error("Error signing out:", error);
                            }
                        });
                    });
                }
            }

            function showView(targetId) {
                views.forEach(view => { if (view) view.style.display = 'none'; });
                const targetView = document.getElementById(targetId);
                if (targetView) {
                    targetView.style.display = 'block';
                    updatePageTitle(targetId);
                    navLinks.forEach(nav => {
                        if (nav) nav.classList.remove('active', 'bg-primary/20', 'text-white');
                    });
                    const activeLink = document.querySelector(`a[data-target="${targetId}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active', 'bg-primary/20', 'text-white');
                    }
                }
                
                // NEW: Scroll To Top Button visibility handler
                if (scrollToTopBtn && appContent) {
                    const isWatchVideosView = targetId === 'watch-videos-view';
                    if (isWatchVideosView && appContent.scrollTop > 300) {
                         // Show if already scrolled down
                         scrollToTopBtn.classList.remove('hidden');
                    } else {
                         // Hide immediately for other views or if not scrolled down
                         scrollToTopBtn.classList.add('hidden');
                    }
                }
            }

            function updatePageTitle(viewId) {
                const titleElement = document.getElementById('page-title');
                if (!titleElement) return;

                const menuToggle = `<button id="menu-toggle" class="md:hidden p-2 -ml-2 rounded-md hover:bg-card-bg transition-colors duration-200">
                                          <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                                      </button>`;
                let titleText = 'Ping Rewards';

                switch (viewId) {
                    case 'user-dashboard-view': titleText = 'Dashboard'; break;
                    case 'watch-videos-view': titleText = 'Watch Videos'; break;
                    case 'social-tasks-view': titleText = 'Social Tasks'; break;
                    case 'points-history-view': titleText = 'Points History'; break;
                    case 'invite-and-earn-view': titleText = 'Invite & Earn'; break;
                    case 'about-view': titleText = 'About'; break;
                    case 'admin-dashboard-view': titleText = 'Admin Dashboard'; break;
                    case 'manage-videos-view': titleText = 'Manage Videos'; break;
                    case 'manage-social-tasks-view': titleText = 'Manage Social Tasks'; break;
                    case 'manage-users-view': titleText = 'Manage Users'; break;
                    case 'video-player-view': titleText = 'Video Player'; break;
                }
                titleElement.innerHTML = `${menuToggle} ${titleText}`;

                const toggleBtn = document.getElementById('menu-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        if (sidebar) sidebar.classList.toggle('open');
                        if (backdrop) backdrop.classList.toggle('open');
                        document.body.classList.toggle('no-scroll');
                    });
                }
            }

            function generateRandomChartData() {
                const bars = document.querySelectorAll('#weekly-watch-chart .w-1\\/7');
                bars.forEach(bar => {
                    const randomHeight = Math.floor(Math.random() * 90) + 10;
                    bar.style.height = `${randomHeight}%`;
                });
            }

            function renderVideoGrid(category = 'all', searchQuery = '', isGuest = false) {
                const videoGrid = document.getElementById('video-grid');
                if (!videoGrid) {
                    console.error("Video grid element not found.");
                    return;
                }

                let filteredVideos = videos;
                if (category !== 'all') {
                    filteredVideos = filteredVideos.filter(video => video.category === category);
                }
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filteredVideos = filteredVideos.filter(video =>
                        video.title.toLowerCase().includes(query) ||
                        video.description.toLowerCase().includes(query)
                    );
                }

                if (filteredVideos.length === 0) {
                    videoGrid.innerHTML = `<p class="col-span-full text-center text-muted-text py-12">No videos found.</p>`;
                    return;
                }

                // Get cooldown info (only applicable if not guest)
                const videoCooldowns = isGuest ? [] : (userData?.videoCooldowns || []);
                const watchedVideoIds = isGuest ? [] : (userData?.watchedVideos || []);

                // Function to check if a video is on cooldown
                const getCooldownStatus = (videoId) => {
                    if (isGuest) return { isOnCooldown: false, isWatched: false }; // Guest means no cooldown check

                    const isWatched = watchedVideoIds.includes(videoId);
                    const cooldown = videoCooldowns.find(c => c.id === videoId);
                    
                    if (!cooldown) return { isOnCooldown: false, isWatched: isWatched };

                    const availableAfter = cooldown.availableAfter;
                    if (Date.now() < availableAfter) {
                        return {
                            isOnCooldown: true,
                            isWatched: isWatched,
                            availableAfter: availableAfter,
                            remainingTime: availableAfter - Date.now()
                        };
                    }
                    // Cooldown expired
                    return { isOnCooldown: false, isWatched: isWatched };
                };
                
                // Categorize and sort the videos based on new logic
                let primaryVideos = []; // Unwatched/Never Cooldown
                let secondaryVideos = []; // Watched before, Cooldown expired (Ready)
                let cooldownVideos = []; // Currently On Cooldown

                filteredVideos.forEach(video => {
                    const status = getCooldownStatus(video.id);
                    if (status.isOnCooldown) {
                        cooldownVideos.push({ ...video, ...status });
                    } else if (status.isWatched) {
                        // Cooldown is false, but isWatched is true (meaning cooldown expired)
                        secondaryVideos.push({ ...video, ...status });
                    } else {
                        // Not watched before, not on cooldown
                        primaryVideos.push({ ...video, ...status });
                    }
                });

                // Cooldown videos go to the bottom and are sorted by earliest availability
                cooldownVideos.sort((a, b) => a.availableAfter - b.availableAfter);
                
                // Final sorted list: Primary (New/Unwatched) -> Secondary (Ready/Watched) -> Cooldown
                const sortedVideos = [...primaryVideos, ...secondaryVideos, ...cooldownVideos];


                let videoGridHtml = '';
                sortedVideos.forEach(video => {
                    const { videoId } = getYouTubeId(video.videoUrl);
                    let thumbnailUrl = getYouTubeThumbnail(videoId);
                    
                    const status = getCooldownStatus(video.id);
                    const isWatched = status.isWatched; // Cooldown expired but watched before
                    const isOnCooldown = status.isOnCooldown;

                    let stateClasses = 'cursor-pointer video-clickable';
                    let watchedOverlay = '';
                    let actionText = 'Watch to Earn';
                    
                    if (isGuest) {
                        // Guest specific visual lock
                        stateClasses = 'opacity-80 video-clickable'; 
                        actionText = 'Login to Earn Points';
                        watchedOverlay = `<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-xl flex-col p-4">
                                <svg class="w-8 h-8 text-primary mb-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 10h-2V6c0-2.21-1.79-4-4-4S8 3.79 8 6v4H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V12c0-1.1-.9-2-2-2zm-6-6c1.1 0 2 .9 2 2v4H10V6c0-1.1.9-2 2-2zm6 16H6V12h12v8zM12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
                                <span class="text-sm font-bold text-primary text-center">Login to Start Earning</span>
                            </div>`;
                    } else if (isOnCooldown) {
                         stateClasses = 'opacity-50 pointer-events-none cursor-not-allowed';
                         const remainingHours = Math.ceil(status.remainingTime / (1000 * 60 * 60));
                         actionText = `Cooldown: ${remainingHours} Hrs Left`;
                         watchedOverlay = `<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-xl flex-col p-4">
                                <svg class="w-8 h-8 text-yellow-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span class="text-sm font-bold text-yellow-400 text-center">Cooldown: ${remainingHours} Hrs Left</span>
                            </div>`;
                    } else if (isWatched) {
                        // Cooldown expired and ready to re-watch
                         watchedOverlay = `<div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center rounded-xl">
                               <svg class="w-12 h-12 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                           </div>`;
                        actionText = 'Watched Before (Ready!)';
                    }
                    
                    // Calculation for Points/Min and Max Duration display
                    const watchDuration = video.watchDuration || 60;
                    const pointsPerMin = 1; // Always 1 point per min
                    const maxDurationMin = Math.max(1, Math.ceil(watchDuration / 60) || 1);
                    const mockChannelName = "Ping Channel";

                    const videoCardHtml = `
                        <div class="video-card group ${stateClasses}" data-video-url="${video.videoUrl}" data-video-id="${video.id}" data-max-duration="${watchDuration}" data-is-guest="${isGuest}">
                            <div class="relative mb-2">
                                <img src="${thumbnailUrl}" alt="${video.title}" class="w-full h-auto object-cover rounded-xl group-hover:rounded-none transition-all duration-200" onerror="this.onerror=null; this.src='https://placehold.co/400x225/1f3148/ffffff?text=Video';">
                                ${watchedOverlay}
                                <div class="absolute bottom-1.5 right-1.5 flex items-center space-x-1">
                                     <span class="bg-primary bg-opacity-90 text-white text-xs font-bold px-2 py-1 rounded-md">~${pointsPerMin} PTS/Min</span>
                                     <span class="bg-black bg-opacity-75 text-white text-xs font-semibold px-2 py-1 rounded-md">${maxDurationMin} MIN</span>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <img src="https://placehold.co/36x36/6366f1/ffffff?text=P" alt="${mockChannelName}" class="w-9 h-9 rounded-full">
                                </div>
                                <div class="flex-grow">
                                    <h3 class="text-base font-medium text-text-color line-clamp-2 leading-tight">${video.title}</h3>
                                    <p class="text-sm text-muted-text mt-1">${mockChannelName}</p>
                                    <div class="text-sm text-muted-text flex items-center space-x-2">
                                        <span>${actionText}</span>
                                        <span>‚Ä¢</span>
                                        <span>${video.category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    videoGridHtml += videoCardHtml;
                });
                videoGrid.innerHTML = videoGridHtml;
                attachVideoCardListeners(isGuest);
            }


            // Function to render social tasks for the user
            function renderSocialTasksGrid(isGuest = false) {
                if (!socialTasksGrid) {
                    console.error("Social tasks grid element not found.");
                    return;
                }

                if (isGuest) {
                    socialTasksGrid.innerHTML = `<div class="col-span-full">${getGuestViewHtml('Social Tasks', 'complete social tasks and earn points', 'complete social tasks and earn points.')}</div>`;
                    return;
                }
                
                socialTasksGrid.innerHTML = '';

                if (socialTasks.length === 0) {
                    socialTasksGrid.innerHTML = `<p class="col-span-full text-center text-muted-text p-6">No social tasks available right now. Check back later!</p>`;
                    return;
                }

                const completedTasks = userData?.completedSocialTasks || [];
                socialTasks.forEach(task => {
                    const isCompleted = completedTasks.includes(task.id);
                    // Disable if completed OR if guest
                    const isDisabled = isCompleted || isGuest; 
                    
                    let cardClass = isDisabled ? 'opacity-50 cursor-not-allowed' : '';
                    if(isCompleted) cardClass += ' grayscale'; // Add grayscale only if genuinely completed
                    
                    const buttonText = isCompleted ? 'Completed' : 'Complete Task';
                    const buttonClass = isCompleted ? 'bg-accent-green/50' : 'bg-primary hover:bg-indigo-600';

                    let taskIcon = ''; // FIX: Renamed 'icon' to 'taskIcon' to avoid potential constant assignment error
                    switch (task.platform) {
                        case 'Facebook': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-blue-600"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c5.29 0 9.77-4.14 10-9.43.14-2.85-2.06-5.26-4.91-5.74v2.02c1.78.4 3.12 1.93 3.12 3.82 0 2.11-1.79 3.82-3.99 3.82H12v-6.93l-3 3v2.93h-1v-6h-2v6.93l1.85-1.85c.19-.19.45-.3.72-.3s.53.11.72.3L12 14.07V12h3.99c1.66 0 3-1.34 3-3s-1.34-3-3-3h-3c-1.1 0-2 .9-2 2v1H9v2h2v1H8c-2.21 0-4-1.79-4-4s1.79-4 4-4h4V2z"/></svg>`; break;
                        case 'TikTok': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-black dark:fill-white"><path d="M12.758 2.043l-.158.012c-1.42 0-2.585 1.164-2.585 2.585v15.728l-.16.012h-.008c-.768.04-1.455.334-2.02.825-1.127.994-1.82 2.766-1.82 4.697 0 3.242 2.632 5.875 5.875 5.875 3.243 0 5.875-2.633 5.875-5.875 0-1.93-.693-3.703-1.82-4.696-.564-.49-1.25-.785-2.018-.825h-.008L12.758 2.043zM12 24c-6.627 0-12-5.373-12-12s5.373-12 12-12c6.627 0 12 5.373 12 12s-5.373 12-12 12zm-3-19c0 .552-.448 1-1 1s-1-.448-1-1v-2c0-.552.448-1 1-1s1 .448 1 1v2zm0 17c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5zm9-11c0-.552-.448-1-1-1s-1 .448-1 1v2c0 .552.448 1 1 1s1-.448 1-1v-2zm-9 9c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z"/></svg>`; break;
                        case 'Telegram': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-blue-500"><path d="M18.3 5.4c-.6-.3-1.2-.5-1.9-.5c-.8 0-1.5.2-2.1.6c-.6.4-1 .9-1.3 1.5c-.3.6-.4 1.3-.4 2s.1 1.4.4 2.1c.3.6.7 1.1 1.3 1.5c.6.4 1.2.6 2.1.6c.7 0 1.4-.2 1.9-.5c.6-.3 1.1-.8 1.4-1.4c.3-.6.4-1.2.4-1.9s-.1-1.3-.4-1.9c-.3-.6-.8-1.1-1.4-1.4zM22 6.5l-3.3 12c-.2.9-.8 1.4-1.8 1.4c-.6 0-1.2-.2-1.6-.4l-5.6-3.8c-.5-.3-.9-.6-1.1-.9c-.2-.3-.3-.7-.3-1.1c0-.4.1-.8.3-1.1s.5-.6 1.1-.9l8.6-4.9c.2-.1.4-.2.6-.2c.2 0 .4.1.6.2s.2.4.2.6zM2 12c0 2.2 1.3 4.2 3.3 5.3L4 20l3.8-1.1c.9.2 1.8.3 2.7.3c1.7 0 3.3-.6 4.6-1.7l.7-.6c-.2-.4-.3-.8-.3-1.2c0-1.3.6-2.5 1.7-3.3c1.1-.8 2.5-1.2 4-1.2c-.4-3.1-2.2-5.4-4.8-6.5c-2.4-1-5.1-1.2-7.8-.6c-3 .7-5.3 3.3-5.3 6.6z"/></svg>`; break;
                        case 'Twitter': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-blue-400"><path d="M22.46 6c-.77.34-1.6.57-2.46.69.88-.53 1.55-1.37 1.87-2.36-.83.49-1.74.85-2.72 1.05-2.02-2.15-5.35-2.07-7.29.17-1.18 1.32-1.65 3.12-1.36 4.95C5.83 10.66 2.92 8.75 1.12 5.92c-.37.64-.58 1.39-.58 2.19 0 1.52.77 2.87 1.94 3.66-2.01-.06-3.89-.6-5.54-1.52v.04c0 1.92 1.37 3.51 3.19 3.87-.33.09-.67.14-1.02.14-.25 0-.5-.02-.74-.07.5 1.63 2.07 2.81 3.89 2.84-1.4 1.1-3.17 1.75-5.09 1.75-.33 0-.66-.02-.98-.06 1.8 1.15 3.93 1.81 6.22 1.81 7.52 0 11.63-6.22 11.63-11.62 0-.17-.0-.35-.01-.52.8-.57 1.49-1.28 2.04-2.07z"/></svg>`; break;
                        case 'YouTube': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-red-600"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3 10l-6 4V8l6 4z"/></svg>`;
                        case 'Web': taskIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-gray-400"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-2h-2v2zm0-4h2V7h-2v6z"/></svg>`;
                        default: taskIcon = '';
                    }

                    const taskCardHtml = `
                         <div class="social-task-card bg-card-bg rounded-xl shadow-lg border border-slate-700 p-6 flex flex-col items-center text-center transition-shadow duration-300 ${cardClass}">
                             <div class="w-16 h-16 rounded-full flex items-center justify-center mb-4">${taskIcon}</div>
                             <h3 class="text-lg font-semibold mb-1">${task.title}</h3>
                             <p class="text-sm text-muted-text mb-2">${task.platform}</p>
                             <span class="inline-block bg-accent-green text-white text-xs font-bold px-3 py-1 rounded-full mb-4">${task.points} PTS</span>
                             <button class="complete-task-btn w-full py-2 text-white font-semibold rounded-lg transition-colors duration-300 ${buttonClass}" data-task-id="${task.id}" data-task-link="${task.link}" ${isDisabled ? 'disabled' : ''}>
                                 ${buttonText}
                             </button>
                         </div>
                     `;
                    socialTasksGrid.innerHTML += taskCardHtml;
                });
                attachSocialTaskListeners(isGuest);
            }

            function renderUsersTable(users) {
                if (!usersTableBody) return;
                
                if (users.length === 0) {
                    usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-muted-text">No users found.</td></tr>`;
                    return;
                }

                let usersTableHtml = '';
                users.forEach(user => {
                    const isAdmin = user.role === 'admin';
                    const roleClass = isAdmin ? 'text-accent-orange font-bold' : 'text-primary';
                    const actionButtonText = isAdmin ? 'Demote to User' : 'Promote to Admin';
                    const actionButtonClass = isAdmin ? 'bg-red-500 hover:bg-red-600' : 'bg-accent-green hover:bg-emerald-600';
                    
                    const profileText = user.name ? user.name.split(' ').map(n => n[0]).join('') : '?';

                    usersTableHtml += `
                        <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                            <td class="p-4 text-xs font-mono break-all">${user.id}</td>
                            <td class="p-4 flex items-center">
                                <img src="https://placehold.co/24x24/${isAdmin ? 'f59e0b' : '6366f1'}/ffffff?text=${profileText}" alt="${user.name}" class="w-6 h-6 rounded-full mr-2">
                                ${user.name || 'N/A'}
                            </td>
                            <td class="p-4 text-sm">${user.email || 'N/A'}</td>
                            <td class="p-4 text-sm ${roleClass}">${user.role}</td>
                            <td class="p-4 text-lg font-bold text-primary">${(user.points || 0).toLocaleString()}</td>
                            <td class="p-4 whitespace-nowrap">
                                <button class="view-history-btn px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded-lg text-white text-xs font-semibold mr-2" data-user-id="${user.id}" data-user-name="${user.name}">History</button>
                                <button class="toggle-role-btn px-3 py-1 ${actionButtonClass} rounded-lg text-white text-xs font-semibold" data-user-id="${user.id}" data-current-role="${user.role}">
                                    ${actionButtonText}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                usersTableBody.innerHTML = usersTableHtml;
                attachUserTableListeners();
            }

            // Function to render the table for managing videos (Admin view)
            function renderManageVideosTable() {
                if (!videoTableBody) return;
                
                if (videos.length === 0) {
                    videoTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-muted-text">No videos added yet.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                videos.forEach(video => {
                    tableHtml += `
                        <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                            <td class="p-4 font-semibold">${video.title}</td>
                            <td class="p-4">${video.category}</td>
                            <td class="p-4 text-accent-green">${video.watchDuration ? Math.floor(video.watchDuration * POINTS_PER_SECOND).toLocaleString() : 'N/A'} PTS</td>
                            <td class="p-4 whitespace-nowrap">
                                <button class="edit-video-btn px-3 py-1 bg-primary hover:bg-indigo-600 rounded-lg text-white text-xs font-semibold mr-2" data-video-id="${video.id}">Edit</button>
                                <button class="delete-video-btn px-3 py-1 bg-red-600 hover:bg-red-500 rounded-lg text-white text-xs font-semibold" data-video-id="${video.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                videoTableBody.innerHTML = tableHtml;
                attachVideoManagementListeners();
            }
            
             // Function to render the table for managing social tasks (Admin view)
            function renderManageSocialTasksTable() {
                if (!socialTaskTableBody) return;
                
                if (socialTasks.length === 0) {
                    socialTaskTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-muted-text">No social tasks added yet.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                socialTasks.forEach(task => {
                    tableHtml += `
                        <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                            <td class="p-4 font-semibold">${task.title}</td>
                            <td class="p-4">${task.platform}</td>
                            <td class="p-4 text-sm break-all"><a href="${task.link}" target="_blank" class="text-primary hover:underline">${task.link.substring(0, 40)}...</a></td>
                            <td class="p-4 text-accent-green">${task.points.toLocaleString()} PTS</td>
                            <td class="p-4 whitespace-nowrap">
                                <button class="edit-social-task-btn px-3 py-1 bg-primary hover:bg-indigo-600 rounded-lg text-white text-xs font-semibold mr-2" data-task-id="${task.id}">Edit</button>
                                <button class="delete-social-task-btn px-3 py-1 bg-red-600 hover:bg-red-500 rounded-lg text-white text-xs font-semibold" data-task-id="${task.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                socialTaskTableBody.innerHTML = tableHtml;
                attachSocialTaskManagementListeners();
            }

            function updatePointsDisplay() {
                if (!userData) return;
                const points = userData.points || 0;
                const earnings = points / 5000;
                
                if (totalPointsValue) totalPointsValue.textContent = points.toLocaleString();
                if (estimatedEarningsValue) estimatedEarningsValue.textContent = `$${earnings.toFixed(2)}`;
                if (videosWatchedValue) videosWatchedValue.textContent = (userData.watchedVideos?.length || 0).toLocaleString();
                
                // Update header display if it exists (for non-guest mode)
                const headerPointsDisplay = document.getElementById('user-points-display');
                if (headerPointsDisplay) {
                     headerPointsDisplay.textContent = `${points.toLocaleString()} PTS`;
                     const headerEarningsDisplay = headerPointsDisplay.nextElementSibling;
                     if (headerEarningsDisplay) {
                         headerEarningsDisplay.textContent = `$${earnings.toFixed(2)}`;
                     }
                }
            }

            function renderPointsHistoryTable() {
                if (!pointsHistoryTableBody) return;
                if (!userData || !userData.pointsHistory || userData.pointsHistory.length === 0) {
                    pointsHistoryTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-muted-text">No points history yet. Start watching videos!</td></tr>`;
                    return;
                }

                // Sort history by date (newest first - assuming date is in a sortable format or sorting manually)
                const sortedHistory = [...userData.pointsHistory].reverse(); 

                let tableHtml = '';
                sortedHistory.forEach(entry => {
                    const pointClass = entry.points >= 0 ? 'text-accent-green' : 'text-red-400';
                    const sign = entry.points > 0 ? '+' : '';
                    tableHtml += `
                        <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                            <td class="p-4 text-sm whitespace-nowrap">${entry.date}</td>
                            <td class="p-4">${entry.description}</td>
                            <td class="p-4 text-lg font-bold ${pointClass} whitespace-nowrap">${sign}${entry.points.toLocaleString()}</td>
                        </tr>
                    `;
                });
                pointsHistoryTableBody.innerHTML = tableHtml;
            }

            function renderInviteAndEarnView(isGuest) {
                if (isGuest) {
                    document.getElementById('invite-and-earn-view').innerHTML = getGuestViewHtml('Invite & Earn', 'start inviting friends', 'start inviting friends.');
                    return;
                }

                const currentUserId = userId;
                const referralCode = currentUserId || 'N/A';
                const referralLink = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;

                referralCodeInput.value = referralCode;
                referralLinkInput.value = referralLink;

                const invitedUsers = userData?.invitedUsers || [];
                if (invitedUsers.length === 0) {
                    invitedUsersTable.innerHTML = `<tr><td colspan="2" class="p-2 text-center text-muted-text">·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã</td></tr>`;
                } else {
                    let tableHtml = '';
                    invitedUsers.forEach(user => {
                         // FIX 1: Display user name, falling back to a truncated ID
                        const displayId = user.name || (user.id ? user.id.substring(0, 8) + '...' : 'Unknown User');
                        tableHtml += `
                            <tr class="hover:bg-slate-700/50 transition-colors duration-150">
                                <td class="p-2 text-sm font-mono break-all">${displayId}</td>
                                <td class="p-2 text-accent-green font-semibold whitespace-nowrap">+${user.points} PTS</td>
                            </tr>
                        `;
                    });
                    invitedUsersTable.innerHTML = tableHtml;
                }
            }
            
            // --- Event Listeners ---

            // Navigation listener
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const targetId = e.currentTarget.getAttribute('data-target');
                    const isUserRestricted = e.currentTarget.classList.contains('user-link') && (currentUser?.role === 'admin');
                    const isAdminRestricted = !e.currentTarget.classList.contains('user-link') && (currentUser?.role !== 'admin');
                    const isGuestRestricted = ['points-history-view', 'invite-and-earn-view'].includes(targetId) && (currentUser?.role === 'guest');

                    if (isUserRestricted) {
                        alertMessage('Admin Access Only', 'You must be an Admin to access this view.');
                        return;
                    }
                    if (isAdminRestricted) {
                         alertMessage('User Access Only', 'You must be a Regular User to access this view.');
                         return;
                    }
                    if (isGuestRestricted) {
                        // For restricted pages, use the special guest HTML block
                        showView(targetId);
                        const activeView = document.getElementById(targetId);
                        if (activeView) {
                             let title = '';
                             let action = '';
                             let message = '';
                             if (targetId === 'points-history-view') {
                                 title = 'Points History';
                                 action = 'view your points and history';
                                 message = 'view your points history.';
                             } else if (targetId === 'invite-and-earn-view') {
                                 title = 'Invite & Earn';
                                 action = 'start inviting friends';
                                 message = 'start inviting friends.';
                             }
                             activeView.innerHTML = getGuestViewHtml(title, action, message);
                        }
                        return;
                    }

                    showView(targetId);

                    // Additional content refresh for specific views
                    if (targetId === 'watch-videos-view') {
                        const activeFilterBtn = document.querySelector('#watch-videos-view .filter-btn.active');
                        const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                        renderVideoGrid(category, searchBar.value, currentUser?.role === 'guest');
                    } else if (targetId === 'social-tasks-view') {
                        renderSocialTasksGrid(currentUser?.role === 'guest');
                    } else if (targetId === 'points-history-view') {
                        renderPointsHistoryTable();
                    } else if (targetId === 'manage-videos-view') {
                        renderManageVideosTable(); // Now triggered on view load and by snapshot
                    } else if (targetId === 'manage-social-tasks-view') {
                        renderManageSocialTasksTable(); // Now triggered on view load and by snapshot
                    } else if (targetId === 'manage-users-view') {
                        fetchAllUsers();
                    } else if (targetId === 'admin-dashboard-view') {
                        fetchAdminDashboardData();
                        generateRandomChartData();
                    } else if (targetId === 'invite-and-earn-view') {
                        renderInviteAndEarnView(currentUser?.role === 'guest');
                    }

                    // Close sidebar on mobile after navigation
                    if (sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                        backdrop.classList.remove('open');
                        document.body.classList.remove('no-scroll');
                    }
                });
            });

            // Google Sign In
            if (googleSignInBtn) {
                 googleSignInBtn.addEventListener('click', async () => {
                    showLoading();
                    const provider = new GoogleAuthProvider();
                    try {
                        // Check for referral code before sign in pop-up
                        const urlParams = new URLSearchParams(window.location.search);
                        const referrerId = urlParams.get('ref');

                        const result = await signInWithPopup(auth, provider);
                        const user = result.user;
                        console.log("User signed in with Google:", user.uid);
                        
                        // If there was a referral code, redirect to the app root without the query parameter
                        if (referrerId) {
                            window.location.href = window.location.origin + window.location.pathname;
                        } else {
                            // Proceed normally, onAuthStateChanged handles UI update and data seeding
                        }

                    } catch (error) {
                        console.error("Google Sign-In Error:", error);
                        if (loginMessage) {
                            loginMessage.textContent = 'Sign-in failed. Please try again.';
                            loginMessage.style.display = 'block';
                        }
                        hideLoading();
                    }
                });
            }

            // Authentication state listener
            onAuthStateChanged(auth, async (user) => {
                showLoading();
                const wasInitialLoad = isInitialUILoad; // Capture the state before updating it

                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    
                    // 1. Seed data and check referral on first sign-in/first load for new user
                    await seedInitialData(user);
                    
                    // 2. Fetch/listen to user-specific data
                    await fetchUserData(user.uid); 

                    // 3. Setup listeners for public data (if not done yet, or if it was a guest mode initial load)
                    if (wasInitialLoad) {
                         setupPublicDataListeners(false); // Change to non-guest
                    } else if (currentUser?.role !== 'admin' && !document.querySelector('.user-link.active')) {
                        // If switching from admin to user or vice versa during the session, re-render the view
                        updateUI(currentUser.role);
                        setupPublicDataListeners(currentUser.role === 'guest');
                    }
                    
                } else {
                    // No user is signed in. This is the pure Guest Mode.
                    currentUser = { name: 'Guest', email: 'Login to Earn', role: 'guest' };
                    // Set mock userData for display purposes in guest mode
                    userData = { points: 0, watchedVideos: [], pointsHistory: [], payoutHistory: [], videoCooldowns: [] }; 
                    userId = null;
                    isAuthReady = true;

                    // 1. Setup listeners for public data (if not done yet)
                    if (wasInitialLoad) {
                         setupPublicDataListeners(true);
                         updateUI('guest'); // Manually call UI update for guest
                    } else if (!document.querySelector('.nav-link.active')) {
                        // If the user signed out, show dashboard and update UI
                         updateUI('guest');
                         showView('user-dashboard-view');
                    }
                }

                if (wasInitialLoad && userId === null) {
                    isInitialUILoad = false; // Set this flag off after the first full Guest load
                }
                
                // Ensure the app view is shown and login is hidden for both logged-in users and guests
                if (loginPage) loginPage.style.display = 'none';
                if (appContainer) appContainer.style.display = 'flex';

                hideLoading();
            });

            // Video card click listener
            function attachVideoCardListeners(isGuest) {
                document.querySelectorAll('.video-clickable').forEach(card => {
                    // Re-attaching events requires careful handling to prevent duplicates if the grid re-renders, 
                    // but since the grid content is completely replaced, simple attachment works here.
                    card.onclick = (e) => {
                         const videoId = card.getAttribute('data-video-id');
                         const videoUrl = card.getAttribute('data-video-url');
                         const maxDuration = parseInt(card.getAttribute('data-max-duration'), 10);
                         
                         if (isGuest) {
                              alertMessage('Login Required', 'Please sign in with Google to watch videos and earn points.');
                              return;
                         }

                         // Do not allow click if on cooldown (handled by pointer-events-none, but double check)
                         if (card.classList.contains('cursor-not-allowed')) {
                             // This should not happen due to the CSS class, but is a safe guard.
                             const status = getCooldownStatus(videoId);
                             alertMessage('Cooldown Active', `This video is on cooldown and will be available again in about ${Math.ceil(status.remainingTime / (1000 * 60 * 60))} hours.`);
                             return;
                         }

                         const videoData = videos.find(v => v.id === videoId);
                         if (!videoData) return;

                         // Start playing the video
                         playVideo(videoData, maxDuration);
                    };
                });
            }
            
            // Social Task Button Listener
            function attachSocialTaskListeners(isGuest) {
                document.querySelectorAll('.complete-task-btn').forEach(button => {
                     // Ensure listeners are fresh or prevent duplicates if the grid is re-rendered
                     const oldButton = button.cloneNode(true);
                     button.parentNode.replaceChild(oldButton, button);
                     const newButton = oldButton;
                     
                     if (newButton.hasAttribute('disabled')) return; // Skip if already disabled (completed or guest)

                     newButton.addEventListener('click', async (e) => {
                         const taskId = e.currentTarget.getAttribute('data-task-id');
                         const taskLink = e.currentTarget.getAttribute('data-task-link');
                         const taskData = socialTasks.find(t => t.id === taskId);

                         if (isGuest) {
                             alertMessage('Login Required', 'Please sign in with Google to complete tasks and earn points.');
                             return;
                         }

                         if (!taskData) {
                              alertMessage('Error', 'Task not found.');
                              return;
                         }

                         // Open task link in a new tab
                         window.open(taskLink, '_blank');

                         // Ask for confirmation (using custom modal instead of built-in alert/confirm)
                         showDeleteConfirmModal(`Confirm Task Completion: ${taskData.title}`, 'Did you complete this task in the new tab? You will receive ' + taskData.points + ' points.', async (confirm) => {
                            if (confirm) {
                                // Award points and mark as completed
                                await updatePointsInFirestore(
                                    taskData.points, 
                                    `Completed social task: ${taskData.title}`, 
                                    taskId, 
                                    'social'
                                );
                                // Update UI relies on onSnapshot to re-render the grid
                                alertMessage('Success!', `${taskData.points} points awarded for completing the task.`);
                            } else {
                                alertMessage('Task Cancelled', 'Please complete the task to earn points.');
                            }
                         }, 'Yes, I Completed It!', 'No, Not Yet');
                     });
                });
            }

            // Function to handle video playback and points logic
            function playVideo(video, maxDuration) {
                showView('video-player-view');
                videoPlayerTitle.textContent = video.title;
                videoPlayerDescription.textContent = video.description;
                
                // Set up the iframe source (includes autoplay=1)
                const { embedUrl } = getYouTubeId(video.videoUrl);
                videoIframe.src = embedUrl;

                // Reset session state
                currentVideoId = video.id;
                sessionWatchTime = 0;
                sessionPoints = 0;
                
                // Show floating tracker
                circularPointsTracker.classList.remove('hidden');
                
                // Set initial progress value to maximum duration for display
                progressTimeRemaining.textContent = `${maxDuration}s`;
                // Set initial state to 0% (full gray circle)
                progressCircle.style.background = `conic-gradient(#f59e0b 0deg, #1e293b 0deg)`;

                // Start the watch interval (runs every 1 second)
                if (watchInterval) clearInterval(watchInterval); // Clear any existing interval

                let lastMinuteEarned = 0; // Initialize a local tracker for minute-based earning

                watchInterval = setInterval(async () => { // Changed to async to support applyVideoCooldown call
                    sessionWatchTime++;
                    const remainingTime = maxDuration - sessionWatchTime;
                    
                    // Calculate earned points for this second (1/60th of a point)
                    const pointsThisSecond = POINTS_PER_SECOND;
                    sessionPoints += pointsThisSecond;

                    // --- START MODIFICATION FOR 60-SECOND CIRCULAR PROGRESS ---
                    
                    // 1. Calculate time elapsed within the current 60-second cycle
                    const progressInMinute = sessionWatchTime % 60;
                    
                    // 2. Calculate the progress percentage for the current 60-second cycle (0 to 100)
                    const progressPercentagePerMinute = (progressInMinute / 60) * 100;

                    // 3. Update UI (Progress Circle) based on the 60-second cycle
                    // Use progressPercentagePerMinute * 3.6 to convert to degrees (360/100 = 3.6)
                    progressCircle.style.background = `conic-gradient(#f59e0b ${progressPercentagePerMinute * 3.6}deg, #1e293b ${progressPercentagePerMinute * 3.6}deg)`;
                    
                    // --- END MODIFICATION ---
                    
                    // Update time remaining display (still shows overall remaining earning time)
                    progressTimeRemaining.textContent = `${Math.max(0, remainingTime)}s`;

                    // If full minute has passed and points earned > 0, save to Firestore
                    const currentMinute = Math.floor(sessionWatchTime / 60);
                    if (currentMinute > lastMinuteEarned && sessionWatchTime <= maxDuration) {
                        const pointsToSave = 60 * POINTS_PER_SECOND; // Always 1 point
                        updatePointsInFirestore(
                            pointsToSave, 
                            `Watched video: "${video.title}" (+60s)`, 
                            video.id, 
                            'video'
                        );
                        lastMinuteEarned = currentMinute; // Update local tracker
                        console.log(`Earned ${pointsToSave} points. Total session time: ${sessionWatchTime}s`);
                    }


                    // End condition: Max duration reached
                    if (sessionWatchTime >= maxDuration) {
                        console.log(`Max duration of ${maxDuration}s reached for video: ${video.id}. Applying cooldown and exiting.`);
                        
                        // Call applyVideoCooldown directly if >= 60s (which maxDuration guarantees)
                        if (maxDuration >= 60) {
                            await applyVideoCooldown(video.id);
                        }

                        handlePlayerExit(true); // true = isAutoExit

                        clearInterval(watchInterval);
                    }
                }, 1000);
            }

            // Video player exit button
            if (videoPlayerBackBtn) {
                 videoPlayerBackBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Manually exiting the player
                    handlePlayerExit(false); // false = isAutoExit (manual exit)
                 });
            }

            // Video search and filter listeners
            if (searchBar) {
                searchBar.addEventListener('input', (e) => {
                    const activeFilterBtn = document.querySelector('#watch-videos-view .filter-btn.active');
                    const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                    renderVideoGrid(category, searchBar.value, currentUser?.role === 'guest');
                });
            }

            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    filterButtons.forEach(f => f.classList.remove('active', 'bg-primary', 'border-primary', 'bg-card-bg'));
                    filterButtons.forEach(f => {
                         if (!f.classList.contains('active')) {
                             f.classList.add('bg-card-bg', 'border-slate-700');
                         }
                    });

                    e.currentTarget.classList.add('active', 'bg-primary', 'border-primary');
                    e.currentTarget.classList.remove('bg-card-bg', 'border-slate-700');

                    const category = e.currentTarget.getAttribute('data-category');
                    renderVideoGrid(category, searchBar.value, currentUser?.role === 'guest');
                });
            });

            // Cash out button handler
            if (cashoutBtn) {
                cashoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!userData || !userId || currentUser?.role === 'guest') {
                         alertMessage('Login Required', 'Please sign in to cash out your points.');
                         return;
                    }
                    
                    const minPoints = 5000;
                    if ((userData.points || 0) < minPoints) {
                        alertMessage('Cash Out Not Ready', `You need ${minPoints.toLocaleString()} points to cash out ($${(minPoints / 5000).toFixed(2)}). You currently have ${userData.points.toLocaleString()} points.`);
                        return;
                    }

                    const earnings = (userData.points || 0) / 5000;
                    document.getElementById('payout-amount').value = earnings.toFixed(2);
                    showModal(cashoutModal);
                });
            }

            // Cash out form submission
            if (cashoutForm) {
                cashoutForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading();

                    const method = document.getElementById('payment-method').value;
                    const amount = parseFloat(document.getElementById('payout-amount').value);
                    const pointsToDeduct = amount * 5000;

                    if (pointsToDeduct > (userData.points || 0)) {
                        alertMessage('Error', 'Insufficient points. Please refresh and try again.');
                        hideLoading();
                        return;
                    }

                    try {
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                        
                        // Deduct points and update payout history
                        await updateDoc(userDocRef, {
                            points: (userData.points || 0) - pointsToDeduct,
                            payoutHistory: arrayUnion({
                                date: new Date().toLocaleDateString('en-US'),
                                amount: amount,
                                method: method,
                                status: 'Pending'
                            }),
                            // Also add a negative entry to points history
                            pointsHistory: arrayUnion({
                                date: new Date().toLocaleDateString('en-US'),
                                description: `Cash Out Request (${method})`,
                                points: -pointsToDeduct
                            })
                        });

                        hideModal(cashoutModal);
                        alertMessage('Cash Out Success', `Your request for $${amount.toFixed(2)} via ${method} has been submitted. It will be processed soon!`);

                    } catch (error) {
                        console.error("Error processing cash out:", error);
                        alertMessage('Error', 'Failed to submit cash out request. Please try again.');
                    } finally {
                        hideLoading();
                    }
                });
            }

            // --- Referral Code/Link Handlers ---
            if (copyReferralBtn) {
                copyReferralBtn.addEventListener('click', () => {
                    const textToCopy = referralCodeInput ? referralCodeInput.value : '';
                    if (textToCopy) {
                         // Use document.execCommand('copy') for better iframe compatibility
                        const tempInput = document.createElement('input');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showCopyStatus('·ÄÄ·ÄØ·Äí·Ä∫·ÄÄ·Ä∞·Ä∏·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã');
                    }
                });
            }

            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => {
                     const textToCopy = referralLinkInput ? referralLinkInput.value : '';
                    if (textToCopy) {
                         // Use document.execCommand('copy') for better iframe compatibility
                        const tempInput = document.createElement('input');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showCopyStatus('·Äú·ÄÑ·Ä∑·Ä∫·ÄÄ·Ä∞·Ä∏·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã');
                    }
                });
            }

            function showCopyStatus(message) {
                 if (copyStatus) {
                      copyStatus.textContent = message;
                      copyStatus.style.display = 'block';
                      setTimeout(() => {
                           copyStatus.style.display = 'none';
                      }, 2000);
                 }
            }

            // --- Admin Management Listeners (CRUD) ---

            // Video Management Listeners
            if (addVideoBtn) {
                 addVideoBtn.addEventListener('click', () => showAddEditVideoModal(null));
            }
            
            function attachVideoManagementListeners() {
                // Edit Video
                document.querySelectorAll('.edit-video-btn').forEach(btn => {
                    btn.onclick = () => {
                        const videoId = btn.getAttribute('data-video-id');
                        showAddEditVideoModal(videoId);
                    };
                });
                // Delete Video
                document.querySelectorAll('.delete-video-btn').forEach(btn => {
                    btn.onclick = () => {
                        const videoId = btn.getAttribute('data-video-id');
                        const video = videos.find(v => v.id === videoId);
                        showDeleteConfirmModal(`Delete Video: ${video.title}`, 'Are you sure you want to permanently delete this video?', (confirm) => {
                            if (confirm) deleteVideo(videoId);
                        });
                    };
                });
            }
            
            // Social Task Management Listeners
            if (addSocialTaskBtn) {
                 addSocialTaskBtn.addEventListener('click', () => showAddEditSocialTaskModal(null));
            }

            function attachSocialTaskManagementListeners() {
                // Edit Task
                document.querySelectorAll('.edit-social-task-btn').forEach(btn => {
                    btn.onclick = () => {
                        const taskId = btn.getAttribute('data-task-id');
                        showAddEditSocialTaskModal(taskId);
                    };
                });
                // Delete Task
                document.querySelectorAll('.delete-social-task-btn').forEach(btn => {
                    btn.onclick = () => {
                        const taskId = btn.getAttribute('data-task-id');
                        const task = socialTasks.find(t => t.id === taskId);
                        showDeleteConfirmModal(`Delete Task: ${task.title}`, 'Are you sure you want to permanently delete this social task?', (confirm) => {
                            if (confirm) deleteSocialTask(taskId);
                        });
                    };
                });
            }

            // User Management Listeners
            function attachUserTableListeners() {
                 document.querySelectorAll('.toggle-role-btn').forEach(btn => {
                     // Need to clone and replace to ensure the listener is correctly attached to the dynamic content
                     const oldBtn = btn.cloneNode(true);
                     btn.parentNode.replaceChild(oldBtn, btn);
                     const newBtn = oldBtn;

                     newBtn.addEventListener('click', (e) => {
                         const targetUserId = e.currentTarget.getAttribute('data-user-id');
                         const currentRole = e.currentTarget.getAttribute('data-current-role');
                         
                         showDeleteConfirmModal(`Change Role for ${targetUserId}`, `Are you sure you want to change this user's role to ${currentRole === 'admin' ? 'User' : 'Admin'}?`, (confirm) => {
                             if (confirm) toggleUserRole(targetUserId, currentRole);
                         }, 'Yes, Change Role');
                     });
                 });
                 
                 document.querySelectorAll('.view-history-btn').forEach(btn => {
                      btn.onclick = async (e) => {
                          const targetUserId = e.currentTarget.getAttribute('data-user-id');
                          const userName = e.currentTarget.getAttribute('data-user-name');
                          await showUserHistoryModal(targetUserId, userName);
                      };
                 });
            }

            // Admin Payouts Card Listener
            if (adminPayoutsCard) {
                adminPayoutsCard.addEventListener('click', async () => {
                    await showPayoutHistoryModal();
                });
            }

            // --- Modal Helpers ---

            function showModal(modalElement) {
                if (modalElement) {
                    modalElement.classList.remove('hidden');
                    document.body.classList.add('no-scroll');
                }
            }

            function hideModal(modalElement) {
                if (modalElement) {
                    modalElement.classList.add('hidden');
                    document.body.classList.remove('no-scroll');
                }
            }
            
            function alertMessage(title, message, isSuccess = true) {
                 if (cashoutMessageModal && cashoutMessageText) {
                    cashoutMessageModal.querySelector('h3').textContent = title;
                    cashoutMessageText.textContent = message;
                    
                    if (isSuccess) {
                        cashoutMessageText.classList.remove('text-red-400');
                        cashoutMessageText.classList.add('text-muted-text');
                    } else {
                        cashoutMessageText.classList.add('text-red-400');
                        cashoutMessageText.classList.remove('text-muted-text');
                    }
                    showModal(cashoutMessageModal);
                 } else {
                     console.log(`ALERT: ${title} - ${message}`);
                 }
            }
            
            if (cashoutMessageCloseBtn) {
                 cashoutMessageCloseBtn.addEventListener('click', () => hideModal(cashoutMessageModal));
            }

            // Generic Delete/Confirm Modal
            let confirmCallback = null;
            function showDeleteConfirmModal(title, message, callback, confirmText = 'Yes, Delete', cancelText = 'Cancel') {
                deleteModalTitle.textContent = title;
                deleteConfirmModal.querySelector('p').textContent = message;
                deleteConfirmBtn.textContent = confirmText;
                deleteConfirmModal.querySelector('.cancel-btn').textContent = cancelText;

                confirmCallback = callback;
                showModal(deleteConfirmModal);
            }

            deleteConfirmBtn.onclick = () => {
                if (confirmCallback) confirmCallback(true);
                hideModal(deleteConfirmModal);
            };

            deleteConfirmModal.querySelector('.cancel-btn').onclick = () => {
                if (confirmCallback) confirmCallback(false);
                hideModal(deleteConfirmModal);
            };

            // Video Modal Logic
            function showAddEditVideoModal(videoId) {
                const isEdit = videoId !== null;
                addModalTitle.textContent = isEdit ? 'Edit Video' : 'Add New Video';
                addVideoForm.reset();

                if (isEdit) {
                    const video = videos.find(v => v.id === videoId);
                    if (video) {
                        document.getElementById('video-title').value = video.title || '';
                        document.getElementById('video-description').value = video.description || '';
                        document.getElementById('video-category').value = video.category || 'YouTube';
                        document.getElementById('video-url').value = video.videoUrl || '';
                        document.getElementById('video-points').value = video.points || '';
                        document.getElementById('watch-duration').value = video.watchDuration || '';
                    }
                }

                // Remove old listeners and re-attach the submit handler with the correct ID context
                const oldForm = addVideoForm.cloneNode(true);
                addVideoForm.parentNode.replaceChild(oldForm, addVideoForm);
                const newForm = oldForm;
                
                newForm.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    // Input validation (duration must be > 0 and a number)
                    const watchDuration = parseInt(document.getElementById('watch-duration').value, 10);
                    if (isNaN(watchDuration) || watchDuration <= 0) {
                         alertMessage('Invalid Duration', 'Watch Duration (Seconds) must be a positive number.', false);
                         return;
                    }
                    
                    const formData = {
                        title: document.getElementById('video-title').value,
                        description: document.getElementById('video-description').value,
                        category: document.getElementById('video-category').value,
                        videoUrl: document.getElementById('video-url').value,
                        points: parseInt(document.getElementById('video-points').value) || 0, // Legacy field
                        watchDuration: watchDuration
                    };
                    await saveVideo(formData, videoId);
                    hideModal(addVideoModal);
                };

                newForm.querySelector('.cancel-btn').onclick = () => hideModal(addVideoModal);

                showModal(addVideoModal);
            }

            // Social Task Modal Logic
            function showAddEditSocialTaskModal(taskId) {
                const isEdit = taskId !== null;
                socialTaskModalTitle.textContent = isEdit ? 'Edit Social Task' : 'Add New Social Task';
                addSocialTaskForm.reset();

                if (isEdit) {
                    const task = socialTasks.find(t => t.id === taskId);
                    if (task) {
                        document.getElementById('social-task-title').value = task.title || '';
                        document.getElementById('social-task-platform').value = task.platform || 'YouTube';
                        document.getElementById('social-task-link').value = task.link || '';
                        document.getElementById('social-task-points').value = task.points || '';
                    }
                }

                // Remove old listeners and re-attach the submit handler with the correct ID context
                const oldForm = addSocialTaskForm.cloneNode(true);
                addSocialTaskForm.parentNode.replaceChild(oldForm, addSocialTaskForm);
                const newForm = oldForm;
                
                newForm.onsubmit = async (e) => {
                    e.preventDefault();

                    const points = parseInt(document.getElementById('social-task-points').value, 10);
                    if (isNaN(points) || points <= 0) {
                        alertMessage('Invalid Points', 'Points must be a positive number.', false);
                        return;
                    }

                    const formData = {
                        title: document.getElementById('social-task-title').value,
                        platform: document.getElementById('social-task-platform').value,
                        link: document.getElementById('social-task-link').value,
                        points: points
                    };
                    await saveSocialTask(formData, taskId);
                    hideModal(addSocialTaskModal);
                };

                newForm.querySelector('.cancel-btn').onclick = () => hideModal(addSocialTaskModal);

                showModal(addSocialTaskModal);
            }
            
            // --- History Modals ---

            async function showUserHistoryModal(targetUserId, userName) {
                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                    const docSnap = await getDoc(userDocRef);

                    if (!docSnap.exists()) {
                         alertMessage('Error', 'User data not found.', false);
                         return;
                    }
                    const userHistoryData = docSnap.data();
                    const history = userHistoryData.pointsHistory || [];
                    
                    historyModalTitle.textContent = `Points History for ${userName}`;
                    historyTableHeader.innerHTML = `
                        <th class="p-4 rounded-tl-lg">Date</th>
                        <th class="p-4">Description</th>
                        <th class="p-4 rounded-tr-lg">Points</th>
                    `;
                    
                    if (history.length === 0) {
                        historyTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-muted-text">No points history available.</td></tr>`;
                    } else {
                        const sortedHistory = [...history].reverse(); 
                        let tableHtml = '';
                        sortedHistory.forEach(entry => {
                            const pointClass = entry.points >= 0 ? 'text-accent-green' : 'text-red-400';
                            const sign = entry.points > 0 ? '+' : '';
                            tableHtml += `
                                <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                                    <td class="p-4 text-sm whitespace-nowrap">${entry.date}</td>
                                    <td class="p-4">${entry.description}</td>
                                    <td class="p-4 text-lg font-bold ${pointClass} whitespace-nowrap">${sign}${entry.points.toLocaleString()}</td>
                                </tr>
                            `;
                        });
                        historyTableBody.innerHTML = tableHtml;
                    }

                    showModal(historyModal);
                } catch (e) {
                    console.error("Error fetching user history:", e);
                    alertMessage('Error', 'Failed to load history.', false);
                } finally {
                    hideLoading();
                }
            }
            
            async function showPayoutHistoryModal() {
                 showLoading();
                 try {
                     const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                     const querySnapshot = await getDocs(usersCollectionRef);
                     let allPayouts = [];
                     
                     querySnapshot.forEach(doc => {
                         const userData = doc.data();
                         const userId = doc.id;
                         const userName = userData.name || userId;
                         
                         const userPayouts = (userData.payoutHistory || []).map(p => ({
                             ...p,
                             userId: userId,
                             userName: userName
                         }));
                         allPayouts.push(...userPayouts);
                     });

                     historyModalTitle.textContent = `All Payout Requests`;
                     historyTableHeader.innerHTML = `
                         <th class="p-4 rounded-tl-lg">Date</th>
                         <th class="p-4">User</th>
                         <th class="p-4">Method</th>
                         <th class="p-4">Amount ($)</th>
                         <th class="p-4 rounded-tr-lg">Status</th>
                     `;
                     
                     if (allPayouts.length === 0) {
                         historyTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-muted-text">No payout requests found.</td></tr>`;
                     } else {
                         // Sort by date (newest first)
                         allPayouts.sort((a, b) => new Date(b.date) - new Date(a.date));

                         let tableHtml = '';
                         allPayouts.forEach(payout => {
                             const statusClass = payout.status === 'Pending' ? 'text-accent-orange' : 'text-accent-green';
                             tableHtml += `
                                 <tr class="hover:bg-slate-800/50 transition-colors duration-150">
                                     <td class="p-4 text-sm whitespace-nowrap">${payout.date}</td>
                                     <td class="p-4 text-sm break-all">${payout.userName} (${payout.userId.substring(0, 5)}...)</td>
                                     <td class="p-4 text-sm">${payout.method}</td>
                                     <td class="p-4 text-lg font-bold text-accent-green whitespace-nowrap">$${payout.amount.toFixed(2)}</td>
                                     <td class="p-4 text-sm ${statusClass}">${payout.status}</td>
                                 </tr>
                             `;
                         });
                         historyTableBody.innerHTML = tableHtml;
                     }

                     showModal(historyModal);
                 } catch (e) {
                     console.error("Error fetching all payouts:", e);
                     alertMessage('Error', 'Failed to load payout history.', false);
                 } finally {
                     hideLoading();
                 }
            }

            if (historyModalCloseBtn) {
                 historyModalCloseBtn.addEventListener('click', () => hideModal(historyModal));
            }
            
            // --- Misc Listeners ---
            
            // Scroll To Top Button Logic
            if (appContent && scrollToTopBtn) {
                appContent.addEventListener('scroll', () => {
                    if (document.getElementById('watch-videos-view').style.display === 'block') {
                        if (appContent.scrollTop > 300) {
                            scrollToTopBtn.classList.remove('hidden');
                        } else {
                            scrollToTopBtn.classList.add('hidden');
                        }
                    }
                });

                scrollToTopBtn.addEventListener('click', () => {
                    appContent.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }

            // --- LLM Summary Function ---
            if (getSummaryBtn) {
                getSummaryBtn.addEventListener('click', async () => {
                    if (!currentVideoId || !videoIframe.src) {
                        summaryOutput.textContent = 'Please start a video first.';
                        return;
                    }
                    
                    // Display loading indicator
                    summaryOutput.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent inline-block mr-2"></div> Fetching summary...`;
                    getSummaryBtn.disabled = true;

                    // This is a placeholder for LLM API call since we don't have video content, 
                    // we will use the video title and description as the prompt base.
                    const videoTitle = videoPlayerTitle.textContent;
                    const videoDesc = videoPlayerDescription.textContent;
                    const userPrompt = `Summarize the topic and main points of this video titled "${videoTitle}" (Description: ${videoDesc}). Keep the summary short (max 50 words).`;
                    
                    const systemPrompt = "You are a concise video summarization AI. Provide a brief, single-paragraph summary of the content provided by the user (video title and description).";
                    const apiKey = "" // Leave as is for Canvas runtime injection

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        // Optional: Setting a low max output length to enforce brevity
                        config: {
                             maxOutputTokens: 50
                        }
                    };
                    
                    let attempts = 0;
                    const maxRetries = 3;
                    let lastError = null;

                    while (attempts < maxRetries) {
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                throw new Error(`API returned status ${response.status}`);
                            }

                            const result = await response.json();
                            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                            if (generatedText) {
                                summaryOutput.textContent = `Summary: ${generatedText.trim()}`;
                                getSummaryBtn.disabled = false;
                                return; // Success, exit loop
                            } else {
                                throw new Error("Generated content was empty or malformed.");
                            }
                        } catch (error) {
                            lastError = error;
                            attempts++;
                            console.warn(`LLM call attempt ${attempts} failed: ${error.message}. Retrying...`);
                            if (attempts < maxRetries) {
                                // Exponential backoff: 1s, 2s, 4s
                                const delay = Math.pow(2, attempts) * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                            }
                        }
                    }

                    // If all retries fail
                    summaryOutput.textContent = `Summary failed to generate. Error: ${lastError ? lastError.message : 'Unknown API error.'}`;
                    getSummaryBtn.disabled = false;
                });
            }

        });
           
       
    </script>
</body>

</html>
