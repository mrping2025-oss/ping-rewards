<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Rewards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',
                        'background': '#0f172a',
                        'card-bg': '#1e293b',
                        'text-color': '#e2e8f0',
                        'accent-green': '#10b981',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; overflow-x: hidden; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.open { transform: translateX(0); }
        .backdrop.open { display: block; }
        #app-content { overflow-y: auto; height: 100vh; }
        .modal { background-color: rgba(0,0,0,0.8); }
    </style>
</head>

<body class="bg-background text-text-color">

    <!-- App Container -->
    <div id="app-container" class="flex flex-col md:flex-row w-full min-h-screen">
        
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar fixed md:relative z-[100] md:z-0 top-0 left-0 w-64 h-full bg-card-bg shadow-lg transform -translate-x-full md:translate-x-0">
            <div class="p-6 pb-4 border-b border-slate-700 flex items-center">
                <span class="text-xl font-bold ml-2">Ping Rewards</span>
            </div>
            <ul class="flex flex-col p-4 space-y-2">
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="user-dashboard-view">Dashboard</a></li>
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="watch-videos-view">Watch Videos</a></li>
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="social-tasks-view">Social Tasks</a></li>
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="points-history-view">Points History</a></li>
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="invite-and-earn-view">Invite & Earn</a></li>
                <li><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20" data-target="about-view">About</a></li>
                
                <!-- Admin Links -->
                <hr class="my-4 border-slate-700 admin-link" style="display: none;">
                <li class="admin-link" style="display: none;"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 text-yellow-400" data-target="admin-dashboard-view">Admin Dashboard</a></li>
                <li class="admin-link" style="display: none;"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 text-yellow-400" data-target="manage-videos-view">Manage Videos</a></li>
                <li class="admin-link" style="display: none;"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-primary/20 text-yellow-400" data-target="manage-tasks-view">Manage Tasks</a></li>
            </ul>
        </div>

        <div id="backdrop" class="backdrop fixed inset-0 bg-black bg-opacity-50 z-[99] hidden md:hidden"></div>

        <!-- Main Content -->
        <div id="app-content" class="flex-grow p-4 md:p-6 transition-all duration-300 ease-in-out">
            <!-- Header -->
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                    <button id="menu-toggle" class="md:hidden p-2 mr-3 rounded-md bg-slate-700 text-white hover:bg-slate-600">
                        <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </button>
                    <span id="page-title">Dashboard</span>
                </h1>
            </header>

            <!-- 1. User Dashboard -->
            <div id="user-dashboard-view" class="content-view">
                <div class="bg-yellow-400 text-black p-2 rounded mb-4 font-bold text-center">
                     Please read 'About' for rules first!
                </div>
                <h2 id="welcome-message" class="text-xl font-semibold mb-4">Welcome!</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                    <div class="bg-card-bg p-6 rounded-xl border border-slate-700">
                        <h2 class="text-muted-text">Total Points</h2>
                        <div class="text-4xl font-bold text-primary" id="total-points-value">0</div>
                    </div>
                </div>
            </div>

            <!-- 2. Watch Videos -->
            <div id="watch-videos-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="video-grid">
                    <p class="text-muted-text">Loading videos...</p>
                </div>
            </div>

            <!-- 3. Video Player -->
            <div id="video-player-view" class="content-view" style="display: none;">
                <button id="video-player-back-btn" class="mb-4 bg-primary px-4 py-2 rounded text-white">Back</button>
                <div class="aspect-video w-full rounded-xl overflow-hidden mb-4 bg-black">
                    <iframe id="video-iframe" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                </div>
                <h2 id="video-player-title" class="text-2xl font-bold"></h2>
            </div>

            <!-- 4. Social Tasks -->
            <div id="social-tasks-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="social-tasks-grid">
                    <p class="text-muted-text">Loading tasks...</p>
                </div>
            </div>

            <!-- 5. Points History -->
            <div id="points-history-view" class="content-view" style="display: none;">
                <table class="w-full text-left table-auto bg-card-bg rounded-lg">
                    <tbody id="points-history-table" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>

            <!-- 6. Invite & Earn -->
            <div id="invite-and-earn-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl border border-slate-700 space-y-4">
                    <label>Referral Link</label>
                    <input type="text" id="referral-link-input" readonly class="w-full bg-slate-700 p-2 rounded text-white">
                </div>
            </div>
            
            <!-- 7. About -->
            <div id="about-view" class="content-view" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">About Ping Rewards</h2>
                <p>Welcome to Ping Rewards.</p>
            </div>

            <!-- ================= ADMIN VIEWS ================= -->

            <!-- 8. ADMIN DASHBOARD -->
            <div id="admin-dashboard-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="bg-card-bg p-6 rounded-xl border border-slate-700">
                        <h3>Total Users</h3>
                        <div class="text-3xl font-bold" id="admin-total-users-value">0</div>
                    </div>
                    <div class="bg-card-bg p-6 rounded-xl border border-slate-700">
                        <h3>Total Videos</h3>
                        <div class="text-3xl font-bold" id="admin-total-videos-value">0</div>
                    </div>
                    <div class="bg-card-bg p-6 rounded-xl border border-slate-700">
                        <h3>Total Points</h3>
                        <div class="text-3xl font-bold" id="admin-total-points-earned-value">0</div>
                    </div>
                </div>
            </div>

            <!-- 9. MANAGE VIDEOS (ADMIN) -->
            <div id="manage-videos-view" class="content-view" style="display: none;">
                <button onclick="document.getElementById('add-video-modal').style.display='flex'" class="mb-4 bg-accent-green px-4 py-2 rounded text-white font-bold">+ Add New Video</button>
                <div id="manage-videos-list" class="space-y-2">Loading...</div>
            </div>

            <!-- 10. MANAGE TASKS (ADMIN) -->
            <div id="manage-tasks-view" class="content-view" style="display: none;">
                <button onclick="document.getElementById('add-task-modal').style.display='flex'" class="mb-4 bg-accent-green px-4 py-2 rounded text-white font-bold">+ Add New Task</button>
                <div id="manage-tasks-list" class="space-y-2">Loading...</div>
            </div>

        </div>
    </div>

    <!-- MODALS (Hidden by default) -->
    <!-- Add Video Modal -->
    <div id="add-video-modal" class="modal fixed inset-0 flex items-center justify-center z-[200] hidden">
        <div class="bg-card-bg p-6 rounded-xl w-96 border border-slate-600">
            <h3 class="text-xl font-bold mb-4">Add Video</h3>
            <input type="text" id="new-video-title" placeholder="Title" class="w-full mb-2 p-2 bg-slate-700 rounded">
            <input type="text" id="new-video-url" placeholder="YouTube URL" class="w-full mb-2 p-2 bg-slate-700 rounded">
            <select id="new-video-cat" class="w-full mb-4 p-2 bg-slate-700 rounded">
                <option value="General">General</option>
                <option value="Gaming">Gaming</option>
                <option value="Music">Music</option>
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('add-video-modal').style.display='none'" class="px-4 py-2 bg-slate-600 rounded">Cancel</button>
                <button onclick="addVideo()" class="px-4 py-2 bg-primary rounded">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="modal fixed inset-0 flex items-center justify-center z-[200] hidden">
        <div class="bg-card-bg p-6 rounded-xl w-96 border border-slate-600">
            <h3 class="text-xl font-bold mb-4">Add Task</h3>
            <input type="text" id="new-task-title" placeholder="Title" class="w-full mb-2 p-2 bg-slate-700 rounded">
            <input type="text" id="new-task-link" placeholder="Link URL" class="w-full mb-2 p-2 bg-slate-700 rounded">
            <input type="number" id="new-task-points" placeholder="Points (e.g. 50)" class="w-full mb-4 p-2 bg-slate-700 rounded">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('add-task-modal').style.display='none'" class="px-4 py-2 bg-slate-600 rounded">Cancel</button>
                <button onclick="addTask()" class="px-4 py-2 bg-primary rounded">Save</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe.user;
        const userId = user ? user.id : "1856743644"; 
        const backendUrl = "https://ping-rewards-bot.mr-ping2025.workers.dev"; 

        tg.expand();

        document.addEventListener("DOMContentLoaded", () => {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    showView(targetId);
                    if(window.innerWidth < 768) {
                       document.getElementById('sidebar').classList.remove('open');
                       document.getElementById('backdrop').classList.remove('open');
                    }
                });
            });

            // Menu Toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('backdrop').classList.add('open');
            });
            document.getElementById('backdrop').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('backdrop').classList.remove('open');
            });

            document.getElementById('video-player-back-btn').addEventListener('click', () => {
                document.getElementById('video-iframe').src = "";
                showView('watch-videos-view');
            });

            initApp();
        });

        function showView(viewId) {
            document.querySelectorAll('.content-view').forEach(v => v.style.display = 'none');
            const target = document.getElementById(viewId);
            if (target) {
                target.style.display = 'block';
                document.getElementById('page-title').innerText = viewId.replace(/-/g, ' ').replace('view', '').toUpperCase();
            }
        }

        async function initApp() {
            try {
                const userRes = await fetch(`${backendUrl}/api/get-user?id=${userId}`);
                const userData = await userRes.json();

                if (userData && !userData.error) {
                    document.getElementById('total-points-value').textContent = userData.points || 0;
                    document.getElementById('welcome-message').textContent = `Welcome, ${userData.name || 'User'}!`;
                    document.getElementById('referral-link-input').value = `https://t.me/PingRewords_bot?start=${userId}`;

                    // --- ADMIN CHECK ---
                    const adminIds = ["1856743644"]; 
                    if (adminIds.includes(String(userId))) {
                        document.querySelectorAll('.admin-link').forEach(el => el.style.display = 'block');
                        loadAdminStats();
                        loadManageVideos(); // Admin Video List
                        loadManageTasks();  // Admin Task List
                    }
                    // -------------------

                    loadVideos();
                    loadTasks();
                    loadHistory();
                    showView('user-dashboard-view');
                } else {
                    alert("Please start the bot first!");
                }
            } catch (err) { console.error("Init Error:", err); }
        }

        async function loadVideos() {
            try {
                const res = await fetch(`${backendUrl}/api/get-videos`);
                const videos = await res.json();
                const grid = document.getElementById('video-grid');
                if(!videos.length) { grid.innerHTML = '<p>No videos found.</p>'; return; }
                grid.innerHTML = videos.map(v => `
                    <div class="bg-card-bg p-4 rounded-xl border border-slate-700 cursor-pointer" onclick="playVideo('${v.video_url}', '${v.title}')">
                        <img src="https://img.youtube.com/vi/${getYouTubeId(v.video_url)}/hqdefault.jpg" class="w-full rounded mb-2">
                        <h3 class="font-bold text-sm text-white">${v.title}</h3>
                        <p class="text-xs text-muted-text">1pt/60s</p>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        async function loadTasks() {
            try {
                const res = await fetch(`${backendUrl}/api/get-tasks`);
                const tasks = await res.json();
                const grid = document.getElementById('social-tasks-grid');
                if(!tasks.length) { grid.innerHTML = '<p>No tasks found.</p>'; return; }
                grid.innerHTML = tasks.map(t => `
                    <div class="bg-card-bg p-6 rounded-xl border border-slate-700 text-center">
                        <h3 class="font-bold text-white">${t.title}</h3>
                        <p class="text-accent-green font-bold my-2">+${t.points} PTS</p>
                        <a href="${t.link}" target="_blank" onclick="completeTask('${t.id}', ${t.points}, '${t.title}')" class="bg-primary px-4 py-2 rounded text-white inline-block">Complete</a>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${backendUrl}/api/get-history?id=${userId}`);
                const history = await res.json();
                const table = document.getElementById('points-history-table');
                table.innerHTML = history.length ? history.map(h => `
                    <tr class="border-b border-slate-700">
                        <td class="p-3 text-xs text-muted-text">${new Date(h.created_at).toLocaleDateString()}</td>
                        <td class="p-3 text-sm text-white">${h.description}</td>
                        <td class="p-3 font-bold text-accent-green">+${h.points}</td>
                    </tr>
                `).join('') : '<tr><td class="p-4 text-center">No history yet.</td></tr>';
            } catch(e) { console.error(e); }
        }

        async function completeTask(id, points, title) {
            await fetch(`${backendUrl}/api/award-points`, {
                method: 'POST',
                body: JSON.stringify({ userId, amount: points, desc: `Task: ${title}` })
            });
            alert("Points added!");
            initApp();
        }

        // --- ADMIN FUNCTIONS ---

        async function loadAdminStats() {
            const res = await fetch(`${backendUrl}/api/get-admin-stats`);
            const data = await res.json();
            if (data) {
                document.getElementById('admin-total-users-value').innerText = data.totalUsers;
                document.getElementById('admin-total-videos-value').innerText = data.totalVideos;
                document.getElementById('admin-total-points-earned-value').innerText = data.totalPoints;
            }
        }

        // Admin: Load Videos List
        async function loadManageVideos() {
            const res = await fetch(`${backendUrl}/api/get-videos`);
            const videos = await res.json();
            const list = document.getElementById('manage-videos-list');
            list.innerHTML = videos.map(v => `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700">
                    <div>
                        <div class="font-bold text-sm">${v.title}</div>
                        <div class="text-xs text-gray-400">${v.category}</div>
                    </div>
                    <button onclick="deleteVideo('${v.id}')" class="text-red-500 font-bold hover:text-red-400">DELETE</button>
                </div>
            `).join('');
        }

        // Admin: Add Video
        async function addVideo() {
            const title = document.getElementById('new-video-title').value;
            const url = document.getElementById('new-video-url').value;
            const category = document.getElementById('new-video-cat').value;
            
            if(!title || !url) return alert("Please fill all fields");

            await fetch(`${backendUrl}/api/add-video`, {
                method: 'POST',
                body: JSON.stringify({ title, video_url: url, category })
            });
            
            document.getElementById('add-video-modal').style.display = 'none';
            alert("Video Added!");
            loadManageVideos(); // Refresh Admin List
            loadVideos();       // Refresh User List
            loadAdminStats();
        }

        // Admin: Delete Video
        async function deleteVideo(id) {
            if(!confirm("Delete this video?")) return;
            await fetch(`${backendUrl}/api/delete-video`, {
                method: 'POST',
                body: JSON.stringify({ id })
            });
            alert("Deleted!");
            loadManageVideos();
            loadVideos();
            loadAdminStats();
        }

        // Admin: Load Tasks List
        async function loadManageTasks() {
            const res = await fetch(`${backendUrl}/api/get-tasks`);
            const tasks = await res.json();
            const list = document.getElementById('manage-tasks-list');
            list.innerHTML = tasks.map(t => `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700">
                    <div>
                        <div class="font-bold text-sm">${t.title}</div>
                        <div class="text-xs text-green-400">${t.points} PTS</div>
                    </div>
                    <button onclick="deleteTask('${t.id}')" class="text-red-500 font-bold hover:text-red-400">DELETE</button>
                </div>
            `).join('');
        }

        // Admin: Add Task
        async function addTask() {
            const title = document.getElementById('new-task-title').value;
            const link = document.getElementById('new-task-link').value;
            const points = document.getElementById('new-task-points').value;

            if(!title || !link || !points) return alert("Please fill all fields");

            await fetch(`${backendUrl}/api/add-task`, {
                method: 'POST',
                body: JSON.stringify({ title, link, points: parseInt(points) })
            });

            document.getElementById('add-task-modal').style.display = 'none';
            alert("Task Added!");
            loadManageTasks();
            loadTasks();
        }

        // Admin: Delete Task
        async function deleteTask(id) {
            if(!confirm("Delete this task?")) return;
            await fetch(`${backendUrl}/api/delete-task`, {
                method: 'POST',
                body: JSON.stringify({ id })
            });
            alert("Deleted!");
            loadManageTasks();
            loadTasks();
        }

        function getYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        window.playVideo = function(url, title) {
            document.getElementById('video-iframe').src = `https://www.youtube.com/embed/${getYouTubeId(url)}?autoplay=1`;
            document.getElementById('video-player-title').innerText = title;
            showView('video-player-view');
        }
    </script>
</body>
</html>
