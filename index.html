<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user;
    const userId = user ? user.id : "1856743644"; 
    const backendUrl = "https://ping-rewards-bot.mr-ping2025.workers.dev"; // Slash မပါစေရ

    tg.expand();

    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(v => v.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
    }

    async function initApp() {
        try {
            const userRes = await fetch(`${backendUrl}/api/get-user?id=${userId}`);
            const userData = await userRes.json();

            if (userData && !userData.error) {
                document.getElementById('total-points-value').textContent = userData.points || 0;
                document.getElementById('welcome-message').textContent = `Welcome, ${userData.name}!`;
                
                // အကုန်လုံးကို တစ်ခါတည်း ကြိုတင် Load လုပ်ထားမယ်
                await loadVideos();
                await loadTasks();
                await loadHistory();
                
                showView('user-dashboard-view');
            } else {
                alert("Please register in the bot first!");
                tg.close();
            }
        } catch (err) { alert("Connection Error!"); }
    }

    // --- Watch Videos Loading ---
    async function loadVideos() {
        const res = await fetch(`${backendUrl}/api/get-videos`);
        const videos = await res.json();
        const grid = document.getElementById('video-grid');
        grid.innerHTML = videos.map(v => `
            <div class="video-card bg-card-bg p-4 rounded-xl border border-slate-700 cursor-pointer" onclick="playVideo('${v.id}', '${v.video_url}', '${v.title}')">
                <img src="https://img.youtube.com/vi/${getYouTubeId(v.video_url)}/hqdefault.jpg" class="w-full rounded-lg mb-2">
                <h3 class="font-semibold text-sm line-clamp-2">${v.title}</h3>
                <p class="text-xs text-muted-text mt-1">${v.category} • 1pt/60s</p>
            </div>
        `).join('');
    }

    // --- Social Tasks Loading ---
    async function loadTasks() {
        const res = await fetch(`${backendUrl}/api/get-tasks`);
        const tasks = await res.json();
        const grid = document.getElementById('social-tasks-grid');
        grid.innerHTML = tasks.map(t => `
            <div class="card bg-card-bg p-6 rounded-xl border border-slate-700 text-center">
                <h3 class="text-lg font-bold">${t.title}</h3>
                <p class="text-accent-green font-bold my-2">+${t.points} PTS</p>
                <a href="${t.link}" target="_blank" onclick="completeTask('${t.id}', ${t.points}, '${t.title}')" class="inline-block bg-primary px-6 py-2 rounded-lg text-white font-bold">Complete Task</a>
            </div>
        `).join('');
    }

    // --- Points History Loading ---
    async function loadHistory() {
        const res = await fetch(`${backendUrl}/api/get-history?id=${userId}`);
        const history = await res.json();
        const table = document.getElementById('points-history-table');
        table.innerHTML = history.map(h => `
            <tr>
                <td class="p-4 text-xs">${new Date(h.created_at).toLocaleDateString()}</td>
                <td class="p-4 text-sm">${h.description}</td>
                <td class="p-4 font-bold text-accent-green">+${h.points}</td>
            </tr>
        `).join('');
    }

    // --- Helper Functions ---
    async function completeTask(taskId, points, title) {
        await fetch(`${backendUrl}/api/award-points`, {
            method: 'POST',
            body: JSON.stringify({ userId, amount: points, desc: `Social Task: ${title}` })
        });
        alert("Points Awarded!");
        initApp();
    }

    function getYouTubeId(url) {
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length == 11) ? match[2] : null;
    }

    window.onload = initApp;
</script>
