<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Meta Tags -->
    <meta name="keywords" content="Ping Rewards, ဗီဒီယိုကြည့်ပြီး ငွေရှာ, အွန်လိုင်းအလုပ်, ငွေထုတ်, အွန်လိုင်းဝင်ငွေ, online money, watch and earn, online jobs, rewards, tasks, offers">
    <meta name="description" content="Ping Rewards တွင် ဗီဒီယိုများကြည့်ရှုခြင်း၊ Task များလုပ်ဆောင်ခြင်းဖြင့် အမှတ်များစုဆောင်းပြီး ငွေသားထုတ်ယူလိုက်ပါ။ အွန်လိုင်းမှ အလွယ်တကူ ငွေရှာပါ။">
    <!-- NAMO TASSA BHAGAVATO ARAHATO SAMMA SAMBUDDHASSA -->
    <title>Ping Rewards</title>
    <!-- Favicon - P logo as requested -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%236366f1' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14h-2V8h2a3 3 0 010 6z'/></svg>" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',  /* Indigo */
                        'secondary': '#f9a8d4', /* Pink */
                        'background': '#0f172a', /* Slate 900 */
                        'card-bg': '#1e293b', /* Slate 800 */
                        'text-color': '#e2e8f0', /* Slate 200 */
                        'muted-text': '#94a3b8', /* Slate 400 */
                        'accent-green': '#10b981', /* Emerald */
                        'accent-orange': '#f59e0b', /* Amber */
                        'accent-purple': '#a855f7', /* Purple */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        },
                        coinFly: {
                            '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
                            '100%': { transform: 'translateY(-100px) scale(0.5)', opacity: '0' },
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                        coin: 'coinFly 1s ease-in-out forwards',
                    }
                }
            }
        }
    </script>
    <style>
        /* General Styles for the entire app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Tailwind: bg-slate-900 */
            color: #e2e8f0; /* Tailwind: text-slate-200 */
            margin: 0;
            overflow-x: hidden;
        }
        
        /* Utility for drawer/sidebar state */
        .sidebar.open {
            transform: translateX(0);
        }

        .backdrop.open {
            display: block;
        }

        .no-scroll {
            overflow: hidden;
        }

        /* Coin Animation Styles - Adjusted for Tailwind CSS */
        .coin-icon {
            animation: coinFly 1s ease-in-out forwards;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
<body class="bg-background text-text-color">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-background bg-opacity-70 flex justify-center items-center z-[1002] transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-text-color border-t-primary"></div>
    </div>

    <!-- Login Page View -->
    <div id="login-page" class="view flex justify-center items-center min-h-screen p-4" style="display: flex;">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8">
                <!-- New Logo SVG: A bold 'P' in a circle -->
                <svg class="w-24 h-24 mx-auto fill-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14h-2V8h2a3 3 0 010 6z"/>
                </svg>
                <div class="text-2xl font-bold mt-2">Ping Rewards</div>
                <div class="text-muted-text mt-1">Get rewarded for simple tasks.</div>
            </div>
            <div class="bg-card-bg p-8 rounded-xl shadow-lg border border-slate-700">
                <h2 class="text-xl font-semibold mb-6">Welcome Back</h2>
                <p id="login-message" class="text-red-500 text-sm mb-4" style="display: none;"></p>
                <button id="google-sign-in-btn" class="w-full py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300 flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="#ffffff" d="M22.4 12.2c0-.7-.1-1.3-.2-1.9H12v3.8h5.3c-.2 1.2-.8 2.2-1.6 3l3.2 2.5c2.1-1.9 3.4-4.7 3.4-8.4z"/>
                        <path fill="#ffffff" d="M12 22c3.2 0 5.9-1.1 7.8-3l-3.2-2.5c-1 1.2-2.3 1.9-4.6 1.9-3.5 0-6.5-2.4-7.6-5.6l-3.3 2.5c1.4 2.8 4.4 4.8 7.9 4.8z"/>
                        <path fill="#ffffff" d="M4.4 12.2c0-1.6.4-3.1 1.2-4.4L2.3 5.4C.9 7.7 0 10 0 12.2c0 2.2.9 4.5 2.3 6.8l3.3-2.4c-.8-1.3-1.2-2.8-1-1.4z"/>
                        <path fill="#ffffff" d="M12 4.1c1.8 0 3.3.6 4.6 1.8L19.4 3C17.5 1.1 14.8 0 12 0c-3.5 0-6.5 2-7.9 4.8l3.3 2.4C8.7 5.7 10.2 5 12 5z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div> 
    
    <!-- Main Application Container (Hidden initially) -->
    <div id="app-container" class="view flex flex-col md:flex-row w-full min-h-screen" style="display: none;">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar fixed md:relative z-[100] md:z-0 top-0 left-0 w-64 h-full bg-card-bg shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0">
            <div class="p-6 pb-4 border-b border-slate-700 flex items-center">
                <svg class="w-12 h-12 fill-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14h-2V8h2a3 3 0 010 6z"/>
                </svg>
                <span class="text-xl font-bold ml-2">Ping Rewards</span>
            </div>
            <ul class="flex flex-col p-4 space-y-2">
                <!-- User Links -->
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="user-dashboard-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
                        Dashboard
                    </a>
                </li>
                <!-- NEW: Community Tasks Link -->
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="community-tasks-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                        Community Tasks
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="watch-videos-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        Watch Videos
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="points-history-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        Points History
                    </a>
                </li>
                
                <!-- Admin Links -->
                <hr class="my-4 border-slate-700 admin-link">
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="admin-dashboard-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h11v-2H3v2zm0 4h11v-2H3v2zm0-8h11V7H3v2zm13 .01V7h5v2.01h-5zM16 17h5v-2h-5v2zm0-4h5v-2h-5v2z"/></svg>
                        Admin Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="manage-videos-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        Manage Videos
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="manage-users-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Manage Users
                    </a>
                </li>
                <!-- NEW: Manage Community Tasks Link -->
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-3 rounded-lg hover:bg-primary/20 transition-colors duration-200" data-target="manage-community-tasks-view">
                        <svg class="w-6 h-6 mr-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2L2 6v12l10 4 10-4V6L12 2zm0 2.23l6.09 2.54L12 11.31 5.91 6.77 12 4.23zM4 8.44l7 3.09v9.06l-7-3.09V8.44zm9 12.11V11.53l7-3.09v9.06l-7 3.09z"/></svg>
                        Manage Community Tasks
                    </a>
                </li>
            </ul>
            <div id="sidebar-profile" class="p-6 border-t border-slate-700 mt-auto">
                <!-- Profile info will be updated by JS -->
            </div>
        </div>

        <div id="backdrop" class="backdrop fixed inset-0 bg-black bg-opacity-50 z-[99] hidden md:hidden"></div>

        <!-- Main Content Area -->
        <div id="app-content" class="flex-grow p-4 md:p-6 transition-all duration-300 ease-in-out">
            <header class="flex justify-between items-center mb-6">
                <h1 id="page-title" class="text-2xl md:text-3xl font-bold flex items-center">
                    <button id="menu-toggle" class="md:hidden p-2 -ml-2 rounded-md hover:bg-card-bg transition-colors duration-200">
                        <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </button>
                    Dashboard
                </h1>
                <div id="header-meta" class="hidden md:flex items-center space-x-4">
                    <!-- Header meta info will be updated by JS -->
                </div>
            </header>

            <!-- User Dashboard View -->
            <div id="user-dashboard-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 col-span-1 lg:col-span-3 flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h2 id="welcome-message" class="text-xl font-semibold mb-2"></h2>
                            <p class="text-muted-text">Ready to earn more points? Let's start watching some videos.</p>
                        </div>
                        <a href="#" class="nav-link user-link mt-4 md:mt-0 px-6 py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300 whitespace-nowrap" data-target="watch-videos-view">
                            Watch Now
                        </a>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Total Points</h2>
                        <div class="text-4xl font-bold text-primary" id="total-points-value">0</div>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Estimated Earnings</h2>
                        <div class="text-4xl font-bold text-accent-green" id="estimated-earnings-value">$0.00</div>
                    </div>
                    <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                        <h2 class="text-lg font-semibold mb-2 text-muted-text">Videos Watched</h2>
                        <div class="text-4xl font-bold text-accent-purple" id="videos-watched-value">0</div>
                    </div>
                </div>

                <div class="quick-actions mb-6">
                    <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
                    <div class="flex flex-wrap gap-4">
                        <a href="#" class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200" data-target="community-tasks-view">
                            Earn More Points
                        </a>
                        <a href="#" class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200" data-target="watch-videos-view">
                            Watch Videos
                        </a>
                        <a href="#" class="nav-link user-link px-6 py-3 bg-card-bg border border-slate-700 rounded-lg text-text-color hover:bg-slate-700 transition-colors duration-200" data-target="points-history-view">
                            View History
                        </a>
                    </div>
                </div>

                <div class="card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">Cash Out Points</h2>
                        <p class="text-muted-text">5000 Points = $1.00</p>
                        <p class="text-muted-text">Keep watching to increase your earnings.</p>
                    </div>
                    <button class="cashout-btn mt-4 md:mt-0 px-6 py-3 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300 whitespace-nowrap" id="cashout-button">
                        Cash Out
                    </button>
                </div>
            </div>

            <!-- NEW: Community Tasks View (User View) -->
            <div id="community-tasks-view" class="content-view" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Community Tasks</h2>
                    <button id="create-community-task-btn" class="px-4 py-2 bg-accent-green hover:bg-emerald-600 rounded-lg text-white font-semibold transition-colors duration-200">
                        Create a Task
                    </button>
                </div>
                <div id="community-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Community tasks will be rendered here dynamically -->
                </div>
            </div>

            <!-- Watch Videos View -->
            <div id="watch-videos-view" class="content-view" style="display: none;">
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <input type="text" id="search-bar" class="flex-grow px-4 py-2 rounded-full bg-card-bg border border-slate-700 focus:outline-none focus:ring-2 focus:ring-primary placeholder-muted-text" placeholder="Search videos...">
                    <div class="flex flex-wrap justify-center sm:justify-end gap-2">
                        <button class="filter-btn active px-4 py-2 rounded-full border border-primary bg-primary text-white text-sm hover:bg-primary/80 transition-colors duration-200" data-category="all">All</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="YouTube">YouTube</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="TikTok">TikTok</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Facebook">Facebook</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Nature">Nature</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Education">Education</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Travel">Travel</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Food">Food</button>
                        <button class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-card-bg text-sm hover:bg-slate-700 transition-colors duration-200" data-category="Gaming">Gaming</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="video-grid">
                    <!-- Video cards will be dynamically rendered here by JS -->
                </div>
            </div>
            
            <!-- Video Player View (New) -->
            <div id="video-player-view" class="content-view" style="display: none;">
                <button id="video-player-back-btn" class="mb-4 flex items-center gap-2 px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                    <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    Back to Videos
                </button>
                <div class="bg-card-bg p-0 rounded-xl shadow-md border border-slate-700">
                    <div class="aspect-video w-full rounded-xl overflow-hidden mb-4">
                        <iframe id="video-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2 p-4" id="video-player-title"></h2>
                    <p class="text-muted-text mb-4 p-4" id="video-player-description"></p>
                    <div class="flex justify-between items-center p-4">
                        <button id="get-summary-btn" class="action-btn px-2 py-2 bg-secondary hover:bg-pink-500 text-white font-semibold rounded-lg transition-colors duration-200 text-sm">
                            Get Summary ✨
                        </button>
                        <div id="summary-output" class="text-sm text-muted-text"></div>
                    </div>
                </div>
            </div>

            <!-- Points History View -->
            <div id="points-history-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Points History</h2>
                    <p class="text-muted-text mb-6">A record of all the points you have earned.</p>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Date</th>
                                    <th class="p-4">Description</th>
                                    <th class="p-4 rounded-tr-lg">Points</th>
                                </tr>
                            </thead>
                            <tbody id="points-history-table" class="divide-y divide-slate-700">
                                <!-- Table rows will be dynamically rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="content-view" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" id="admin-dashboard-grid">
                    <div class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Users</h3>
                            <div class="text-3xl font-bold" id="admin-total-users-value">0</div>
                        </div>
                    </div>
                    <div class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-purple/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-purple" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Videos</h3>
                            <div class="text-3xl font-bold" id="admin-total-videos-value">0</div>
                        </div>
                    </div>
                    <div class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-green/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-green" xmlns="http://www.w3.org/2d00/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z"/></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Points Earned</h3>
                            <div class="text-3xl font-bold" id="admin-total-points-earned-value">0</div>
                        </div>
                    </div>
                    <div class="stat-card bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex items-center">
                        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-accent-orange/20 flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 fill-accent-orange" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z"/></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-muted-text">Total Payouts</h3>
                            <div class="text-3xl font-bold" id="admin-total-payouts-value">$0</div>
                        </div>
                    </div>
                </div>

                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Weekly Watch History (Hours)</h2>
                    <div class="relative h-64 flex items-end pb-8 border-l-2 border-b-2 border-slate-600">
                        <span class="absolute left-0 top-0 text-sm text-muted-text -ml-6 -mt-2">8</span>
                        <span class="absolute left-0 bottom-0 text-sm text-muted-text -ml-6 -mb-4">0</span>
                        <div class="bar-chart flex items-end h-full w-full" id="weekly-watch-chart">
                            <!-- Bars will be dynamically updated by JS -->
                            <div class="w-1/7 h-1/2 mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 50%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Mon</span>
                            </div>
                            <div class="w-1/7 h-[38%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 38%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Tue</span>
                            </div>
                            <div class="w-1/7 h-[60%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 60%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Wed</span>
                            </div>
                            <div class="w-1/7 h-[54%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 54%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Thu</span>
                            </div>
                            <div class="w-1/7 h-[70%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 70%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Fri</span>
                            </div>
                            <div class="w-1/7 h-[98%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 98%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Sat</span>
                            </div>
                            <div class="w-1/7 h-[85%] mx-1 bg-primary rounded-t-full transition-all duration-500 ease-in-out relative group" style="height: 85%;">
                                <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm text-muted-text">Sun</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Videos View -->
            <div id="manage-videos-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Manage Videos</h2>
                        <button id="add-video-btn" class="px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                            Add New Video
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Title</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table" class="divide-y divide-slate-700">
                                <!-- Table rows will be dynamically rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Users View -->
            <div id="manage-users-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-2">Manage Users</h2>
                    <p class="text-muted-text mb-6">View user data, manage status, and edit information.</p>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">User ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Email</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-slate-700">
                                <!-- User rows will be dynamically rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Manage Community Tasks View -->
            <div id="manage-community-tasks-view" class="content-view" style="display: none;">
                <div class="bg-card-bg p-6 rounded-xl shadow-md border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">Manage Community Tasks</h2>
                    <p class="text-muted-text mb-6">Review and approve community tasks submitted by users.</p>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="p-4 rounded-tl-lg">Task Title</th>
                                    <th class="p-4">Platform</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4">Submitted By</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="manage-community-tasks-table-body" class="divide-y divide-slate-700">
                                <!-- Table rows will be dynamically rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- Modal for Cash Out Confirmation Message -->
        <div id="cashout-message-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 class="text-xl font-semibold mb-4">Cash Out Request</h3>
                <p id="cashout-message-text" class="text-muted-text mb-6">You need 5000 points to cash out.</p>
                <div class="flex justify-end gap-2">
                    <button type="button" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200" id="cashout-message-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Modal for Delete Confirmation -->
        <div id="delete-confirm-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="delete-modal-title" class="text-xl font-semibold mb-4">Are you sure you want to delete this video?</h3>
                <p class="text-muted-text mb-6">This action cannot be undone.</p>
                <div class="flex justify-end gap-2">
                    <button type="button" class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                    <button type="button" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white font-semibold transition-colors duration-200" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for Viewing User History -->
        <div id="user-history-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-3xl shadow-2xl border border-slate-700">
                <h3 id="user-history-title" class="text-xl font-semibold mb-4"></h3>
                
                <!-- Points History Section -->
                <h4 class="text-lg font-semibold mt-4 mb-2">Points History</h4>
                <div id="user-points-history-content" class="overflow-y-auto max-h-[400px] rounded-lg border border-slate-700">
                       <table class="w-full text-left table-auto">
                           <thead class="bg-slate-700 text-slate-400 uppercase text-xs sticky top-0">
                               <tr>
                                   <th class="p-4 rounded-tl-lg">Date</th>
                                   <th class="p-4">Description</th>
                                   <th class="p-4">Points</th>
                                   <th class="p-4 rounded-tr-lg">Actions</th>
                               </tr>
                           </thead>
                           <tbody id="user-history-table-body" class="divide-y divide-slate-700">
                               <!-- History rows will be dynamically rendered here by JS -->
                           </tbody>
                       </table>
                </div>

                <!-- Cash Out History Section -->
                <h4 class="text-lg font-semibold mt-6 mb-2">Cash Out History</h4>
                <div id="user-cashout-history-content" class="overflow-y-auto max-h-[200px] rounded-lg border border-slate-700">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-700 text-slate-400 uppercase text-xs sticky top-0">
                            <tr>
                                <th class="p-4 rounded-tl-lg">Date</th>
                                <th class="p-4">Amount ($)</th>
                                <th class="p-4 rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-cashout-history-table-body" class="divide-y divide-slate-700">
                            <!-- Cash out history rows will be dynamically rendered here by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-lg text-white font-semibold transition-colors duration-200" id="user-history-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Modal for Adding/Editing Videos (Hidden by default) -->
        <div id="add-video-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="modal-title" class="text-xl font-semibold mb-4">Add New Video</h3>
                <form id="add-video-form" class="modal-form space-y-4">
                    <div>
                        <label for="video-title" class="block text-sm font-medium mb-1">Video Title</label>
                        <input type="text" id="video-title" name="videoTitle" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="video-description" class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="video-description" name="videoDescription" rows="3" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    <div>
                        <label for="video-category" class="block text-sm font-medium mb-1">Category</label>
                        <select id="video-category" name="videoCategory" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="" disabled selected>Select a category</option>
                            <option value="YouTube">YouTube</option>
                            <option value="TikTok">TikTok</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Nature">Nature</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Food">Food</option>
                            <option value="Gaming">Gaming</option>
                        </select>
                    </div>
                    <div>
                        <label for="video-url" class="block text-sm font-medium mb-1">Video URL (YouTube Embed Link)</label>
                        <input type="text" id="video-url" name="videoUrl" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="video-points" class="block text-sm font-medium mb-1">Points</label>
                        <input type="number" id="video-points" name="videoPoints" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="watch-duration" class="block text-sm font-medium mb-1">Watch Duration (Seconds)</label>
                        <input type="number" id="watch-duration" name="watchDuration" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                        <button type="submit" class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">Save Video</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal for Cash Out Request -->
        <div id="cashout-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 class="text-xl font-semibold mb-4">Cash Out Request</h3>
                <form id="cashout-form" class="modal-form space-y-4">
                    <p class="text-muted-text">Please enter your payment details to receive your earnings.</p>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium mb-1">Payment Method</label>
                        <select id="payment-method" name="paymentMethod" class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="KBZ Pay">KBZ Pay</option>
                            <option value="Wave Pay">Wave Pay</option>
                            <option value="Binance Pay">Binance Pay</option>
                        </select>
                    </div>
                    <div>
                        <label for="payout-amount" class="block text-sm font-medium mb-1">Amount ($)</label>
                        <input type="number" id="payout-amount" name="payoutAmount" value="0.00" readonly class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 text-muted-text cursor-not-allowed">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200">Cancel</button>
                        <button type="submit" class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200" id="cashout-submit-btn">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Modal for Creating Community Task -->
        <div id="create-community-task-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 class="text-xl font-semibold mb-4">Create a Community Task</h3>
                <form id="create-community-task-form" class="modal-form space-y-4">
                    <div>
                        <label for="task-title" class="block text-sm font-medium mb-1">Task Title</label>
                        <input type="text" id="task-title" name="taskTitle" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="task-platform" class="block text-sm font-medium mb-1">Platform</label>
                        <select id="task-platform" name="taskPlatform" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="" disabled selected>Select a platform</option>
                            <option value="Facebook">Facebook Page</option>
                            <option value="Telegram">Telegram Channel</option>
                            <option value="YouTube">YouTube Channel</option>
                            <option value="TikTok">TikTok Account</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-link" class="block text-sm font-medium mb-1">Link URL</label>
                        <input type="url" id="task-link" name="taskLink" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="task-points" class="block text-sm font-medium mb-1">Points to Award</label>
                        <input type="number" id="task-points" name="taskPoints" required class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="task-fee" class="block text-sm font-medium mb-1">Fee (to be paid to admin)</label>
                        <input type="text" id="task-fee" name="taskFee" value="5000 points" readonly class="w-full px-4 py-2 rounded-lg bg-slate-700 border border-slate-600 text-muted-text cursor-not-allowed">
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="cancel-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200" id="create-task-cancel-btn">Cancel</button>
                        <button type="submit" class="save-btn px-4 py-2 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">Submit Task</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Modal for payment instructions -->
        <div id="payment-instruction-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700 text-center">
                <h3 class="text-xl font-semibold mb-4">Task Submitted!</h3>
                <p class="text-muted-text mb-4">ကျေးဇူးတင်ပါတယ်! သင့်ရဲ့ Community Task ကို လက်ခံရရှိပါပြီ။ Task ကို approve လုပ်ဖို့အတွက် အောက်ပါ Telegram Channel ကို ဆက်သွယ်ပြီး 5000 points ဝန်ဆောင်မှု 料金ကို ပေးသွင်းပေးပါ။</p>
                <a href="https://t.me/MMMMOline" target="_blank" class="inline-block px-6 py-3 bg-primary hover:bg-indigo-600 rounded-lg text-white font-semibold transition-colors duration-200">
                    Go to Telegram Channel
                </a>
                <div class="flex justify-end mt-4">
                     <button type="button" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200" id="payment-instruction-close-btn">Close</button>
                </div>
            </div>
        </div>
        
        <!-- NEW: General Alert Modal -->
        <div id="alert-modal" class="modal-overlay fixed inset-0 flex justify-center items-center z-[1000] hidden">
            <div class="modal-content bg-card-bg p-8 rounded-xl w-11/12 max-w-lg shadow-2xl border border-slate-700">
                <h3 id="alert-title" class="text-xl font-semibold mb-4">Notification</h3>
                <p id="alert-message" class="text-muted-text mb-6"></p>
                <div class="flex justify-end gap-2">
                    <button type="button" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg text-white font-semibold transition-colors duration-200" id="alert-close-btn">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Use the environment variable for the app ID
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Use the environment variable for Firebase config
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let userId = null;
            let isAuthReady = false;

            // --- DOM Element Selections ---
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            const loginMessage = document.getElementById('login-message');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.content-view');
            const pageTitle = document.getElementById('page-title');
            const headerMeta = document.getElementById('header-meta');
            const sidebarProfile = document.getElementById('sidebar-profile');

            const videoGrid = document.getElementById('video-grid');
            const searchBar = document.getElementById('search-bar');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const videoPlayerView = document.getElementById('video-player-view');
            const videoIframe = document.getElementById('video-iframe');
            const videoPlayerBackBtn = document.getElementById('video-player-back-btn');
            const videoPlayerTitle = document.getElementById('video-player-title');
            const videoPlayerDescription = document.getElementById('video-player-description');
            
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle');
            const backdrop = document.getElementById('backdrop');

            const addVideoBtn = document.getElementById('add-video-btn');
            const addVideoModal = document.getElementById('add-video-modal');
            const addVideoForm = document.getElementById('add-video-form');
            const addModalTitle = document.getElementById('modal-title');
            const videoTableBody = document.querySelector('#videos-table');
            const getSummaryBtn = document.getElementById('get-summary-btn');
            const summaryOutput = document.getElementById('summary-output');

            const cashoutBtn = document.getElementById('cashout-button');
            const cashoutModal = document.getElementById('cashout-modal');
            const cashoutForm = document.getElementById('cashout-form');
            const totalPointsValue = document.getElementById('total-points-value');
            const estimatedEarningsValue = document.getElementById('estimated-earnings-value');
            const videosWatchedValue = document.getElementById('videos-watched-value');
            const pointsHistoryTableBody = document.querySelector('#points-history-table');
            
            const adminTotalUsersValue = document.getElementById('admin-total-users-value');
            const adminTotalVideosValue = document.getElementById('admin-total-videos-value');
            const adminTotalPointsEarnedValue = document.getElementById('admin-total-points-earned-value');
            const adminTotalPayoutsValue = document.getElementById('admin-total-payouts-value');
            
            const welcomeMessage = document.getElementById('welcome-message');
            
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmBtn = document.getElementById('confirm-delete-btn');
            
            const usersTableBody = document.getElementById('users-table-body');
            const userHistoryModal = document.getElementById('user-history-modal');
            const userHistoryTitle = document.getElementById('user-history-title');
            const userHistoryTableBody = document.getElementById('user-history-table-body');
            const userCashoutHistoryTableBody = document.getElementById('user-cashout-history-table-body');
            
            const cashoutMessageModal = document.getElementById('cashout-message-modal');
            const cashoutMessageText = document.getElementById('cashout-message-text');

            const offerwallButtons = document.querySelectorAll('.offerwall-btn');
            // NEW Community Task elements
            const communityTasksView = document.getElementById('community-tasks-view');
            const communityTasksList = document.getElementById('community-tasks-list');
            const createCommunityTaskBtn = document.getElementById('create-community-task-btn');
            const createCommunityTaskModal = document.getElementById('create-community-task-modal');
            const createCommunityTaskForm = document.getElementById('create-community-task-form');
            const paymentInstructionModal = document.getElementById('payment-instruction-modal');
            const manageCommunityTasksTableBody = document.getElementById('manage-community-tasks-table-body');
            
            // New alert modal
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertCloseBtn = document.getElementById('alert-close-btn');

            let videos = [];
            let communityTasks = [];
            let currentUser = null;
            let userData = null;
            let videoCardToAnimate = null;
            let cachedUsers = [];
            
            let pendingDeleteTask = null; // Store pending delete task ID

            const adminEmail = 'mr.ping2025@gmail.com';
            const communityTaskFee = 5000;
            
            // --- Utility Functions ---
            function getYouTubeId(url) {
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname.includes('youtube.com')) {
                        return urlObj.searchParams.get('v');
                    } else if (urlObj.hostname.includes('youtu.be')) {
                        return urlObj.pathname.substring(1);
                    }
                } catch (e) {
                    console.error("Invalid URL:", url);
                }
                return null;
            }

            function getYouTubeThumbnail(videoId) {
                if (videoId) {
                    return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }
                return 'https://placehold.co/400x225/1f3148/ffffff?text=Video';
            }
            
            // Replaced alert() with a custom modal
            function showAlert(message) {
                if (alertMessage) alertMessage.textContent = message;
                if (alertModal) alertModal.classList.remove('hidden');
            }

            function showLoading() {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                    setTimeout(() => loadingOverlay.style.opacity = '1', 10);
                }
            }

            function hideLoading() {
                if (loadingOverlay) {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => loadingOverlay.style.display = 'none', 300);
                }
            }

            // --- Firebase Functions ---
            async function seedInitialData(user) {
                try {
                    if (!user) {
                        console.log("No authenticated user to seed data for. Skipping user seed.");
                        return;
                    }
                    const userId = user.uid;
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const userDocSnap = await getDoc(userDocRef);
                    if (!userDocSnap.exists()) {
                        let userRole = 'user';
                        let userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ping User');
                        if (user.email === adminEmail) {
                            userRole = 'admin';
                            userName = 'Mr. Ping';
                        }
                        await setDoc(userDocRef, {
                            name: userName,
                            email: user.email || '',
                            role: userRole,
                            points: 0,
                            pointsHistory: [],
                            payoutHistory: [],
                            watchedVideos: [],
                            completedTasks: []
                        });
                        console.log("Seeding initial user data.");
                    }

                    if (user.email === adminEmail) {
                        const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                        const videosSnapshot = await getDocs(videosCollectionRef);
                        if (videosSnapshot.empty) {
                            const initialVideos = [
                                { id: 'vid1', title: "The Beauty of Nature", category: "Nature", points: 12, watchDuration: 10, description: "A breathtaking journey through mountains and forests.", videoUrl: "https://www.youtube.com/embed/g2J03u13kXg" },
                                { id: 'vid2', title: "Learn React in 30 Seconds", category: "Education", points: 25, watchDuration: 15, description: "A quick overview of React hooks.", videoUrl: "https://www.youtube.com/embed/Ke90Tje7VS0" },
                            ];
                            for (const video of initialVideos) {
                                await setDoc(doc(videosCollectionRef, video.id), {
                                    title: video.title,
                                    category: video.category,
                                    points: video.points,
                                    watchDuration: video.watchDuration,
                                    description: video.description,
                                    videoUrl: video.videoUrl
                                });
                            }
                            console.log("Seeding initial video data.");
                        }
                    }
                } catch (error) {
                    console.error("Error seeding data: ", error);
                }
            }

            async function fetchUserData(uid) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}`);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        currentUser = {
                            name: userData.name,
                            email: userData.email,
                            role: userData.role
                        };
                        updateUI(currentUser.role);
                        console.log("User data updated:", userData);
                    } else {
                        console.log("User data not found for a logged-in user.");
                        hideLoading();
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    hideLoading();
                });
            }

            async function fetchVideos() {
                showLoading();
                try {
                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    const q = query(videosCollectionRef);
                    const querySnapshot = await getDocs(q);
                    videos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Videos fetched from Firestore:", videos);
                } catch (e) {
                    console.error("Error fetching videos:", e);
                } finally {
                    hideLoading();
                }
            }
            
            async function fetchCommunityTasks() {
                showLoading();
                try {
                    const tasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/communityTasks`);
                    const q = query(tasksCollectionRef, where("status", "==", "approved"));
                    onSnapshot(q, (querySnapshot) => {
                         communityTasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         renderCommunityTasks(communityTasks);
                         console.log("Approved community tasks fetched:", communityTasks);
                    }, (error) => {
                         console.error("Error fetching community tasks:", error);
                    });
                } catch (e) {
                    console.error("Error setting up community tasks listener:", e);
                } finally {
                    hideLoading();
                }
            }

            async function fetchPendingCommunityTasks() {
                showLoading();
                try {
                    const tasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/communityTasks`);
                    const q = query(tasksCollectionRef, where("status", "==", "pending"));
                    onSnapshot(q, (querySnapshot) => {
                         const pendingTasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         renderManageCommunityTasksTable(pendingTasks);
                    }, (error) => {
                         console.error("Error fetching pending tasks:", error);
                    });
                } catch (e) {
                    console.error("Error setting up pending tasks listener:", e);
                } finally {
                    hideLoading();
                }
            }

            async function submitCommunityTask(taskData) {
                showLoading();
                try {
                    const tasksCollectionRef = collection(db, `/artifacts/${appId}/public/data/communityTasks`);
                    await addDoc(tasksCollectionRef, { ...taskData, status: 'pending', submittedBy: userId });
                    console.log("Community task submitted successfully.");
                } catch (e) {
                    console.error("Error submitting task:", e);
                } finally {
                    hideLoading();
                }
            }
            
            async function approveCommunityTask(taskId) {
                showLoading();
                try {
                    const taskDocRef = doc(db, `/artifacts/${appId}/public/data/communityTasks`, taskId);
                    await updateDoc(taskDocRef, { status: 'approved' });
                    console.log(`Task ${taskId} approved.`);
                } catch (e) {
                    console.error("Error approving task:", e);
                } finally {
                    hideLoading();
                }
            }

            async function deleteCommunityTask(taskId) {
                showLoading();
                try {
                    const taskDocRef = doc(db, `/artifacts/${appId}/public/data/communityTasks`, taskId);
                    await deleteDoc(taskDocRef);
                    console.log(`Task ${taskId} deleted.`);
                } catch (e) {
                    console.error("Error deleting task:", e);
                } finally {
                    hideLoading();
                }
            }

            async function claimCommunityTaskPoints(taskId, points) {
                if (!userData || !userId) return;
                
                if (userData.completedTasks && userData.completedTasks.includes(taskId)) {
                    console.log("User has already completed this task.");
                    return;
                }

                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const newPoints = userData.points + points;
                    const newHistory = [...(userData.pointsHistory || []), {
                        date: new Date().toLocaleDateString('en-US'),
                        description: `Completed community task: ${taskId}`,
                        points: points
                    }];

                    await updateDoc(userDocRef, {
                        points: newPoints,
                        pointsHistory: newHistory,
                        completedTasks: arrayUnion(taskId)
                    });
                    console.log("Points claimed for community task.");
                } catch (e) {
                    console.error("Error claiming task points:", e);
                } finally {
                    hideLoading();
                }
            }

            async function fetchAllUsers() {
                showLoading();
                if (!usersTableBody) return;
                usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-muted-text">Fetching users...</td></tr>`;
                try {
                    // Changed the query to listen to all users
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    onSnapshot(usersCollectionRef, (querySnapshot) => {
                         cachedUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         renderUsersTable(cachedUsers);
                    }, (error) => {
                         console.error("Error fetching users:", error);
                         usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error fetching users.</td></tr>`;
                    });
                } catch (e) {
                    console.error("Error setting up user listener:", e);
                    usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error fetching users.</td></tr>`;
                } finally {
                    hideLoading();
                }
            }
            
            async function toggleUserRole(targetUserId, currentRole) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                const newRole = currentRole === 'admin' ? 'user' : 'admin';
                try {
                    await updateDoc(userDocRef, { role: newRole });
                    console.log(`User role updated to ${newRole}`);
                } catch (e) {
                    console.error("Error updating user role:", e);
                }
            }
            
            async function deletePointsHistoryItem(targetUserId, historyItem) {
                if (!targetUserId || !historyItem) return;
                
                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        const itemToRemove = {
                            date: historyItem.date,
                            description: historyItem.description,
                            points: historyItem.points
                        };

                        const updatedHistory = userData.pointsHistory.filter(item => 
                            JSON.stringify(item) !== JSON.stringify(itemToRemove)
                        );

                        await updateDoc(userDocRef, {
                            pointsHistory: updatedHistory,
                            points: userData.points - itemToRemove.points
                        });

                        console.log("Points history item deleted and points updated.");
                        
                        const updatedUserDoc = await getDoc(userDocRef);
                        const updatedUser = { id: targetUserId, ...updatedUserDoc.data() };
                        renderUserHistoryTables(updatedUser);
                    }
                } catch (e) {
                    console.error("Error deleting points history item:", e);
                } finally {
                    hideLoading();
                }
            }

            async function deleteCashOutHistoryItem(targetUserId, historyItem) {
                if (!targetUserId || !historyItem) return;
                
                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        const itemToRemove = {
                            date: historyItem.date,
                            amount: historyItem.amount
                        };
                        
                        const updatedHistory = userData.payoutHistory.filter(item => 
                            JSON.stringify(item) !== JSON.stringify(itemToRemove)
                        );

                        await updateDoc(userDocRef, {
                            payoutHistory: updatedHistory
                        });

                        console.log("Cash out history item deleted.");
                        
                        const updatedUserDoc = await getDoc(userDocRef);
                        const updatedUser = { id: targetUserId, ...updatedUserDoc.data() };
                        renderUserHistoryTables(updatedUser);
                    }
                } catch (e) {
                    console.error("Error deleting cash out history item:", e);
                } finally {
                    hideLoading();
                }
            }

            async function updatePointsInFirestore(pointsToAdd, description, videoId) {
                if (!userData || !userId) return;
                
                if ((userData.watchedVideos || []).includes(videoId)) {
                    console.log("User has already watched this video. No points awarded.");
                    return;
                }

                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const newPoints = userData.points + pointsToAdd;
                    const newHistory = [...(userData.pointsHistory || []), {
                        date: new Date().toLocaleDateString('en-US'),
                        description: description,
                        points: pointsToAdd
                    }];

                    await updateDoc(userDocRef, {
                        points: newPoints,
                        pointsHistory: newHistory,
                        watchedVideos: arrayUnion(videoId)
                    });
                    console.log("Points and history updated in Firestore.");
                } catch (e) {
                    console.error("Error updating points:", e);
                } finally {
                    hideLoading();
                }
            }
            
            async function saveVideo(videoData, videoId = null) {
                showLoading();
                try {
                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    if (videoId) {
                        const videoDocRef = doc(db, videosCollectionRef.path, videoId);
                        await setDoc(videoDocRef, videoData, { merge: true });
                        console.log("Video updated:", videoId);
                    } else {
                        await addDoc(videosCollectionRef, videoData);
                        console.log("Video added successfully.");
                    }
                } catch (e) {
                    console.error("Error saving video:", e);
                } finally {
                    hideLoading();
                }
                await fetchVideos(); 
                renderManageVideosTable();
                const activeFilterBtn = document.querySelector('.filter-btn.active');
                if (activeFilterBtn) {
                    renderVideoGrid(activeFilterBtn.getAttribute('data-category'));
                } else {
                    renderVideoGrid('all');
                }
            }
            
            async function deleteVideo(videoId) {
                showLoading();
                try {
                    const videoDocRef = doc(db, `/artifacts/${appId}/public/data/videos`, videoId);
                    await deleteDoc(videoDocRef);
                    console.log("Video deleted:", videoId);
                } catch (e) {
                    console.error("Error deleting video:", e);
                } finally {
                    hideLoading();
                }
                await fetchVideos();
                renderManageVideosTable();
                const activeFilterBtn = document.querySelector('.filter-btn.active');
                if (activeFilterBtn) {
                        renderVideoGrid(activeFilterBtn.getAttribute('data-category'));
                } else {
                    renderVideoGrid('all');
                }
            }
            
            async function fetchAdminDashboardData() {
                showLoading();
                try {
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    onSnapshot(usersCollectionRef, (usersSnapshot) => {
                        const totalUsers = usersSnapshot.docs.length;
                        let totalPointsEarned = 0;
                        let totalPayouts = 0;
                        usersSnapshot.forEach(doc => {
                            const userData = doc.data();
                            const userPoints = userData.points || 0;
                            totalPointsEarned += userPoints;
                            
                            const payoutHistory = userData.payoutHistory || [];
                            payoutHistory.forEach(payout => {
                                totalPayouts += payout.amount || 0;
                            });
                        });
                        
                        if (adminTotalUsersValue) adminTotalUsersValue.textContent = totalUsers;
                        if (adminTotalPointsEarnedValue) adminTotalPointsEarnedValue.textContent = totalPointsEarned;
                        if (adminTotalPayoutsValue) adminTotalPayoutsValue.textContent = `$${totalPayouts.toFixed(2)}`;
                    }, (error) => {
                        console.error("Error fetching admin users data:", error);
                    });

                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    onSnapshot(videosCollectionRef, (videosSnapshot) => {
                        const totalVideos = videosSnapshot.docs.length;
                        if (adminTotalVideosValue) adminTotalVideosValue.textContent = totalVideos;
                    }, (error) => {
                        console.error("Error fetching admin videos data:", error);
                    });
                } catch (e) {
                    console.error("Admin dashboard data fetch error:", e);
                } finally {
                    hideLoading();
                }
            }

            // --- UI Rendering Functions ---
            function updateUI(role) {
                if (!isAuthReady || !currentUser) return;
                
                views.forEach(view => { if(view) view.style.display = 'none'; });
                if (loginPage) loginPage.style.display = 'none';
                if (appContainer) appContainer.style.display = 'flex';

                if (role === 'user') {
                    document.querySelectorAll('.admin-link').forEach(link => { if (link) link.style.display = 'none'; });
                    document.querySelectorAll('.user-link').forEach(link => { if (link) link.style.display = 'flex'; });
                    if (headerMeta) headerMeta.innerHTML = getUserHeaderHTML();
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML();
                    if (welcomeMessage) welcomeMessage.textContent = `Welcome back, ${currentUser.name}!`;
                    showView('user-dashboard-view');
                    updatePointsDisplay();
                    renderPointsHistoryTable();
                    fetchVideos().then(() => renderVideoGrid('all'));
                    updateOfferWallCardState();
                } else if (role === 'admin') {
                    document.querySelectorAll('.user-link').forEach(link => { if (link) link.style.display = 'none'; });
                    document.querySelectorAll('.admin-link').forEach(link => { if (link) link.style.display = 'flex'; });
                    if (headerMeta) headerMeta.innerHTML = getAdminHeaderHTML();
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML();
                    showView('admin-dashboard-view');
                    fetchVideos().then(renderManageVideosTable);
                    fetchAdminDashboardData();
                }
                attachLogoutListeners(); 
            }

            function updateOfferWallCardState() {
                const cpaLeadCard = document.querySelector('.offer-card[data-provider="cpalead"]');
                const cpaLeadBtn = document.querySelector('button[data-provider="cpalead"]');
                if (userData && userData.points < 5000) {
                    if (cpaLeadCard) cpaLeadCard.classList.add('opacity-50');
                    if (cpaLeadBtn) {
                        cpaLeadBtn.disabled = true;
                        cpaLeadBtn.textContent = 'Points Required: 5000';
                        cpaLeadBtn.classList.remove('bg-primary', 'hover:bg-indigo-600');
                        cpaLeadBtn.classList.add('bg-slate-600', 'cursor-not-allowed');
                    }
                } else {
                    if (cpaLeadCard) cpaLeadCard.classList.remove('opacity-50');
                    if (cpaLeadBtn) {
                        cpaLeadBtn.disabled = false;
                        cpaLeadBtn.textContent = 'Start Tasks';
                        cpaLeadBtn.classList.remove('bg-slate-600', 'cursor-not-allowed');
                        cpaLeadBtn.classList.add('bg-primary', 'hover:bg-indigo-600');
                    }
                }
            }
            
            function getUserProfileHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                const roleText = currentUser?.role === 'admin' ? 'ADMINISTRATOR' : currentUser?.email || 'N/A';
                return `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center mr-4 font-semibold text-primary">
                            ${profileText}
                        </div>
                        <div class="flex-grow">
                            <div class="text-white font-semibold">${nameText}</div>
                            <div class="text-sm text-muted-text">${roleText}</div>
                        </div>
                    </div>
                `;
            }
            
            function getUserHeaderHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                const roleText = currentUser?.role === 'admin' ? 'Admin' : 'User';
                return `
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-end">
                            <span id="user-points-display" class="font-bold text-lg">${(userData?.points || 0).toLocaleString()} PTS</span>
                            <span class="text-sm text-muted-text">$${((userData?.points || 0) / 5000).toFixed(2)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <span class="block font-semibold">${nameText}</span>
                                <span class="block text-xs text-muted-text">${roleText}</span>
                            </div>
                            <img src="https://placehold.co/32x32/6366f1/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full border border-primary">
                        </div>
                        <button class="logout-btn p-2 rounded-full hover:bg-slate-700 transition-colors duration-200">
                            <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                `;
            }
            
            function getAdminHeaderHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('');
                return `
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <span class="block font-semibold">${nameText}</span>
                                <span class="block text-xs text-muted-text">Admin</span>
                            </div>
                            <img src="https://placehold.co/32x32/6366f1/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full border border-primary">
                        </div>
                        <button class="logout-btn p-2 rounded-full hover:bg-slate-700 transition-colors duration-200">
                            <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                `;
            }

            function showView(targetId) {
                views.forEach(view => { if(view) view.style.display = 'none'; });
                const targetView = document.getElementById(targetId);
                if (targetView) {
                    targetView.style.display = 'block';
                    updatePageTitle(targetId);
                    navLinks.forEach(nav => {
                        if (nav) nav.classList.remove('active', 'bg-primary/20', 'text-white');
                    });
                    const activeLink = document.querySelector(`a[data-target="${targetId}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active', 'bg-primary/20', 'text-white');
                    }
                }
            }

            function updatePageTitle(viewId) {
                const titleElement = document.getElementById('page-title');
                if (!titleElement) return;

                const menuToggle = `<button id="menu-toggle" class="md:hidden p-2 -ml-2 rounded-md hover:bg-card-bg transition-colors duration-200">
                                        <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                                    </button>`;
                let titleText = 'Ping Rewards';

                switch (viewId) {
                    case 'user-dashboard-view': titleText = 'Dashboard'; break;
                    case 'community-tasks-view': titleText = 'Community Tasks'; break;
                    case 'watch-videos-view': titleText = 'Watch Videos'; break;
                    case 'points-history-view': titleText = 'Points History'; break;
                    case 'admin-dashboard-view': titleText = 'Admin Dashboard'; break;
                    case 'manage-videos-view': titleText = 'Manage Videos'; break;
                    case 'manage-users-view': titleText = 'Manage Users'; break;
                    case 'manage-community-tasks-view': titleText = 'Manage Community Tasks'; break;
                    case 'video-player-view': titleText = 'Video Player'; break;
                }
                titleElement.innerHTML = `${menuToggle} ${titleText}`;
                
                const toggleBtn = document.getElementById('menu-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        if (sidebar) sidebar.classList.toggle('open');
                        if (backdrop) backdrop.classList.toggle('open');
                        document.body.classList.toggle('no-scroll');
                    });
                }
            }
            
            function generateRandomChartData() {
                const bars = document.querySelectorAll('#weekly-watch-chart .w-1\\/7');
                bars.forEach(bar => {
                    const randomHeight = Math.floor(Math.random() * 90) + 10;
                    bar.style.height = `${randomHeight}%`;
                });
            }

            function renderVideoGrid(category, searchQuery = '') {
                const videoGrid = document.getElementById('video-grid');
                if (!videoGrid) {
                    console.error("Video grid element not found.");
                    return;
                }
                videoGrid.innerHTML = '';
                
                let filteredVideos = videos;
                if (category !== 'all') {
                    filteredVideos = filteredVideos.filter(video => video.category === category);
                }
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filteredVideos = filteredVideos.filter(video => 
                        video.title.toLowerCase().includes(query) || 
                        video.description.toLowerCase().includes(query)
                    );
                }

                if (filteredVideos.length === 0) {
                        videoGrid.innerHTML = `<p class="col-span-full text-center text-muted-text py-12">No videos found.</p>`;
                        return;
                }
                
                const watchedVideoIds = userData?.watchedVideos || [];
                const unwatchedVideos = filteredVideos.filter(video => !watchedVideoIds.includes(video.id));
                const watchedVideos = filteredVideos.filter(video => watchedVideoIds.includes(video.id));
                const sortedVideos = [...unwatchedVideos, ...watchedVideos];

                sortedVideos.forEach(video => {
                    let thumbnailUrl;
                    const youtubeId = getYouTubeId(video.videoUrl);
                    if (youtubeId) {
                        thumbnailUrl = getYouTubeThumbnail(youtubeId);
                    } else {
                        thumbnailUrl = `https://placehold.co/400x225/1f3148/ffffff?text=${video.category}`;
                    }

                    const isWatched = watchedVideoIds.includes(video.id);
                    const watchedClass = isWatched ? 'opacity-50 grayscale' : '';

                    const videoCardHtml = `
                        <div class="video-card bg-card-bg rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer border border-slate-700 ${watchedClass}" data-category="${video.category}" data-video-url="${video.videoUrl}" data-video-id="${video.id}">
                            <img src="${thumbnailUrl}" alt="${video.title}" class="w-full h-40 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x225/1f3148/ffffff?text=${video.category}';">
                            <div class="p-4">
                                <div class="text-xs text-secondary mb-1 uppercase">${video.category}</div>
                                <h3 class="text-lg font-semibold truncate mb-1">${video.title}</h3>
                                <p class="text-sm text-muted-text line-clamp-2">${video.description}</p>
                                <span class="inline-block bg-primary text-white text-xs font-bold px-3 py-1 rounded-full mt-2">${video.points} PTS</span>
                                ${isWatched ? '<span class="text-xs text-accent-green font-semibold ml-2">Watched</span>' : ''}
                            </div>
                        </div>
                    `;
                    videoGrid.innerHTML += videoCardHtml;
                });
                attachVideoCardListeners();
            }
            
            function renderUsersTable(users) {
                if (!usersTableBody) return;
                usersTableBody.innerHTML = '';
                if (users.length === 0) {
                        usersTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-muted-text">No users found.</td></tr>`;
                        return;
                }
                
                users.forEach(user => {
                    const toggleRoleBtnText = user.role === 'admin' ? 'Demote to User' : 'Promote to Admin';
                    const tableRowHtml = `
                        <tr data-user-id="${user.id}" class="hover:bg-slate-700 transition-colors duration-200">
                            <td class="p-4 text-xs font-mono">${user.id}</td>
                            <td class="p-4">${user.name || 'N/A'}</td>
                            <td class="p-4">${user.email || 'N/A'}</td>
                            <td class="p-4"><span class="capitalize px-2 py-1 rounded-full text-xs font-semibold ${user.role === 'admin' ? 'bg-orange-500 text-white' : 'bg-primary/20 text-primary'}">${user.role}</span></td>
                            <td class="p-4">${user.points || 0}</td>
                            <td class="p-4 whitespace-nowrap">
                                <button class="actions-btn view-history-btn px-3 py-1 bg-accent-green hover:bg-emerald-600 text-white text-sm rounded-lg transition-colors duration-200" data-user-id="${user.id}">View History</button>
                                ${user.id !== userId ? `<button class="actions-btn toggle-role-btn px-3 py-1 bg-accent-purple hover:bg-purple-600 text-white text-sm rounded-lg ml-2 transition-colors duration-200" data-user-id="${user.id}" data-current-role="${user.role}">${toggleRoleBtnText}</button>` : ''}
                            </td>
                        </tr>
                    `;
                    usersTableBody.innerHTML += tableRowHtml;
                });
                attachManageUsersListeners(users);
            }
            
            function renderUserHistoryTables(user) {
                if (!userHistoryTableBody || !userCashoutHistoryTableBody) return;
                
                userHistoryTableBody.innerHTML = '';
                userCashoutHistoryTableBody.innerHTML = '';

                // Render Points History
                const pointsHistory = user.pointsHistory || [];
                if (pointsHistory.length > 0) {
                    pointsHistory.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-700 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-4">${item.date}</td>
                            <td class="p-4">${item.description}</td>
                            <td class="p-4">${item.points}</td>
                            <td class="p-4">
                               <button class="delete-points-history-btn px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-xs rounded-lg transition-colors duration-200" data-history-index="${index}" data-user-id="${user.id}">Delete</button>
                            </td>
                        `;
                        userHistoryTableBody.appendChild(row);
                    });
                } else {
                    userHistoryTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-muted-text">No points history found.</td></tr>`;
                }

                // Render Cash Out History
                const cashoutHistory = user.payoutHistory || [];
                if (cashoutHistory.length > 0) {
                    cashoutHistory.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-700 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-4">${item.date}</td>
                            <td class="p-4">$${item.amount.toFixed(2)}</td>
                            <td class="p-4">
                                <button class="delete-cashout-history-btn px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-xs rounded-lg transition-colors duration-200" data-history-index="${index}" data-user-id="${user.id}">Delete</button>
                            </td>
                        `;
                        userCashoutHistoryTableBody.appendChild(row);
                    });
                } else {
                    userCashoutHistoryTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-muted-text">No cash out history found.</td></tr>`;
                }
                
                document.querySelectorAll('.delete-points-history-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const historyIndex = parseInt(btn.getAttribute('data-history-index'));
                        const targetUserId = btn.getAttribute('data-user-id');
                        const user = cachedUsers.find(u => u.id === targetUserId);
                        if (user && user.pointsHistory && user.pointsHistory[historyIndex]) {
                            const historyItem = user.pointsHistory[historyIndex];
                            await deletePointsHistoryItem(targetUserId, historyItem);
                        }
                    });
                });

                document.querySelectorAll('.delete-cashout-history-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const historyIndex = parseInt(btn.getAttribute('data-history-index'));
                        const targetUserId = btn.getAttribute('data-user-id');
                        const user = cachedUsers.find(u => u.id === targetUserId);
                        if (user && user.payoutHistory && user.payoutHistory[historyIndex]) {
                            const historyItem = user.payoutHistory[historyIndex];
                            await deleteCashOutHistoryItem(targetUserId, historyItem);
                        }
                    });
                });
            }

            function renderManageVideosTable() {
                const videoTableBody = document.querySelector('#videos-table');
                if (!videoTableBody) {
                    console.error("Video table body element not found.");
                    return;
                }
                videoTableBody.innerHTML = '';
                videos.forEach(video => {
                    const tableRowHtml = `
                        <tr class="hover:bg-slate-700 transition-colors duration-200" data-video-id="${video.id}">
                            <td class="p-4">${video.title}</td>
                            <td class="p-4">${video.category}</td>
                            <td class="p-4">${video.points}</td>
                            <td class="p-4">
                                <a href="#" class="actions-btn edit-btn text-primary hover:text-indigo-400 mr-4 transition-colors duration-200" data-video-id="${video.id}">Edit</a>
                                <a href="#" class="actions-btn delete-btn text-red-500 hover:text-red-400 transition-colors duration-200" data-video-id="${video.id}">Delete</a>
                            </td>
                        </tr>
                    `;
                    videoTableBody.innerHTML += tableRowHtml;
                });
                attachManageVideosListeners();
            }
            
            function renderPointsHistoryTable() {
                const pointsHistoryTableBody = document.querySelector('#points-history-table');
                if (!pointsHistoryTableBody) {
                    console.error("Points history table body element not found.");
                    return;
                }
                pointsHistoryTableBody.innerHTML = '';
                if (!userData || !userData.pointsHistory || userData.pointsHistory.length === 0) {
                        pointsHistoryTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-muted-text">No points history yet. Watch some videos!</td></tr>`;
                        return;
                }
                const history = userData.pointsHistory;
                history.forEach(item => {
                    const tableRowHtml = `
                        <tr class="hover:bg-slate-700 transition-colors duration-200">
                            <td class="p-4">${item.date}</td>
                            <td class="p-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 fill-accent-green flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5l-5-5 1.41-1.41L10 13.67l7.59-7.59L19 7l-9 9.5z"/></svg>
                                ${item.description}
                            </td>
                            <td class="p-4 font-bold text-accent-green">+${item.points}</td>
                        </tr>
                    `;
                    pointsHistoryTableBody.innerHTML += tableRowHtml;
                });
            }

            function renderCommunityTasks(tasks) {
                const communityTasksList = document.getElementById('community-tasks-list');
                if (!communityTasksList) return;
                communityTasksList.innerHTML = '';
                if (!tasks || tasks.length === 0) {
                    communityTasksList.innerHTML = `<p class="text-center text-muted-text">No community tasks available right now. Check back later!</p>`;
                    return;
                }
                
                const completedTaskIds = userData?.completedTasks || [];

                tasks.forEach(task => {
                    const isCompleted = completedTaskIds.includes(task.id);
                    const taskCard = document.createElement('div');
                    taskCard.className = `bg-card-bg p-6 rounded-xl shadow-md border border-slate-700 flex flex-col ${isCompleted ? 'opacity-50 grayscale' : ''}`;
                    taskCard.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2">${task.taskTitle}</h3>
                        <p class="text-muted-text text-sm mb-4">Platform: ${task.taskPlatform}</p>
                        <a href="${task.taskLink}" target="_blank" class="w-full text-center py-2 bg-primary hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors duration-300">
                            Go to Task
                        </a>
                        <button class="claim-task-btn mt-2 w-full py-2 bg-accent-green hover:bg-emerald-600 text-white font-semibold rounded-lg transition-colors duration-300" data-task-id="${task.id}" data-task-points="${task.taskPoints}" ${isCompleted ? 'disabled' : ''}>
                           ${isCompleted ? 'Completed' : `Claim ${task.taskPoints} Points`}
                        </button>
                    `;
                    communityTasksList.appendChild(taskCard);
                });

                document.querySelectorAll('.claim-task-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const taskId = btn.dataset.taskId;
                        const points = parseInt(btn.dataset.taskPoints);
                        await claimCommunityTaskPoints(taskId, points);
                    });
                });
            }

            function renderManageCommunityTasksTable(tasks) {
                 const tableBody = document.getElementById('manage-community-tasks-table-body');
                 if (!tableBody) return;

                 tableBody.innerHTML = '';
                 if (!tasks || tasks.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-muted-text">No community tasks submitted.</td></tr>`;
                     return;
                 }

                 tasks.forEach(task => {
                    const isApproved = task.status === 'approved';
                    const approveBtnHtml = isApproved ? 
                        `<span class="text-xs font-semibold text-accent-green">Approved</span>` : 
                        `<button class="approve-task-btn px-3 py-1 bg-accent-green hover:bg-emerald-600 text-white text-sm rounded-lg transition-colors duration-200" data-task-id="${task.id}">Approve</button>`;
                    
                    const rowHtml = `
                        <tr class="hover:bg-slate-700 transition-colors duration-200">
                            <td class="p-4">${task.taskTitle}</td>
                            <td class="p-4">${task.taskPlatform}</td>
                            <td class="p-4">${task.taskPoints}</td>
                            <td class="p-4 text-xs font-mono">${(task.submittedBy || 'N/A')}</td>
                            <td class="p-4"><span class="capitalize text-sm">${task.status}</span></td>
                            <td class="p-4">
                                ${approveBtnHtml}
                                <button class="delete-task-btn px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-sm rounded-lg ml-2 transition-colors duration-200" data-task-id="${task.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += rowHtml;
                 });
                
                // Moved event listeners here to ensure they are attached to newly rendered elements
                document.querySelectorAll('.approve-task-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const taskId = btn.dataset.taskId;
                        await approveCommunityTask(taskId);
                    });
                 });

                 document.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const taskId = btn.dataset.taskId;
                        // Use modal instead of confirm()
                        pendingDeleteTask = taskId;
                        document.getElementById('delete-modal-title').textContent = 'Are you sure you want to delete this task?';
                        deleteConfirmModal.classList.remove('hidden');
                    });
                 });
            }

            // --- Main Setup ---
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    if (user.isAnonymous) {
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch(e) {
                                console.error("Error signing in with custom token:", e);
                                loginPage.style.display = 'flex';
                                appContainer.style.display = 'none';
                                hideLoading();
                            }
                        } else {
                            loginPage.style.display = 'flex';
                            appContainer.style.display = 'none';
                            hideLoading();
                        }
                    } else {
                        userId = user.uid;
                        await seedInitialData(user);
                        await fetchUserData(userId);
                    }
                } else {
                    console.log("No user is signed in. Showing login page.");
                    loginPage.style.display = 'flex';
                    appContainer.style.display = 'none';
                    hideLoading();
                }
            });

            // Sign in anonymously if no token is available, as per standard canvas practice
            if (typeof __initial_auth_token === 'undefined') {
                signInAnonymously(auth);
            }

            // --- Event Listeners ---
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    showLoading();
                    const provider = new GoogleAuthProvider();
                    try {
                        const result = await signInWithPopup(auth, provider);
                        console.log("User signed in with Google successfully.");
                    } catch (error) {
                        console.error("Google Sign-in failed:", error);
                        // Use modal instead of plain text message
                        showAlert('Google Sign-in failed. Please check your Authorized domains.');
                        hideLoading();
                    }
                });
            }

            if(menuToggleBtn) {
                menuToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    backdrop.classList.toggle('open');
                    document.body.classList.toggle('no-scroll');
                });
            }
            
            if(backdrop) {
                backdrop.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    backdrop.classList.remove('open');
                    document.body.classList.remove('no-scroll');
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    showView(targetId);
                    sidebar.classList.remove('open');
                    backdrop.classList.remove('open');
                    document.body.classList.remove('no-scroll');
                    
                    if (targetId === 'watch-videos-view') {
                        renderVideoGrid('all');
                    } else if (targetId === 'manage-videos-view') {
                        renderManageVideosTable();
                    } else if (targetId === 'manage-users-view') {
                        fetchAllUsers();
                    } else if (targetId === 'points-history-view') {
                        renderPointsHistoryTable();
                    } else if (targetId === 'community-tasks-view') {
                        fetchCommunityTasks().then(() => renderCommunityTasks(communityTasks));
                    } else if (targetId === 'manage-community-tasks-view') {
                        fetchPendingCommunityTasks();
                    }
                });
            });
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => { 
                        b.classList.remove('active', 'bg-primary', 'border-primary', 'text-white'); 
                        b.classList.add('bg-card-bg', 'border-slate-700');
                    });
                    btn.classList.add('active', 'bg-primary', 'border-primary', 'text-white');
                    btn.classList.remove('bg-card-bg', 'border-slate-700');
                    const category = btn.getAttribute('data-category');
                    renderVideoGrid(category);
                });
            });

            if(searchBar) {
                searchBar.addEventListener('input', () => {
                    const activeFilterBtn = document.querySelector('.filter-btn.active');
                    const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                    renderVideoGrid(category, searchBar.value);
                });
            }

            if (addVideoBtn) {
                addVideoBtn.addEventListener('click', () => {
                    addModalTitle.textContent = "Add New Video";
                    addVideoForm.reset();
                    addVideoForm.removeAttribute('data-editing-id');
                    addVideoModal.classList.remove('hidden');
                });
            }

            document.querySelectorAll('#add-video-modal .cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    addVideoModal.classList.add('hidden');
                });
            });

            if (addVideoForm) {
                addVideoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(addVideoForm);
                    const videoData = {
                        title: formData.get('videoTitle'),
                        description: formData.get('videoDescription'),
                        category: formData.get('videoCategory'),
                        videoUrl: formData.get('videoUrl'),
                        points: parseInt(formData.get('videoPoints')),
                        watchDuration: parseInt(formData.get('watchDuration'))
                    };
                    
                    const editingId = addVideoForm.getAttribute('data-editing-id');
                    await saveVideo(videoData, editingId);
                    
                    addVideoModal.classList.add('hidden');
                });
            }
            
            if (cashoutBtn) {
                cashoutBtn.addEventListener('click', () => {
                    if (!userData || userData.points < 5000) {
                        cashoutMessageText.textContent = `Cash Out လုပ်ရန်အတွက် Point 5000 လိုအပ်ပါသည်။ သင်၏ လက်ရှိ point မှာ ${(userData?.points || 0).toLocaleString()} ဖြစ်ပါသည်။`;
                        cashoutMessageModal.classList.remove('hidden');
                    } else {
                        const payoutAmount = (userData.points / 5000).toFixed(2);
                        const payoutInput = document.getElementById('payout-amount');
                        payoutInput.value = payoutAmount;
                        cashoutModal.classList.remove('hidden');
                    }
                });
            }
            
            document.querySelectorAll('#cashout-message-modal button').forEach(btn => {
                btn.addEventListener('click', () => {
                    cashoutMessageModal.classList.add('hidden');
                });
            });

            document.querySelectorAll('#cashout-modal .cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    cashoutModal.classList.add('hidden');
                });
            });
            
            if (cashoutForm) {
                cashoutForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const channelUrl = "https://t.me/MMMMOline";
                    
                    if (!userData || userData.points < 5000) {
                        cashoutModal.classList.add('hidden');
                        window.open(channelUrl, '_blank');
                        return;
                    }
                    showLoading();
                    try {
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                        const pointsCashedOut = userData.points;
                        const payoutAmount = (pointsCashedOut / 5000).toFixed(2);
                        const newHistoryEntry = {
                            date: new Date().toLocaleDateString('en-US'),
                            description: `Cashed out ${pointsCashedOut} points`,
                            points: -pointsCashedOut
                        };
                        const newPayoutEntry = {
                            date: new Date().toLocaleDateString('en-US'),
                            amount: parseFloat(payoutAmount)
                        };

                        await updateDoc(userDocRef, {
                            points: 0,
                            pointsHistory: [...(userData.pointsHistory || []), newHistoryEntry],
                            payoutHistory: [...(userData.payoutHistory || []), newPayoutEntry]
                        });

                        console.log('Cash out request submitted and points reset.');
                        cashoutModal.classList.add('hidden');
                        window.open(channelUrl, '_blank');
                    } catch (error) {
                        console.error("Error during cash out:", error);
                        window.open(channelUrl, '_blank');
                    } finally {
                        hideLoading();
                    }
                });
            }
            
            // Added logic to handle the delete confirm modal for tasks
            if (deleteConfirmBtn) {
                deleteConfirmBtn.addEventListener('click', async () => {
                    if (pendingDeleteTask) {
                        await deleteCommunityTask(pendingDeleteTask);
                        pendingDeleteTask = null;
                    }
                    deleteConfirmModal.classList.add('hidden');
                });
            }

            document.querySelectorAll('#delete-confirm-modal .cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    deleteConfirmModal.classList.add('hidden');
                    pendingDeleteTask = null;
                });
            });

            if (offerwallButtons) {
                offerwallButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        if (!userId) {
                            // Replaced alert with a modal
                            showAlert("Please log in to start tasks.");
                            return;
                        }
                        const isCpaLead = button.dataset.provider === 'cpalead';
                        if (isCpaLead && userData && userData.points < 5000) {
                            cashoutMessageText.textContent = `You need 5000 points to access CPALead Offers. Your current points are ${(userData?.points || 0).toLocaleString()}.`;
                            cashoutMessageModal.classList.remove('hidden');
                            return;
                        }
                        const provider = button.dataset.provider;
                        let baseUrl = '';
                        if (provider === 'cpalead') {
                            baseUrl = 'https://www.cpalead.com/my-offerwall/';
                        } else if (provider === 'offertoro') {
                            baseUrl = 'https://www.offertoro.com/ifr/show/';
                        }
                        if (baseUrl) {
                            const finalUrl = `${baseUrl}?subid=${userId}`;
                            console.log(`Opening Offer Wall: ${finalUrl}`);
                            window.open(finalUrl, '_blank');
                        } else {
                            console.log(`No URL configured for provider: ${provider}`);
                        }
                    });
                });
            }

            if (createCommunityTaskBtn) {
                 createCommunityTaskBtn.addEventListener('click', () => {
                     createCommunityTaskModal.classList.remove('hidden');
                 });
            }

            document.querySelectorAll('#create-community-task-modal .cancel-btn').forEach(btn => {
                 btn.addEventListener('click', () => {
                     createCommunityTaskModal.classList.add('hidden');
                 });
            });

            if (createCommunityTaskForm) {
                 createCommunityTaskForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const formData = new FormData(createCommunityTaskForm);
                     const taskData = {
                         taskTitle: formData.get('taskTitle'),
                         taskPlatform: formData.get('taskPlatform'),
                         taskLink: formData.get('taskLink'),
                         taskPoints: parseInt(formData.get('taskPoints')),
                         status: 'pending'
                     };

                     await submitCommunityTask(taskData);
                     createCommunityTaskModal.classList.add('hidden');
                     paymentInstructionModal.classList.remove('hidden');
                 });
            }

            document.querySelectorAll('#payment-instruction-modal button').forEach(btn => {
                 btn.addEventListener('click', () => {
                     paymentInstructionModal.classList.add('hidden');
                 });
            });
            
            // New listener for the general alert modal
            if (alertCloseBtn) {
                alertCloseBtn.addEventListener('click', () => {
                    alertModal.classList.add('hidden');
                });
            }
            
            // --- Final Setup ---
            generateRandomChartData();
        });
    </script>
</body>
</html>
