<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Rewards</title>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for a clean and modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to override or add specific features */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .main-container {
            min-height: 100vh;
        }
        .card {
            background-color: #16213e;
            border: 1px solid rgba(155, 89, 182, 0.5);
        }
        .text-primary-color {
            color: #9b59b6;
        }
        .bg-primary-color {
            background-color: #9b59b6;
        }
        .btn-primary {
            background-color: #9b59b6;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #7d498f;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .nav-link.active {
            background-color: #4a3861;
            color: #fff;
        }
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .input-bg {
            background-color: #3b4b6b;
        }
        .gradient-bg {
            background: linear-gradient(45deg, #2e3a59, #9b59b6);
        }
        .coin-animation-active {
            transform: scale(0.5);
            opacity: 0;
        }
        /* Mobile menu specific styles */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .backdrop {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .sidebar-open .backdrop {
            display: block;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center z-[1002] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
    </div>

    <!-- Login Page View -->
    <div id="login-page" class="view flex items-center justify-center min-h-screen p-4">
        <div class="text-center w-full max-w-sm">
            <div class="flex flex-col items-center justify-center mb-8">
                <!-- Updated SVG logo -->
                <svg class="w-20 h-20 text-blue-500" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M64.0007 128C99.3465 128 128.001 99.3458 128.001 64.0007C128.001 28.6556 99.3465 0 64.0007 0C28.6556 0 0 28.6556 0 64.0007C0 81.3323 7.02604 97.0223 18.3072 108.995L18.3375 109.027L18.3496 109.043C19.167 109.845 20.3061 110.334 21.5794 110.334C22.2575 110.334 22.9554 110.155 23.5855 109.789L35.4339 102.825C37.0709 101.884 37.6698 99.7845 36.8378 98.1132C35.0874 94.6192 34.0007 90.4124 34.0007 86.0007C34.0007 65.5658 50.5658 49.0007 71.0007 49.0007C91.4357 49.0007 108 65.5658 108 86.0007C108 97.2721 102.883 107.219 94.4022 113.844L94.4173 113.856C95.2351 114.658 96.3746 115.147 97.6482 115.147C98.3265 115.147 99.0245 114.968 99.6548 114.602L111.503 107.638C113.14 106.697 113.739 104.597 112.907 102.926C111.157 99.4323 110.071 95.2255 110.071 90.8138V64.0007C110.071 39.7368 89.2646 19.0007 64.0007 19.0007C38.7368 19.0007 19.0007 39.7368 19.0007 64.0007C19.0007 72.8228 21.6033 81.0425 26.2415 87.8967L26.2483 87.9067C27.0657 88.7086 28.2047 89.1979 29.478 89.1979C30.1561 89.1979 30.854 89.0189 31.4841 88.6528L43.3325 81.6888C44.9695 80.7482 45.5684 78.6485 44.7364 76.9772C42.986 73.4831 41.9001 69.2764 41.9001 64.8647C41.9001 44.4297 65.4652 27.8647 85.9001 27.8647C106.335 27.8647 122.9 44.4297 122.9 64.8647V101.996C122.9 105.748 120.916 109.117 117.898 111.189L108.575 117.48C107.037 118.528 105.105 119.06 103.179 119.06C99.4172 119.06 95.897 117.29 93.9936 114.28L85.2913 100.865C83.9113 98.7758 81.1685 98.1565 78.9669 99.3087C76.7654 100.461 76.1039 103.22 77.2921 105.421L85.9944 118.836C87.4827 121.054 88.761 122.788 90.0007 124.001C88.0872 125.864 85.7335 127.345 83.176 128.36L64.0007 128ZM39.6997 64.0007C39.6997 45.4754 55.4754 29.6997 74.0007 29.6997C92.526 29.6997 108.301 45.4754 108.301 64.0007C108.301 82.526 92.526 98.3017 74.0007 98.3017C55.4754 98.3017 39.6997 82.526 39.6997 64.0007ZM74.0007 88.0007C79.5236 88.0007 84.0007 83.5236 84.0007 78.0007C84.0007 72.4778 79.5236 68.0007 74.0007 68.0007C68.4778 68.0007 64.0007 72.4778 64.0007 78.0007C64.0007 83.5236 68.4778 88.0007 74.0007 88.0007ZM74.0007 58.0007C85.0463 58.0007 94.0007 66.9551 94.0007 78.0007C94.0007 89.0463 85.0463 98.0007 74.0007 98.0007C62.9551 98.0007 54.0007 89.0463 54.0007 78.0007C54.0007 66.9551 62.9551 58.0007 74.0007 58.0007ZM74.0007 90.0007C86.1504 90.0007 96.0007 79.3756 96.0007 66.0007C96.0007 52.6258 86.1504 42.0007 74.0007 42.0007C61.851 42.0007 52.0007 52.6258 52.0007 66.0007C52.0007 79.3756 61.851 90.0007 74.0007 90.0007Z" fill="currentColor"/>
                </svg>
                <div class="text-3xl font-bold mt-2 text-gray-400">PING</div>
                <div class="text-xl font-semibold text-primary-color">REWARDS</div>
            </div>
            <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-6 text-white">Welcome Back</h2>
                <p id="login-message" class="text-red-500 text-center text-sm font-semibold mb-4 hidden"></p>
                <button id="google-sign-in-btn" class="w-full py-3 bg-white text-gray-800 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.4 12.2c0-.7-.1-1.3-.2-1.9H12v3.8h5.3c-.2 1.2-.8 2.2-1.6 3l3.2 2.5c2.1-1.9 3.4-4.7 3.4-8.4z"/>
                        <path fill="#34A853" d="M12 22c3.2 0 5.9-1.1 7.8-3l-3.2-2.5c-1 1.2-2.3 1.9-4.6 1.9-3.5 0-6.5-2.4-7.6-5.6l-3.3 2.5c1.4 2.8 4.4 4.8 7.9 4.8z"/>
                        <path fill="#FBBC04" d="M4.4 12.2c0-1.6.4-3.1 1.2-4.4L2.3 5.4C.9 7.7 0 10 0 12.2c0 2.2.9 4.5 2.3 6.8l3.3-2.4c-.8-1.3-1.2-2.8-1-1.4z"/>
                        <path fill="#EA4335" d="M12 4.1c1.8 0 3.3.6 4.6 1.8L19.4 3C17.5 1.1 14.8 0 12 0c-3.5 0-6.5 2-7.9 4.8l3.3 2.4C8.7 5.7 10.2 5 12 5z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Application Container (Hidden initially) -->
    <div id="app-container" class="view hidden">
        <div class="main-container flex flex-col md:flex-row bg-[#2e3a59]">
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-[#1a1a2e] p-6 flex flex-col z-50 md:relative md:translate-x-0 md:shadow-none">
                <div class="flex items-center mb-8">
                    <svg class="w-10 h-10 text-blue-500" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M64.0007 128C99.3465 128 128.001 99.3458 128.001 64.0007C128.001 28.6556 99.3465 0 64.0007 0C28.6556 0 0 28.6556 0 64.0007C0 81.3323 7.02604 97.0223 18.3072 108.995L18.3375 109.027L18.3496 109.043C19.167 109.845 20.3061 110.334 21.5794 110.334C22.2575 110.334 22.9554 110.155 23.5855 109.789L35.4339 102.825C37.0709 101.884 37.6698 99.7845 36.8378 98.1132C35.0874 94.6192 34.0007 90.4124 34.0007 86.0007C34.0007 65.5658 50.5658 49.0007 71.0007 49.0007C91.4357 49.0007 108 65.5658 108 86.0007C108 97.2721 102.883 107.219 94.4022 113.844L94.4173 113.856C95.2351 114.658 96.3746 115.147 97.6482 115.147C98.3265 115.147 99.0245 114.968 99.6548 114.602L111.503 107.638C113.14 106.697 113.739 104.597 112.907 102.926C111.157 99.4323 110.071 95.2255 110.071 90.8138V64.0007C110.071 39.7368 89.2646 19.0007 64.0007 19.0007C38.7368 19.0007 19.0007 39.7368 19.0007 64.0007C19.0007 72.8228 21.6033 81.0425 26.2415 87.8967L26.2483 87.9067C27.0657 88.7086 28.2047 89.1979 29.478 89.1979C30.1561 89.1979 30.854 89.0189 31.4841 88.6528L43.3325 81.6888C44.9695 80.7482 45.5684 78.6485 44.7364 76.9772C42.986 73.4831 41.9001 69.2764 41.9001 64.8647C41.9001 44.4297 65.4652 27.8647 85.9001 27.8647C106.335 27.8647 122.9 44.4297 122.9 64.8647V101.996C122.9 105.748 120.916 109.117 117.898 111.189L108.575 117.48C107.037 118.528 105.105 119.06 103.179 119.06C99.4172 119.06 95.897 117.29 93.9936 114.28L85.2913 100.865C83.9113 98.7758 81.1685 98.1565 78.9669 99.3087C76.7654 100.461 76.1039 103.22 77.2921 105.421L85.9944 118.836C87.4827 121.054 88.761 122.788 90.0007 124.001C88.0872 125.864 85.7335 127.345 83.176 128.36L64.0007 128ZM39.6997 64.0007C39.6997 45.4754 55.4754 29.6997 74.0007 29.6997C92.526 29.6997 108.301 45.4754 108.301 64.0007C108.301 82.526 92.526 98.3017 74.0007 98.3017C55.4754 98.3017 39.6997 82.526 39.6997 64.0007ZM74.0007 88.0007C79.5236 88.0007 84.0007 83.5236 84.0007 78.0007C84.0007 72.4778 79.5236 68.0007 74.0007 68.0007C68.4778 68.0007 64.0007 72.4778 64.0007 78.0007C64.0007 83.5236 68.4778 88.0007 74.0007 88.0007ZM74.0007 58.0007C85.0463 58.0007 94.0007 66.9551 94.0007 78.0007C94.0007 89.0463 85.0463 98.0007 74.0007 98.0007C62.9551 98.0007 54.0007 89.0463 54.0007 78.0007C54.0007 66.9551 62.9551 58.0007 74.0007 58.0007ZM74.0007 90.0007C86.1504 90.0007 96.0007 79.3756 96.0007 66.0007C96.0007 52.6258 86.1504 42.0007 74.0007 42.0007C61.851 42.0007 52.0007 52.6258 52.0007 66.0007C52.0007 79.3756 61.851 90.0007 74.0007 90.0007Z" fill="currentColor"/>
                </svg>
                <div class="text-3xl font-bold mt-2 text-gray-400">PING</div>
                <div class="text-xl font-semibold text-primary-color">REWARDS</div>
            </div>
            <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-6 text-white">Welcome Back</h2>
                <p id="login-message" class="text-red-500 text-center text-sm font-semibold mb-4 hidden"></p>
                <button id="google-sign-in-btn" class="w-full py-3 bg-white text-gray-800 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.4 12.2c0-.7-.1-1.3-.2-1.9H12v3.8h5.3c-.2 1.2-.8 2.2-1.6 3l3.2 2.5c2.1-1.9 3.4-4.7 3.4-8.4z"/>
                        <path fill="#34A853" d="M12 22c3.2 0 5.9-1.1 7.8-3l-3.2-2.5c-1 1.2-2.3 1.9-4.6 1.9-3.5 0-6.5-2.4-7.6-5.6l-3.3 2.5c1.4 2.8 4.4 4.8 7.9 4.8z"/>
                        <path fill="#FBBC04" d="M4.4 12.2c0-1.6.4-3.1 1.2-4.4L2.3 5.4C.9 7.7 0 10 0 12.2c0 2.2.9 4.5 2.3 6.8l3.3-2.4c-.8-1.3-1.2-2.8-1-1.4z"/>
                        <path fill="#EA4335" d="M12 4.1c1.8 0 3.3.6 4.6 1.8L19.4 3C17.5 1.1 14.8 0 12 0c-3.5 0-6.5 2-7.9 4.8l3.3 2.4C8.7 5.7 10.2 5 12 5z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Application Container (Hidden initially) -->
    <div id="app-container" class="view hidden">
        <div class="main-container flex flex-col md:flex-row bg-[#2e3a59]">
            <!-- Sidebar -->
            <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-[#1a1a2e] p-6 flex flex-col z-50 md:relative md:translate-x-0 md:shadow-none">
                <div class="flex items-center mb-8">
                    <svg class="w-10 h-10 text-blue-500" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M64.0007 128C99.3465 128 128.001 99.3458 128.001 64.0007C128.001 28.6556 99.3465 0 64.0007 0C28.6556 0 0 28.6556 0 64.0007C0 81.3323 7.02604 97.0223 18.3072 108.995L18.3375 109.027L18.3496 109.043C19.167 109.845 20.3061 110.334 21.5794 110.334C22.2575 110.334 22.9554 110.155 23.5855 109.789L35.4339 102.825C37.0709 101.884 37.6698 99.7845 36.8378 98.1132C35.0874 94.6192 34.0007 90.4124 34.0007 86.0007C34.0007 65.5658 50.5658 49.0007 71.0007 49.0007C91.4357 49.0007 108 65.5658 108 86.0007C108 97.2721 102.883 107.219 94.4022 113.844L94.4173 113.856C95.2351 114.658 96.3746 115.147 97.6482 115.147C98.3265 115.147 99.0245 114.968 99.6548 114.602L111.503 107.638C113.14 106.697 113.739 104.597 112.907 102.926C111.157 99.4323 110.071 95.2255 110.071 90.8138V64.0007C110.071 39.7368 89.2646 19.0007 64.0007 19.0007C38.7368 19.0007 19.0007 39.7368 19.0007 64.0007C19.0007 72.8228 21.6033 81.0425 26.2415 87.8967L26.2483 87.9067C27.0657 88.7086 28.2047 89.1979 29.478 89.1979C30.1561 89.1979 30.854 89.0189 31.4841 88.6528L43.3325 81.6888C44.9695 80.7482 45.5684 78.6485 44.7364 76.9772C42.986 73.4831 41.9001 69.2764 41.9001 64.8647C41.9001 44.4297 65.4652 27.8647 85.9001 27.8647C106.335 27.8647 122.9 44.4297 122.9 64.8647V101.996C122.9 105.748 120.916 109.117 117.898 111.189L108.575 117.48C107.037 118.528 105.105 119.06 103.179 119.06C99.4172 119.06 95.897 117.29 93.9936 114.28L85.2913 100.865C83.9113 98.7758 81.1685 98.1565 78.9669 99.3087C76.7654 100.461 76.1039 103.22 77.2921 105.421L85.9944 118.836C87.4827 121.054 88.761 122.788 90.0007 124.001C88.0872 125.864 85.7335 127.345 83.176 128.36L64.0007 128ZM39.6997 64.0007C39.6997 45.4754 55.4754 29.6997 74.0007 29.6997C92.526 29.6997 108.301 45.4754 108.301 64.0007C108.301 82.526 92.526 98.3017 74.0007 98.3017C55.4754 98.3017 39.6997 82.526 39.6997 64.0007ZM74.0007 88.0007C79.5236 88.0007 84.0007 83.5236 84.0007 78.0007C84.0007 72.4778 79.5236 68.0007 74.0007 68.0007C68.4778 68.0007 64.0007 72.4778 64.0007 78.0007C64.0007 83.5236 68.4778 88.0007 74.0007 88.0007ZM74.0007 58.0007C85.0463 58.0007 94.0007 66.9551 94.0007 78.0007C94.0007 89.0463 85.0463 98.0007 74.0007 98.0007C62.9551 98.0007 54.0007 89.0463 54.0007 78.0007C54.0007 66.9551 62.9551 58.0007 74.0007 58.0007ZM74.0007 90.0007C86.1504 90.0007 96.0007 79.3756 96.0007 66.0007C96.0007 52.6258 86.1504 42.0007 74.0007 42.0007C61.851 42.0007 52.0007 52.6258 52.0007 66.0007C52.0007 79.3756 61.851 90.0007 74.0007 90.0007Z" fill="currentColor"/>
                </svg>
                <span class="text-xl font-bold ml-2 text-gray-400">Ping Rewards</span>
            </div>
            <!-- Navigation Links -->
            <ul class="nav-links flex-grow list-none p-0 m-0">
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="user-dashboard-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h11v-2H3v2zm0 4h11v-2H3v2zm0-8h11V7H3v2zm13 .01V7h5v2.01h-5zM16 17h5v-2h-5v2zm0-4h5v-2h-5v2z"/></svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="watch-videos-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        Watch Videos
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link user-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="points-history-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        Points History
                    </a>
                </li>
                
                <hr class="border-gray-700 my-5">

                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="admin-dashboard-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h11v-2H3v2zm0 4h11v-2H3v2zm0-8h11V7H3v2zm13 .01V7h5v2.01h-5zM16 17h5v-2h-5v2zm0-4h5v-2h-5v2z"/></svg>
                        Admin Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="manage-videos-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        Manage Videos
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link admin-link flex items-center p-4 rounded-lg mb-2 text-gray-300 hover:bg-[#4a3861] transition" data-target="manage-users-view">
                        <svg class="w-6 h-6 mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Manage Users
                    </a>
                </li>
            </ul>
            <div id="sidebar-profile" class="mt-auto pt-4 border-t border-gray-700">
                <!-- Profile info will be updated by JS -->
            </div>
        </div>
        <div id="backdrop" class="backdrop fixed inset-0 z-40"></div>

        <!-- Main Content Area -->
        <div id="app-content" class="app-content flex-grow p-4 md:p-8">
            <div class="main-content">
                <header class="flex justify-between items-center mb-6 md:mb-8">
                    <h1 id="page-title" class="text-xl md:text-3xl font-bold flex items-center text-white">
                        <button id="menu-toggle" class="md:hidden mr-4 text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        Dashboard
                    </h1>
                    <div id="header-meta">
                        <!-- Header meta info will be updated by JS -->
                    </div>
                </header>

                <!-- User Dashboard View -->
                <div id="user-dashboard-view" class="content-view hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-6 rounded-xl shadow-lg flex flex-col items-start text-left bg-gradient-to-r from-purple-800 to-indigo-800">
                            <h2 class="text-xl font-semibold mb-2 text-white">Total Points</h2>
                            <div class="text-4xl font-bold text-yellow-400" id="total-points-value">0</div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex flex-col items-start text-left bg-gradient-to-r from-green-800 to-teal-800">
                            <h2 class="text-xl font-semibold mb-2 text-white">Estimated Earnings</h2>
                            <div class="text-4xl font-bold text-green-300" id="estimated-earnings-value">$0.00</div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex flex-col items-start text-left bg-gradient-to-r from-blue-800 to-cyan-800">
                            <h2 class="text-xl font-semibold mb-2 text-white">Videos Watched</h2>
                            <div class="text-4xl font-bold text-blue-300" id="videos-watched-value">0</div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex flex-col items-start text-left bg-gradient-to-r from-red-800 to-orange-800">
                            <h2 class="text-xl font-semibold mb-2 text-white">Daily Earnings</h2>
                            <div class="text-4xl font-bold text-orange-300">$20</div>
                        </div>
                    </div>

                    <div class="quick-actions mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Quick Actions</h2>
                        <div class="flex flex-wrap gap-4">
                            <a href="#" class="nav-link user-link px-6 py-3 bg-gray-800 text-gray-300 rounded-lg shadow-md hover:bg-gray-700 transition" data-target="watch-videos-view">Browse Videos</a>
                            <a href="#" class="nav-link user-link px-6 py-3 bg-gray-800 text-gray-300 rounded-lg shadow-md hover:bg-gray-700 transition" data-target="points-history-view">View History</a>
                        </div>
                    </div>

                    <div class="card p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl md:text-2xl font-semibold mb-2 text-white">Points to Cash Conversion</h2>
                            <p class="text-gray-400">5000 Point = $1.00</p>
                            <p class="text-sm text-gray-500 mt-1">Keep watching to increase your earnings!</p>
                        </div>
                        <button class="cashout-btn btn-primary px-6 py-3 rounded-lg font-semibold mt-4 md:mt-0" id="cashout-button">Cash Out</button>
                    </div>
                </div>

                <!-- Watch Videos View -->
                <div id="watch-videos-view" class="content-view hidden">
                    <div class="video-browse">
                        <div class="video-header flex flex-col md:flex-row md:items-center gap-4 mb-6">
                            <input type="text" id="search-bar" class="search-bar flex-grow w-full md:w-auto px-5 py-3 rounded-full border border-gray-600 bg-[#3b4b6b] text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Search videos...">
                            <div class="filter-buttons flex flex-wrap gap-2 justify-center">
                                <button class="filter-btn active px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="all">All</button>
                                <button class="filter-btn px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="Nature">Nature</button>
                                <button class="filter-btn px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="Education">Education</button>
                                <button class="filter-btn px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="Travel">Travel</button>
                                <button class="filter-btn px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="Food">Food</button>
                                <button class="filter-btn px-4 py-2 rounded-full border border-gray-600 bg-gray-700 text-white hover:bg-purple-600 transition" data-category="Gaming">Gaming</button>
                            </div>
                        </div>
                        <div class="video-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="video-grid">
                            <!-- Video cards will be dynamically rendered here by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Video Player View (New) -->
                <div id="video-player-view" class="content-view hidden">
                    <button id="video-player-back-btn" class="back-btn flex items-center gap-2 mb-4 text-gray-300 hover:text-white transition">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        Back to Videos
                    </button>
                    <h2 id="video-player-title" class="text-2xl font-semibold text-white mb-2"></h2>
                    <p id="video-player-description" class="text-gray-400 mb-4"></p>
                    <div class="video-container relative pb-[56.25%] h-0 rounded-xl overflow-hidden mb-6">
                        <iframe id="video-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="absolute top-0 left-0 w-full h-full"></iframe>
                    </div>
                    <!-- Gemini API Feature: Video Summary -->
                    <div class="video-actions flex gap-4">
                        <button id="get-summary-btn" class="action-btn btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                            Get Summary âœ¨
                        </button>
                    </div>
                    <div id="summary-output" class="mt-6 p-4 rounded-lg bg-gray-800 border border-gray-700"></div>
                </div>

                <!-- Points History View -->
                <div id="points-history-view" class="content-view hidden">
                    <div class="points-history">
                        <h2 class="text-2xl font-semibold mb-2 text-white">Points History</h2>
                        <p class="text-gray-400 mb-6">A record of all your earned points.</p>
                        <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                            <table class="w-full text-left table-auto">
                                <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">Date</th>
                                        <th class="p-4">Description</th>
                                        <th class="p-4">Points</th>
                                    </tr>
                                </thead>
                                <tbody id="points-history-table" class="divide-y divide-gray-700">
                                    <!-- Table rows will be dynamically rendered here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            
                <!-- Admin Dashboard View -->
                <div id="admin-dashboard-view" class="content-view hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="admin-dashboard-grid">
                        <div class="card p-6 rounded-xl shadow-lg flex items-center bg-gray-800">
                            <div class="bg-purple-900/20 p-4 rounded-full mr-4">
                                <svg class="w-8 h-8 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-400">Total Users</h3>
                                <div class="text-3xl font-bold text-white" id="admin-total-users-value">0</div>
                            </div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex items-center bg-gray-800">
                            <div class="bg-purple-900/20 p-4 rounded-full mr-4">
                                <svg class="w-8 h-8 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-400">Total Videos</h3>
                                <div class="text-3xl font-bold text-white" id="admin-total-videos-value">0</div>
                            </div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex items-center bg-gray-800">
                            <div class="bg-green-900/20 p-4 rounded-full mr-4">
                                <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z"/></svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-400">Total Points Earned</h3>
                                <div class="text-3xl font-bold text-white" id="admin-total-points-earned-value">0</div>
                            </div>
                        </div>
                        <div class="card p-6 rounded-xl shadow-lg flex items-center bg-gray-800">
                            <div class="bg-orange-900/20 p-4 rounded-full mr-4">
                                <svg class="w-8 h-8 text-orange-400" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-12-7h4v2H8v-2zm-2-2v6h12V6H6z"/></svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-400">Total Payouts</h3>
                                <div class="text-3xl font-bold text-white" id="admin-total-payouts-value">$0</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container card p-6 rounded-xl shadow-lg mt-6">
                        <h2 class="text-xl font-semibold mb-4">Weekly Watch Activity (Hours)</h2>
                        <div class="bar-chart flex items-end h-64 relative border-l-2 border-b-2 border-gray-600 pb-8 pl-4">
                            <div class="absolute top-0 left-0 -ml-4 text-gray-400 text-sm">8</div>
                            <div class="absolute bottom-0 left-0 -ml-4 text-gray-400 text-sm">0</div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 50%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Mon</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 38%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Tue</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 60%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Wed</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 54%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Thu</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 70%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Fri</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 98%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Sat</div>
                            </div>
                            <div class="bar w-12 mx-2 bg-gradient-to-t from-purple-500 to-purple-700 relative transition-all duration-500" style="height: 85%;">
                                <div class="bar-label absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-gray-400 text-xs">Sun</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Videos View -->
                <div id="manage-videos-view" class="content-view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-white">Manage Videos</h2>
                        <button id="add-video-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold">Add Video</button>
                    </div>
                    <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4">Title</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4">Points</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table" class="divide-y divide-gray-700">
                                <!-- Table rows will be dynamically rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Manage Users View -->
                <div id="manage-users-view" class="content-view hidden">
                    <div class="manage-users">
                        <h2 class="text-2xl font-semibold mb-2 text-white">Manage Users</h2>
                        <p class="text-gray-400 mb-6">View user details, manage status, and edit information.</p>
                         <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                            <table class="w-full text-left table-auto">
                                <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                                    <tr>
                                        <th class="p-4">User ID</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">Role</th>
                                        <th class="p-4">Points</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y divide-gray-700">
                                    <!-- User rows will be dynamically rendered here by JS -->
                                </tbody>
                            </table>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Cash Out Confirmation Message -->
    <div id="cashout-message-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 p-8 rounded-xl w-full max-w-lg text-center border border-gray-700">
            <h3 class="text-2xl font-semibold mb-4">Cash Out Request</h3>
            <p id="cashout-message-text" class="text-gray-400 mb-6">You need 5000 points to cash out.</p>
            <div class="flex justify-center gap-4">
                <button type="button" class="btn-primary px-6 py-3 rounded-lg font-semibold" id="cashout-message-close-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="delete-confirm-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 p-8 rounded-xl w-full max-w-lg text-center border border-gray-700">
            <h3 id="delete-modal-title" class="text-2xl font-semibold mb-4">Are you sure you want to delete this video?</h3>
            <p class="text-gray-400 mb-6">Once deleted, this video cannot be recovered.</p>
            <div class="flex justify-center gap-4">
                <button type="button" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition" id="delete-cancel-btn">Cancel</button>
                <button type="button" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Viewing User History -->
    <div id="user-history-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 p-8 rounded-xl w-full max-w-lg max-h-[80vh] overflow-y-auto border border-gray-700">
            <h3 id="user-history-title" class="text-2xl font-semibold mb-4"></h3>
            <div id="user-history-content">
                 <table class="w-full text-left table-auto">
                     <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                         <tr>
                             <th class="p-4">Date</th>
                             <th class="p-4">Description</th>
                             <th class="p-4">Points</th>
                         </tr>
                     </thead>
                     <tbody id="user-history-table-body" class="divide-y divide-gray-700">
                         <!-- History rows will be dynamically rendered here by JS -->
                     </tbody>
                 </table>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="btn-primary px-6 py-3 rounded-lg font-semibold" id="user-history-close-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing Videos (Hidden by default) -->
    <div id="add-video-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 p-8 rounded-xl w-full max-w-lg border border-gray-700">
            <h3 id="modal-title" class="text-2xl font-semibold mb-6">Add New Video</h3>
            <form id="add-video-form" class="space-y-4">
                <div>
                    <label for="video-title" class="block text-gray-400 font-medium mb-1">Video Title</label>
                    <input type="text" id="video-title" name="videoTitle" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="video-description" class="block text-gray-400 font-medium mb-1">Description</label>
                    <textarea id="video-description" name="videoDescription" rows="3" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div>
                    <label for="video-category" class="block text-gray-400 font-medium mb-1">Category</label>
                    <select id="video-category" name="videoCategory" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="YouTube">YouTube</option>
                        <option value="TikTok">TikTok</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Nature">Nature</option>
                        <option value="Education">Education</option>
                        <option value="Travel">Travel</option>
                        <option value="Food">Food</option>
                        <option value="Gaming">Gaming</option>
                    </select>
                </div>
                <div>
                    <label for="video-url" class="block text-gray-400 font-medium mb-1">Video URL (YouTube Embed Link)</label>
                    <input type="text" id="video-url" name="videoUrl" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="video-points" class="block text-gray-400 font-medium mb-1">Points</label>
                    <input type="number" id="video-points" name="videoPoints" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="watch-duration" class="block text-gray-400 font-medium mb-1">Watch Duration (seconds)</label>
                    <input type="number" id="watch-duration" name="watchDuration" required class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition" id="add-video-cancel-btn">Cancel</button>
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-semibold" id="add-video-save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Cash Out Modal (New) -->
    <div id="cashout-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-gray-800 p-8 rounded-xl w-full max-w-lg border border-gray-700">
            <h3 class="text-2xl font-semibold mb-6 text-center">Cash Out Request</h3>
            <form id="cashout-form" class="space-y-4">
                <p class="text-gray-400 mb-4 text-center">Enter your payment details to receive your earnings.</p>
                <div>
                    <label for="payment-method" class="block text-gray-400 font-medium mb-1">Payment Method</label>
                    <select id="payment-method" name="paymentMethod" class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="KBZ Pay">KBZ Pay</option>
                        <option value="Wave Pay">Wave Pay</option>
                        <option value="Binance Pay">Binance Pay</option>
                    </select>
                </div>
                <div>
                    <label for="payout-amount" class="block text-gray-400 font-medium mb-1">Amount ($)</label>
                    <input type="number" id="payout-amount" name="payoutAmount" value="0.26" readonly class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none cursor-not-allowed">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition" id="cashout-cancel-btn">Cancel</button>
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-semibold" id="cashout-submit-btn">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase setup
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = {
              apiKey: "AIzaSyBKHF_6NIFD0-zrceg3BFJBdhJcFoXiKmA",
              authDomain: "ping-rewards.firebaseapp.com",
              projectId: "ping-rewards",
              storageBucket: "ping-rewards.firebasestorage.app",
              messagingSenderId: "1001465713586",
              appId: "1:1001465713586:web:07b8e1a2fb685614ac8aab",
              measurementId: "G-RJD7MPSSWF"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let userId = null;
            let isAuthReady = false;

            // UI elements
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            const loginMessage = document.getElementById('login-message');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.content-view');
            const pageTitle = document.getElementById('page-title');
            const headerMeta = document.getElementById('header-meta');
            const sidebarProfile = document.getElementById('sidebar-profile');

            const videoGrid = document.getElementById('video-grid');
            const searchBar = document.getElementById('search-bar');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const videoPlayerView = document.getElementById('video-player-view');
            const videoIframe = document.getElementById('video-iframe');
            const videoPlayerBackBtn = document.getElementById('video-player-back-btn');
            const videoPlayerTitle = document.getElementById('video-player-title');
            const videoPlayerDescription = document.getElementById('video-player-description');
            
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle');
            const backdrop = document.getElementById('backdrop');

            const addVideoBtn = document.getElementById('add-video-btn');
            const addVideoModal = document.getElementById('add-video-modal');
            const addVideoModalCancelBtn = document.querySelector('#add-video-modal #add-video-cancel-btn');
            const addVideoForm = document.getElementById('add-video-form');
            const addModalTitle = document.getElementById('modal-title');
            const videoTableBody = document.querySelector('#videos-table');
            const getSummaryBtn = document.getElementById('get-summary-btn');
            const summaryOutput = document.getElementById('summary-output');

            const cashoutBtn = document.getElementById('cashout-button');
            const cashoutModal = document.getElementById('cashout-modal');
            const cashoutCancelBtn = document.querySelector('#cashout-modal #cashout-cancel-btn');
            const cashoutForm = document.getElementById('cashout-form');
            const totalPointsValue = document.getElementById('total-points-value');
            const estimatedEarningsValue = document.getElementById('estimated-earnings-value');
            const videosWatchedValue = document.getElementById('videos-watched-value');
            const pointsHistoryTableBody = document.querySelector('#points-history-table');
            
            const adminTotalUsersValue = document.getElementById('admin-total-users-value');
            const adminTotalVideosValue = document.getElementById('admin-total-videos-value');
            const adminTotalPointsEarnedValue = document.getElementById('admin-total-points-earned-value');
            const adminTotalPayoutsValue = document.getElementById('admin-total-payouts-value');
            
            const welcomeMessage = document.getElementById('welcome-message');
            
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmBtn = document.getElementById('confirm-delete-btn');
            const deleteCancelBtn = document.getElementById('delete-cancel-btn');
            
            const usersTableBody = document.getElementById('users-table-body');
            const userHistoryModal = document.getElementById('user-history-modal');
            const userHistoryTitle = document.getElementById('user-history-title');
            const userHistoryTableBody = document.getElementById('user-history-table-body');
            const userHistoryCloseBtn = document.getElementById('user-history-close-btn');

            const cashoutMessageModal = document.getElementById('cashout-message-modal');
            const cashoutMessageCloseBtn = document.getElementById('cashout-message-close-btn');
            const cashoutMessageText = document.getElementById('cashout-message-text');
            
            let videos = [];
            let currentUser = null;
            let userData = null;
            let videoCardToAnimate = null;

            const adminEmail = 'mr.ping2025@gmail.com';
            
            // Utility function to extract YouTube video ID from a URL
            function getYouTubeId(url) {
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname.includes('youtube.com')) {
                        return urlObj.searchParams.get('v');
                    } else if (urlObj.hostname.includes('youtu.be')) {
                        return urlObj.pathname.substring(1);
                    }
                } catch (e) {
                    console.error("Invalid URL:", url);
                }
                return null;
            }

            // Function to get a YouTube thumbnail
            function getYouTubeThumbnail(videoId) {
                if (videoId) {
                    return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }
                return 'https://placehold.co/400x225/1f3148/ffffff?text=Video';
            }
            
            // Utility function to convert seconds to MM:SS format
            function formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const formattedSeconds = remainingSeconds < 10 ? `0${remainingSeconds}` : remainingSeconds;
                return `${minutes}:${formattedSeconds}`;
            }

            async function seedInitialData(user) {
                try {
                    if (!user) {
                         console.log("No authenticated user to seed data for. Skipping user seed.");
                         return;
                    }
                    const userId = user.uid;
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const userDocSnap = await getDoc(userDocRef);
                    if (!userDocSnap.exists()) {
                         let userRole = 'user';
                         let userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ping User');
                         if (user.email === adminEmail) {
                             userRole = 'admin';
                             userName = 'Mr. Ping';
                         }
                         await setDoc(userDocRef, {
                            name: userName,
                            email: user.email || '',
                            role: userRole,
                            points: 0,
                            pointsHistory: [],
                            payoutHistory: [] // Add payout history field for tracking
                         });
                         console.log("Seeding initial user data.");
                    }

                    if (user.email === adminEmail) {
                        const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                        const videosSnapshot = await getDocs(videosCollectionRef);
                        if (videosSnapshot.empty) {
                            const initialVideos = [
                                { id: 'vid1', title: "The Beauty of Nature", category: "Nature", points: 12, watchDuration: 10, duration: 90, description: "A breathtaking journey through mountains and forests.", videoUrl: "https://www.youtube.com/embed/g2J03u13kXg" },
                                { id: 'vid2', title: "Learn React in 30 Seconds", category: "Education", points: 25, watchDuration: 15, duration: 150, description: "A quick overview of React hooks.", videoUrl: "https://www.youtube.com/embed/Ke90Tje7VS0" },
                                { id: 'vid3', title: "City Life at Night", category: "Travel", points: 75, watchDuration: 20, duration: 120, description: "Explore the vibrant life of a metropolis after dark.", videoUrl: "https://www.youtube.com/embed/5a-H_gqM_9E" },
                                { id: 'vid4', title: "Cooking a Perfect Steak", category: "Food", points: 60, watchDuration: 10, duration: 250, description: "A step by step guide to cooking steak.", videoUrl: "https://www.youtube.com/embed/H0d82C7YjA8" },
                                { id: 'vid5', title: "Gaming Highlights of the Week", category: "Gaming", points: 40, watchDuration: 10, duration: 80, description: "The best moments in esports.", videoUrl: "https://www.youtube.com/embed/d-Yq36_9tQ0" },
                                { id: 'vid6', title: "Calming Rain and Piano", category: "Nature", points: 30, watchDuration: 15, duration: 520, description: "Relaxing piano music with rain sounds.", videoUrl: "https://www.youtube.com/embed/Ke90Tje7VS0" }
                            ];
                            for (const video of initialVideos) {
                                await setDoc(doc(videosCollectionRef, video.id), {
                                    title: video.title,
                                    category: video.category,
                                    points: video.points,
                                    watchDuration: video.watchDuration,
                                    duration: video.duration,
                                    description: video.description,
                                    videoUrl: video.videoUrl
                                });
                            }
                            console.log("Seeding initial video data.");
                        }
                    }
                } catch (error) {
                    console.error("Error seeding data: ", error);
                }
            }

            async function fetchUserData(uid) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}`);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        currentUser = {
                            name: userData.name,
                            email: userData.email,
                            role: userData.role
                        };
                        updateUI(currentUser.role);
                        console.log("User data updated:", userData);
                    } else {
                        console.log("User data not found for a logged-in user. This should not happen if `seedInitialData` ran correctly.");
                        hideLoading();
                    }
                }, (error) => {
                    console.error("Error listening to user data:", error);
                    hideLoading();
                });
            }

            async function fetchVideos() {
                showLoading();
                try {
                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    const q = query(videosCollectionRef);
                    const querySnapshot = await getDocs(q);
                    videos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Videos fetched from Firestore:", videos);
                } catch (e) {
                    console.error("Error fetching videos:", e);
                } finally {
                    hideLoading();
                }
            }
            
            async function fetchAllUsers() {
                showLoading();
                if (!usersTableBody) return;
                usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400 py-4">Fetching users...</td></tr>`;
                try {
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    const querySnapshot = await getDocs(usersCollectionRef);
                    const users = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsersTable(users);
                } catch (e) {
                    console.error("Error fetching users:", e);
                    usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-4">Error fetching users.</td></tr>`;
                } finally {
                    hideLoading();
                }
            }
            
            async function toggleUserRole(targetUserId, currentRole) {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${targetUserId}`);
                const newRole = currentRole === 'admin' ? 'user' : 'admin';
                try {
                    await updateDoc(userDocRef, { role: newRole });
                    console.log(`User role updated to ${newRole}`);
                } catch (e) {
                    console.error("Error updating user role:", e);
                }
            }

            async function updatePointsInFirestore(pointsToAdd, description) {
                if (!userData || !userId) return;
                showLoading();
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                    const newPoints = userData.points + pointsToAdd;
                    const newHistory = [...(userData.pointsHistory || []), {
                        date: new Date().toLocaleDateString(),
                        description: description,
                        points: pointsToAdd
                    }];

                    await updateDoc(userDocRef, {
                        points: newPoints,
                        pointsHistory: newHistory
                    });
                    console.log("Points and history updated in Firestore.");
                } catch (e) {
                    console.error("Error updating points:", e);
                } finally {
                    hideLoading();
                }
            }
            
            async function saveVideo(videoData, videoId = null) {
                showLoading();
                try {
                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    if (videoId) {
                        const videoDocRef = doc(db, videosCollectionRef.path, videoId);
                        await setDoc(videoDocRef, videoData, { merge: true });
                        console.log("Video updated:", videoId);
                    } else {
                        await addDoc(videosCollectionRef, videoData);
                        console.log("Video added successfully.");
                    }
                } catch (e) {
                    console.error("Error saving video:", e);
                } finally {
                    hideLoading();
                }
                await fetchVideos(); 
                renderManageVideosTable();
                const activeFilterBtn = document.querySelector('.filter-btn.active');
                if (activeFilterBtn) {
                   renderVideoGrid(activeFilterBtn.getAttribute('data-category'));
                } else {
                   renderVideoGrid('all');
                }
            }

            async function deleteVideo(videoId) {
                showLoading();
                try {
                    const videoDocRef = doc(db, `/artifacts/${appId}/public/data/videos`, videoId);
                    await deleteDoc(videoDocRef);
                    console.log("Video deleted:", videoId);
                } catch (e) {
                    console.error("Error deleting video:", e);
                } finally {
                    hideLoading();
                }
                await fetchVideos();
                renderManageVideosTable();
                const activeFilterBtn = document.querySelector('.filter-btn.active');
                if (activeFilterBtn) {
                     renderVideoGrid(activeFilterBtn.getAttribute('data-category'));
                } else {
                    renderVideoGrid('all');
                }
            }

            function showLoading() {
                if (loadingOverlay) loadingOverlay.style.display = 'flex';
            }

            function hideLoading() {
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
            
            async function fetchAdminDashboardData() {
                showLoading();
                try {
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/users`);
                    onSnapshot(usersCollectionRef, (usersSnapshot) => {
                        const totalUsers = usersSnapshot.docs.length;
                        let totalPointsEarned = 0;
                        let totalPayouts = 0;
                        usersSnapshot.forEach(doc => {
                            const userData = doc.data();
                            const userPoints = userData.points || 0;
                            totalPointsEarned += userPoints;
                            
                            const payoutHistory = userData.payoutHistory || [];
                            payoutHistory.forEach(payout => {
                                totalPayouts += payout.amount || 0;
                            });
                        });
                        
                        if (adminTotalUsersValue) adminTotalUsersValue.textContent = totalUsers;
                        if (adminTotalPointsEarnedValue) adminTotalPointsEarnedValue.textContent = totalPointsEarned;
                        if (adminTotalPayoutsValue) adminTotalPayoutsValue.textContent = `$${totalPayouts.toFixed(2)}`;
                    }, (error) => {
                        console.error("Error fetching admin users data:", error);
                    });

                    const videosCollectionRef = collection(db, `/artifacts/${appId}/public/data/videos`);
                    onSnapshot(videosCollectionRef, (videosSnapshot) => {
                        const totalVideos = videosSnapshot.docs.length;
                        if (adminTotalVideosValue) adminTotalVideosValue.textContent = totalVideos;
                    }, (error) => {
                        console.error("Error fetching admin videos data:", error);
                    });
                } catch (e) {
                    console.error("Admin dashboard data fetch error:", e);
                } finally {
                    hideLoading();
                }
            }
            
            function updateUI(role) {
                if (!isAuthReady || !currentUser) return;
                
                views.forEach(view => { if(view) view.style.display = 'none'; });
                if (loginPage) loginPage.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';
                if (sidebar) sidebar.classList.remove('open');
                if (document.body) document.body.classList.remove('sidebar-open');

                if (role === 'user') {
                    document.querySelectorAll('.admin-link').forEach(link => { if (link) link.style.display = 'none'; });
                    document.querySelectorAll('.user-link').forEach(link => { if (link) link.style.display = 'flex'; });
                    if (headerMeta) headerMeta.innerHTML = getUserHeaderHTML();
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML();
                    if (welcomeMessage) welcomeMessage.textContent = `Welcome back, ${currentUser.name}!`;
                    showView('user-dashboard-view');
                    updatePointsDisplay();
                    renderPointsHistoryTable();
                    fetchVideos().then(() => renderVideoGrid('all'));
                } else if (role === 'admin') {
                    document.querySelectorAll('.user-link').forEach(link => { if (link) link.style.display = 'none'; });
                    document.querySelectorAll('.admin-link').forEach(link => { if (link) link.style.display = 'flex'; });
                    if (headerMeta) headerMeta.innerHTML = getAdminHeaderHTML();
                    if (sidebarProfile) sidebarProfile.innerHTML = getUserProfileHTML();
                    showView('admin-dashboard-view');
                    fetchVideos().then(renderManageVideosTable);
                    fetchAdminDashboardData();
                }
                attachLogoutListeners(); 
            }
            
            function getUserProfileHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                const roleText = currentUser?.role === 'admin' ? 'ADMINISTRATOR' : currentUser?.email || 'N/A';
                return `
                    <div class="user-profile flex items-center p-4 rounded-xl bg-[#3b4b6b] mt-4">
                        <img src="https://placehold.co/40x40/9b59b6/ffffff?text=${profileText}" alt="${nameText}" class="w-10 h-10 rounded-full mr-4">
                        <div class="user-info">
                            <div class="font-semibold text-white">${nameText}</div>
                            <div class="text-sm text-gray-400">${roleText}</div>
                        </div>
                    </div>
                `;
            }
            
            function getUserHeaderHTML() {
                const nameText = currentUser?.name || 'Unknown';
                const profileText = nameText.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                const roleText = currentUser?.role || 'user';
                return `
                    <div class="user-meta hidden md:flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                           <span id="user-points-display" class="font-bold text-lg text-yellow-400">${(userData?.points || 0).toLocaleString()} PTS</span>
                           <span class="text-sm text-gray-400">$${(userData?.points / 5000).toFixed(2)}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-300 mr-2">${nameText}</span>
                            <img src="https://placehold.co/32x32/9b59b6/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full">
                        </div>
                        <button class="logout-btn text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                `;
            }
            
            function getAdminHeaderHTML() {
                 const nameText = currentUser?.name || 'Unknown';
                 const profileText = nameText.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
                 return `
                    <div class="admin-meta hidden md:flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                           <span class="font-bold text-lg text-yellow-400" id="admin-points-display">0 PTS</span>
                           <span class="text-sm text-gray-400" id="admin-earnings-display">$0.00</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-300 mr-2">${nameText}</span>
                            <span class="text-sm text-gray-500 mr-2">Admin</span>
                            <img src="https://placehold.co/32x32/9b59b6/ffffff?text=${profileText}" alt="${nameText}" class="w-8 h-8 rounded-full">
                        </div>
                        <button class="logout-btn text-gray-400 hover:text-white transition">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                 `;
            }

            function attachLogoutListeners() {
                const logoutButtons = document.querySelectorAll('.logout-btn');
                logoutButtons.forEach(btn => {
                    btn.removeEventListener('click', handleLogout);
                    btn.addEventListener('click', handleLogout);
                });
            }

            async function handleLogout() {
                try {
                    await signOut(auth);
                    if (loginPage) loginPage.style.display = 'flex';
                    if (appContainer) appContainer.style.display = 'none';
                    currentUser = null;
                    userData = null;
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }

            function showView(targetId) {
                views.forEach(view => { if(view) view.style.display = 'none'; });
                const targetView = document.getElementById(targetId);
                if (targetView) {
                    targetView.style.display = 'block';
                    updatePageTitle(targetId);
                    navLinks.forEach(nav => {
                        if (nav) nav.classList.remove('active');
                    });
                    const activeLink = document.querySelector(`a[data-target="${targetId}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                }
            }

            function updatePageTitle(viewId) {
                const titleElement = document.getElementById('page-title');
                if (!titleElement) return;

                const menuToggle = `<button id="menu-toggle" class="md:hidden mr-4 text-white"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>`;
                let titleText = 'Ping Rewards';

                switch (viewId) {
                    case 'user-dashboard-view': titleText = 'Dashboard'; break;
                    case 'watch-videos-view': titleText = 'Watch Videos'; break;
                    case 'points-history-view': titleText = 'Points History'; break;
                    case 'admin-dashboard-view': titleText = 'Admin Dashboard'; break;
                    case 'manage-videos-view': titleText = 'Manage Videos'; break;
                    case 'manage-users-view': titleText = 'Manage Users'; break;
                    case 'video-player-view': titleText = 'Video'; break;
                }
                titleElement.innerHTML = `${menuToggle} ${titleText}`;
                
                const toggleBtn = document.getElementById('menu-toggle');
                if (toggleBtn) {
                     toggleBtn.addEventListener('click', () => {
                        if (sidebar) sidebar.classList.toggle('open');
                        if (document.body) document.body.classList.remove('sidebar-open');
                     });
                }
            }
            
            function generateRandomChartData() {
                const bars = document.querySelectorAll('.bar-chart .bar');
                bars.forEach(bar => {
                    const randomHeight = Math.floor(Math.random() * 90) + 10;
                    bar.style.height = `${randomHeight}%`;
                });
            }

            function renderVideoGrid(category, searchQuery = '') {
                const videoGrid = document.getElementById('video-grid');
                if (!videoGrid) {
                    console.error("Video grid element not found.");
                    return;
                }
                videoGrid.innerHTML = '';

                // Get IDs of videos the user has watched
                const watchedVideoTitles = new Set((userData?.pointsHistory || [])
                    .filter(h => h.description.includes('Watched'))
                    .map(h => h.description.match(/"(.*?)"/)?.[1] || h.description.split(' ').pop()));

                // Filter and sort videos
                let filteredVideos = videos;
                if (category !== 'all') {
                    filteredVideos = filteredVideos.filter(video => video.category === category);
                }

                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filteredVideos = filteredVideos.filter(video => 
                        video.title.toLowerCase().includes(query) || 
                        video.description.toLowerCase().includes(query)
                    );
                }
                
                // Separate watched and unwatched videos
                const unwatchedVideos = filteredVideos.filter(video => !watchedVideoTitles.has(video.title));
                const watchedVideos = filteredVideos.filter(video => watchedVideoTitles.has(video.title));
                
                // Concatenate unwatched videos first, then watched videos
                const orderedVideos = [...unwatchedVideos, ...watchedVideos];

                if (orderedVideos.length === 0) {
                     videoGrid.innerHTML = `<p class="text-center text-gray-400 col-span-full">No videos found.</p>`;
                     return;
                }

                orderedVideos.forEach(video => {
                    const youtubeId = getYouTubeId(video.videoUrl);
                    const thumbnailUrl = getYouTubeThumbnail(youtubeId);

                    const videoCardHtml = `
                        <div class="video-card card rounded-xl overflow-hidden shadow-lg cursor-pointer transform hover:scale-105 transition-transform duration-300" data-category="${video.category}" data-video-url="${video.videoUrl}" data-video-id="${video.id}">
                            <div class="relative w-full h-40 overflow-hidden">
                                <img src="${thumbnailUrl}" alt="${video.title}" onerror="this.onerror=null; this.src='https://placehold.co/400x225/1f3148/ffffff?text=Video';" class="w-full h-full object-cover transition-transform duration-300">
                                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 opacity-0 hover:opacity-100 transition-opacity duration-300">
                                    <div class="w-16 h-16 rounded-full bg-white bg-opacity-20 backdrop-blur-sm flex items-center justify-center border-2 border-white/50">
                                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9z"/></svg>
                                    </div>
                                </div>
                                <span class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-full font-semibold">${formatDuration(video.duration)}</span>
                                <span class="absolute top-2 right-2 gradient-bg text-white text-xs px-3 py-1 rounded-full font-semibold">${video.points} PTS</span>
                            </div>
                            <div class="p-4">
                                <div class="text-sm font-semibold text-gray-400 uppercase">${video.category}</div>
                                <h3 class="text-lg font-semibold text-white mt-1 mb-2">${video.title}</h3>
                                <p class="text-sm text-gray-500 line-clamp-2">${video.description}</p>
                            </div>
                        </div>
                    `;
                    videoGrid.innerHTML += videoCardHtml;
                });
                attachVideoCardListeners();
            }
            
            function renderUsersTable(users) {
                if (!usersTableBody) return;
                usersTableBody.innerHTML = '';
                if (users.length === 0) {
                     usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400 py-4">No users found.</td></tr>`;
                     return;
                }
                
                users.forEach(user => {
                    const toggleRoleBtnText = user.role === 'admin' ? 'Demote to User' : 'Promote to Admin';
                    const tableRowHtml = `
                        <tr class="hover:bg-gray-700 transition" data-user-id="${user.id}">
                            <td class="p-4">${user.id.substring(0, 8)}...</td>
                            <td class="p-4">${user.name || 'N/A'}</td>
                            <td class="p-4">${user.email || 'N/A'}</td>
                            <td class="p-4">${user.role}</td>
                            <td class="p-4">${user.points || 0}</td>
                            <td class="p-4 space-x-2">
                                <button class="bg-green-500 text-white text-sm px-4 py-2 rounded-lg mr-2 hover:bg-green-600 transition view-history-btn" data-user-id="${user.id}">View History</button>
                                ${user.id !== userId ? `<button class="bg-purple-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-purple-600 transition toggle-role-btn" data-user-id="${user.id}" data-current-role="${user.role}">${toggleRoleBtnText}</button>` : ''}
                            </td>
                        </tr>
                    `;
                    usersTableBody.innerHTML += tableRowHtml;
                });
                attachManageUsersListeners(users);
            }

            function renderManageVideosTable() {
                if (!videoTableBody) {
                    console.error("Video table body element not found.");
                    return;
                }
                videoTableBody.innerHTML = '';
                videos.forEach(video => {
                    const tableRowHtml = `
                        <tr class="hover:bg-gray-700 transition" data-video-id="${video.id}">
                            <td class="p-4">${video.title}</td>
                            <td class="p-4">${video.category}</td>
                            <td class="p-4">${video.points}</td>
                            <td class="p-4 space-x-2">
                                <button class="bg-blue-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-600 transition edit-btn" data-video-id="${video.id}">Edit</button>
                                <button class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600 transition delete-btn" data-video-id="${video.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    videoTableBody.innerHTML += tableRowHtml;
                });
                attachManageVideosListeners();
            }
            
            function renderPointsHistoryTable() {
                if (!pointsHistoryTableBody) {
                    console.error("Points history table body element not found.");
                    return;
                }
                pointsHistoryTableBody.innerHTML = '';
                if (!userData || !userData.pointsHistory || userData.pointsHistory.length === 0) {
                     pointsHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-4">No history yet. Watch videos to earn points!</td></tr>`;
                     return;
                }
                const history = userData.pointsHistory;
                history.forEach(item => {
                    const tableRowHtml = `
                        <tr class="hover:bg-gray-700 transition">
                            <td class="p-4">${item.date}</td>
                            <td class="p-4">
                                <svg class="w-4 h-4 inline-block mr-1 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5l-5-5 1.41-1.41L10 13.67l7.59-7.59L19 7l-9 9.5z"/></svg>
                                ${item.description}
                            </td>
                            <td class="p-4 text-green-400 font-semibold">+${item.points}</td>
                        </tr>
                    `;
                    pointsHistoryTableBody.innerHTML += tableRowHtml;
                });
            }

            function updatePointsDisplay() {
                if (!userData) return;
                const totalPointsValue = document.getElementById('total-points-value');
                const estimatedEarningsValue = document.getElementById('estimated-earnings-value');
                const videosWatchedValue = document.getElementById('videos-watched-value');
                const userPointsDisplay = document.getElementById('user-points-display');
                const cashoutBtn = document.getElementById('cashout-button');

                if (totalPointsValue) totalPointsValue.textContent = userData.points.toLocaleString();
                if (estimatedEarningsValue) estimatedEarningsValue.textContent = `$${(userData.points / 5000).toFixed(2)}`;
                if (videosWatchedValue) videosWatchedValue.textContent = (userData.pointsHistory || []).filter(h => h.description.includes('Watched')).length;
                if (userPointsDisplay) userPointsDisplay.textContent = `${userData.points.toLocaleString()} PTS`;

                if (cashoutBtn) {
                     cashoutBtn.disabled = userData.points <= 0;
                }
            }

            function animateCoins(startElement, endElement, points) {
                const numberOfCoins = Math.min(points, 10);
                const startRect = startElement.getBoundingClientRect();
                const endRect = endElement.getBoundingClientRect();
                
                for (let i = 0; i < numberOfCoins; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'absolute w-4 h-4 rounded-full bg-yellow-400 transition-all duration-1000 ease-in-out z-50';
                    document.body.appendChild(coin);

                    coin.style.left = `${startRect.left + (startRect.width / 2) - 8}px`;
                    coin.style.top = `${startRect.top + (startRect.height / 2) - 8}px`;

                    setTimeout(() => {
                        coin.style.left = `${endRect.left + (endRect.width / 2) - 8}px`;
                        coin.style.top = `${endRect.top + (endRect.height / 2) - 8}px`;
                        coin.style.opacity = '0';
                        coin.style.transform = 'scale(0.5)';
                    }, 50 + i * 20);

                    setTimeout(() => {
                        coin.remove();
                    }, 1100 + i * 20);
                }
            }

            function attachVideoCardListeners() {
                const cards = document.querySelectorAll('.video-card');
                cards.forEach(card => {
                    card.removeEventListener('click', handleVideoCardClick);
                    card.addEventListener('click', handleVideoCardClick);
                });
            }

            async function handleVideoCardClick(e) {
                const card = e.currentTarget;
                const videoId = card.getAttribute('data-video-id');
                const video = videos.find(v => v.id === videoId);
                
                if (video) {
                    videoCardToAnimate = card;
                    if (videoIframe) videoIframe.src = video.videoUrl;
                    if (videoPlayerTitle) videoPlayerTitle.textContent = video.title;
                    if (videoPlayerDescription) videoPlayerDescription.textContent = video.description;
                    showView('video-player-view');
                    if (summaryOutput) summaryOutput.innerHTML = '';
                    
                    clearTimeout(window.videoWatchTimer);
                    window.pointsEarnedInSession = false;
                    window.videoWatchTimer = setTimeout(() => {
                        window.pointsEarnedInSession = true;
                        console.log(`Watch duration met. Click 'Back to Videos' to earn points.`);
                        window.currentWatchedVideoId = video.id;
                    }, video.watchDuration * 1000);
                }
            }

            if(videoPlayerBackBtn) {
                videoPlayerBackBtn.removeEventListener('click', handleVideoBack);
                videoPlayerBackBtn.addEventListener('click', handleVideoBack);
            }
            
            async function handleVideoBack() {
                clearTimeout(window.videoWatchTimer);
                if (videoIframe) videoIframe.src = '';
                if (window.pointsEarnedInSession) {
                    if (videoCardToAnimate) {
                        const videoId = videoCardToAnimate.getAttribute('data-video-id');
                        const video = videos.find(v => v.id === videoId);
                        if (video) {
                            const endElement = document.getElementById('user-points-display');
                            animateCoins(videoCardToAnimate, endElement, video.points);
                            setTimeout(async () => {
                                await updatePointsInFirestore(video.points, `Watched "${video.title}"`);
                            }, 1000);
                        }
                    } else {
                        const videoId = window.currentWatchedVideoId;
                        const video = videos.find(v => v.id === videoId);
                        if(video) await updatePointsInFirestore(video.points, `Watched "${video.title}"`);
                    }
                    console.log("Points updated via Firebase.");
                } else {
                    console.log(`You did not watch the video for the required duration. No points were awarded.`);
                }
                showView('watch-videos-view');
            }

            function showDeleteModal(videoId) {
                if (deleteConfirmModal) {
                    deleteConfirmModal.style.display = 'flex';
                    const newConfirmBtn = deleteConfirmBtn.cloneNode(true);
                    deleteConfirmBtn.parentNode.replaceChild(newConfirmBtn, deleteConfirmBtn);
                    newConfirmBtn.addEventListener('click', async () => {
                        deleteConfirmModal.style.display = 'none';
                        await deleteVideo(videoId);
                    });
                    deleteCancelBtn.removeEventListener('click', () => { deleteConfirmModal.style.display = 'none'; });
                    deleteCancelBtn.addEventListener('click', () => { deleteConfirmModal.style.display = 'none'; });
                }
            }

            function attachManageVideosListeners() {
                const editBtns = document.querySelectorAll('.edit-btn');
                editBtns.forEach(btn => {
                    btn.removeEventListener('click', handleEditVideo);
                    btn.addEventListener('click', handleEditVideo);
                });

                const deleteBtns = document.querySelectorAll('.delete-btn');
                deleteBtns.forEach(btn => {
                    btn.removeEventListener('click', handleDeleteVideo);
                    btn.addEventListener('click', handleDeleteVideo);
                });
            }
            
            async function handleEditVideo(e) {
                e.preventDefault();
                const videoId = e.currentTarget.getAttribute('data-video-id');
                const videoToEdit = videos.find(v => v.id === videoId);
                if (videoToEdit) {
                    if (addModalTitle) addModalTitle.textContent = "Edit Video";
                    document.getElementById('video-title').value = videoToEdit.title;
                    document.getElementById('video-description').value = videoToEdit.description;
                    document.getElementById('video-category').value = videoToEdit.category;
                    document.getElementById('video-url').value = videoToEdit.videoUrl;
                    document.getElementById('video-points').value = videoToEdit.points;
                    document.getElementById('watch-duration').value = videoToEdit.watchDuration;
                    addVideoModal.style.display = 'flex';
                    addVideoForm.setAttribute('data-editing-id', videoId);
                }
            }

            function handleDeleteVideo(e) {
                e.preventDefault();
                const videoId = e.currentTarget.getAttribute('data-video-id');
                showDeleteModal(videoId);
            }
            
            function attachManageUsersListeners(users) {
                const viewHistoryBtns = document.querySelectorAll('.view-history-btn');
                viewHistoryBtns.forEach(btn => {
                    btn.removeEventListener('click', handleViewHistory);
                    btn.addEventListener('click', handleViewHistory);
                });
                
                if (userHistoryCloseBtn) {
                     userHistoryCloseBtn.removeEventListener('click', () => { if(userHistoryModal) userHistoryModal.style.display = 'none'; });
                     userHistoryCloseBtn.addEventListener('click', () => { if(userHistoryModal) userHistoryModal.style.display = 'none'; });
                }
                
                const toggleRoleBtns = document.querySelectorAll('.toggle-role-btn');
                toggleRoleBtns.forEach(btn => {
                     btn.removeEventListener('click', handleToggleRole);
                     btn.addEventListener('click', handleToggleRole);
                });
            }

            async function handleViewHistory(e) {
                const userId = e.currentTarget.getAttribute('data-user-id');
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                const userDocSnap = await getDoc(userDocRef);
                const user = userDocSnap.data();

                if (user && userHistoryModal && userHistoryTitle && userHistoryTableBody) {
                     userHistoryTitle.textContent = `${user.name || 'User'}'s Points History`;
                     userHistoryTableBody.innerHTML = '';
                     
                     if (user.pointsHistory && user.pointsHistory.length > 0) {
                         user.pointsHistory.forEach(item => {
                              const row = document.createElement('tr');
                              row.className = "hover:bg-gray-700 transition";
                              row.innerHTML = `<td class="p-4">${item.date}</td><td class="p-4">${item.description}</td><td class="p-4 text-green-400 font-semibold">${item.points}</td>`;
                              userHistoryTableBody.appendChild(row);
                         });
                     } else {
                          userHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-4">No history found.</td></tr>`;
                     }
                     userHistoryModal.style.display = 'flex';
                }
            }

            async function handleToggleRole(e) {
                 const targetUserId = e.currentTarget.getAttribute('data-user-id');
                 const currentRole = e.currentTarget.getAttribute('data-current-role');
                 await toggleUserRole(targetUserId, currentRole);
            }

            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    showLoading();
                    const provider = new GoogleAuthProvider();
                    try {
                        const result = await signInWithPopup(auth, provider);
                        if (result.user) {
                           console.log("User signed in with Google successfully.");
                        }
                    } catch (error) {
                        console.error("Google Sign-in failed:", error);
                        if (loginMessage) {
                            loginMessage.textContent = 'Google Sign-in failed. Please check your Authorized domains.';
                            loginMessage.style.display = 'block';
                        }
                        hideLoading();
                    }
                });
            }
            
            if (getSummaryBtn) {
                getSummaryBtn.addEventListener('click', async () => {
                    const currentVideo = videos.find(v => v.id === window.currentWatchedVideoId);
                    if (!currentVideo) {
                        if (summaryOutput) summaryOutput.innerHTML = "Video not found.";
                        return;
                    }
                    if (summaryOutput) summaryOutput.innerHTML = `<p class="text-gray-400">Getting summary...</p>`;

                    try {
                        const prompt = `Video Title: "${currentVideo.title}". Description: "${currentVideo.description}". Provide a summary of this video.`;
                        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const summaryText = result.candidates[0].content.parts[0].text;
                            if (summaryOutput) summaryOutput.innerHTML = `<h3 class="text-lg font-semibold text-white mb-2">Summary</h3><p class="text-gray-400">${summaryText}</p>`;
                        } else {
                            if (summaryOutput) summaryOutput.innerHTML = "Summary not available.";
                        }
                    } catch (error) {
                        console.error("Gemini API Error:", error);
                        if (summaryOutput) summaryOutput.innerHTML = "Error getting summary.";
                    }
                });
            }

            if (menuToggleBtn) {
                menuToggleBtn.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.toggle('open');
                    if (document.body) document.body.classList.remove('sidebar-open');
                });
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    showView(targetId);
                    if (sidebar) sidebar.classList.remove('open');
                    if (document.body) document.body.classList.remove('sidebar-open');
                    if (targetId === 'watch-videos-view') {
                        renderVideoGrid('all');
                    } else if (targetId === 'manage-videos-view') {
                        renderManageVideosTable();
                    } else if (targetId === 'manage-users-view') {
                        fetchAllUsers();
                    } else if (targetId === 'points-history-view') {
                        renderPointsHistoryTable();
                    }
                });
            });
            
            if (backdrop) {
                backdrop.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.remove('open');
                    if (document.body) document.body.classList.remove('sidebar-open');
                });
            }

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => { if(b) b.classList.remove('active'); });
                    btn.classList.add('active');
                    const category = btn.getAttribute('data-category');
                    renderVideoGrid(category);
                });
            });

            if(searchBar) {
                searchBar.addEventListener('input', () => {
                     const activeFilterBtn = document.querySelector('.filter-btn.active');
                     const category = activeFilterBtn ? activeFilterBtn.getAttribute('data-category') : 'all';
                     renderVideoGrid(category, searchBar.value);
                });
            }

            if (addVideoBtn) {
                addVideoBtn.addEventListener('click', () => {
                    if (addModalTitle) addModalTitle.textContent = "Add New Video";
                    if (addVideoForm) addVideoForm.reset();
                    if (addVideoForm) addVideoForm.removeAttribute('data-editing-id');
                    if (addVideoModal) addVideoModal.style.display = 'flex';
                });
            }

            if (addVideoModalCancelBtn) {
                addVideoModalCancelBtn.addEventListener('click', () => {
                    if (addVideoModal) addVideoModal.style.display = 'none';
                });
            }

            if (addVideoForm) {
                addVideoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(addVideoForm);
                    const videoData = {
                        title: formData.get('videoTitle'),
                        description: formData.get('videoDescription'),
                        category: formData.get('videoCategory'),
                        videoUrl: formData.get('videoUrl'),
                        points: parseInt(formData.get('videoPoints')),
                        watchDuration: parseInt(formData.get('watchDuration'))
                    };
                    
                    const editingId = addVideoForm.getAttribute('data-editing-id');
                    await saveVideo(videoData, editingId);
                    
                    if (addVideoModal) addVideoModal.style.display = 'none';
                });
            }
            
            if (cashoutBtn) {
                cashoutBtn.addEventListener('click', () => {
                    if (!userData || userData.points < 5000) {
                        if (cashoutMessageModal) {
                            cashoutMessageText.textContent = `You need 5000 points to cash out. Your current points are ${userData?.points || 0}.`;
                            cashoutMessageModal.style.display = 'flex';
                        }
                    } else {
                        if (cashoutModal) cashoutModal.style.display = 'flex';
                        if (userData) {
                            const payoutAmount = (userData.points / 5000).toFixed(2);
                            const payoutInput = document.getElementById('payout-amount');
                            if (payoutInput) payoutInput.value = payoutAmount;
                        }
                    }
                });
            }
            
            if(cashoutMessageCloseBtn) {
                cashoutMessageCloseBtn.addEventListener('click', () => {
                     if (cashoutMessageModal) cashoutMessageModal.style.display = 'none';
                });
            }

            if (cashoutCancelBtn) {
                cashoutCancelBtn.addEventListener('click', () => {
                    if (cashoutModal) cashoutModal.style.display = 'none';
                });
            }
            
            if (cashoutForm) {
                cashoutForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const channelUrl = "https://t.me/MMMMOline";
                    
                    if (!userData || userData.points <= 0) {
                        if (cashoutModal) cashoutModal.style.display = 'none';
                        window.open(channelUrl, '_blank');
                        return;
                    }
                    showLoading();
                    try {
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                        const pointsCashedOut = userData.points;
                        const payoutAmount = (pointsCashedOut / 5000).toFixed(2);
                        const newHistoryEntry = {
                            date: new Date().toLocaleDateString(),
                            description: `Cashed out ${pointsCashedOut} points`,
                            points: -pointsCashedOut
                        };
                        const newPayoutEntry = {
                             date: new Date().toLocaleDateString(),
                             amount: parseFloat(payoutAmount)
                        };

                        await updateDoc(userDocRef, {
                            points: 0,
                            pointsHistory: [...(userData.pointsHistory || []), newHistoryEntry],
                            payoutHistory: [...(userData.payoutHistory || []), newPayoutEntry]
                        });

                        console.log('Cash out request submitted and points reset.');
                        if (cashoutModal) cashoutModal.style.display = 'none';
                        window.open(channelUrl, '_blank');
                    } catch (error) {
                        console.error("Error during cash out:", error);
                        window.open(channelUrl, '_blank');
                    } finally {
                        hideLoading();
                    }
                });
            }
            
            generateRandomChartData();
            showLoading();
            
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    if (user.isAnonymous) {
                         const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                         if (initialAuthToken) {
                             try {
                                  await signInWithCustomToken(auth, initialAuthToken);
                             } catch(e) {
                                  console.error("Error signing in with custom token:", e);
                                  if (loginPage) loginPage.style.display = 'flex';
                                  if (appContainer) appContainer.style.display = 'none';
                                  hideLoading();
                             }
                         } else {
                              if (loginPage) loginPage.style.display = 'flex';
                              if (appContainer) appContainer.style.display = 'none';
                              hideLoading();
                         }
                    } else {
                         userId = user.uid;
                         await seedInitialData(user);
                         await fetchUserData(userId);
                    }
                } else {
                    console.log("No user is signed in. Showing login page.");
                    if (loginPage) loginPage.style.display = 'flex';
                    if (appContainer) appContainer.style.display = 'none';
                    hideLoading();
                }
            });

            if (typeof __initial_auth_token === 'undefined') {
                 signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>
